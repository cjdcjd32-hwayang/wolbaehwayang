<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --card-bg: rgba(255,255,255,.92);
      --border: rgba(0,0,0,.10);
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }

    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.35rem;
      font-weight:900;
    }

    nav{
      display:flex;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      gap:6px;
      flex-wrap:wrap;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
    }
    nav button{
      border:none;
      background:none;
      font-size:1rem;
      cursor:pointer;
      padding:8px 12px;
      border-radius:12px;
      touch-action: manipulation;
    }
    nav button:hover{ background:rgba(0,0,0,.05); }

    section{display:none;padding:16px}
    section.active{display:block}

    .card{
      background:var(--card-bg);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
      border:1px solid var(--border);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
      touch-action: manipulation;
    }
    .btn.secondary{background:#444}
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-size:.9rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .mini-btn:hover{ opacity:.92; }

    select, input, textarea{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      background:#fff;
      font-size: 1rem;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .small{font-size:.9rem;opacity:.85}
    .hint{ display:none; font-size:.88rem; opacity:.85; margin-top:6px; }
    body.admin .hint{ display:block; }

    /* ===== Nickname layer ===== */
    #nicknameLayer{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:9999;
      padding:14px; box-sizing:border-box;
    }
    #nicknameLayer .card{ width:min(420px, 100%); }

    /* ===== Theme frames ===== */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }

    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }

    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* ===== Thermometer base ===== */
    .thermo-frame{
      width: 92px;
      height: 252px;
      position: relative;
      display:flex;
      align-items: flex-start;
      justify-content: center;
      box-sizing: border-box;
    }
    .tube{
      width: 60px;
      height: 192px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 2px solid rgba(0,0,0,.12);
      position: relative;
      z-index: 2;
      overflow:hidden;
      box-sizing: border-box;
      padding: 8px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }
    .tube-grid{
      width: 100%;
      height: 100%;
      display:grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.05);
      border-radius: 12px;
      padding: 2px;
      box-sizing: border-box;
    }
    .cell{
      background: rgba(255,255,255,.60);
      border-radius: 1px;
    }
    .bulb{
      width: 82px;
      height: 82px;
      border-radius: 999px;
      background: rgba(255,255,255,.90);
      border: 2px solid rgba(0,0,0,.12);
      position:absolute;
      bottom: 0;
      z-index: 1;
      overflow:hidden;
      box-sizing:border-box;
    }
    .bulb-fill{
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      opacity: 0;
      transform: scale(.92);
      transition: opacity .25s ease, transform .25s ease;
    }
    .bulb.filled .bulb-fill{
      opacity: 1;
      transform: scale(1);
    }
    /* Home bulb fill: themed color */
    .theme-blue .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(0,128,255,.45) 0%, rgba(0,128,255,.85) 60%, rgba(0,128,255,.95) 100%); }
    .theme-yellow .bulb-fill{ background: radial-gradient(circle at 30% 30%, rgba(255,193,7,.45) 0%, rgba(255,193,7,.85) 60%, rgba(255,193,7,.95) 100%); }
    .theme-pink .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(194,24,91,.35) 0%, rgba(194,24,91,.80) 60%, rgba(194,24,91,.95) 100%); }

    /* ===== Home compact thermos (4 per row) ===== */
    .home-thermo-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .home-thermo-item{
      background:#fff;
      border-radius:16px;
      padding:12px 10px;
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .home-thermo-item:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .home-branch-name{ font-weight:900; font-size:1rem; letter-spacing:-0.2px; }
    .home-temp{ font-weight:900; font-size:.92rem; opacity:.92; margin-top:-4px; }

    .thermo-mini .thermo-frame{ width: 88px; height: 234px; }
    .thermo-mini .tube{ width: 56px; height: 176px; padding: 7px; }
    .thermo-mini .bulb{ width: 76px; height: 76px; }

    @media (max-width: 980px){ .home-thermo-grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 720px){ .home-thermo-grid{ grid-template-columns: repeat(2, 1fr); } }

    /* ===== Chant detailed thermos (3 columns grouped) ===== */
    .thermo-grid-wrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .thermo-col{ display:flex; flex-direction:column; gap:12px; min-width:0; }
    .branch-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 92px;
      gap:10px;
      align-items:stretch;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .branch-thermo-card:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .branch-thermo-title{
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .branch-thermo-meta{
      font-size:.88rem;
      opacity:.86;
      line-height:1.35;
    }
    .recent-list{
      margin-top:8px;
      font-size:.82rem;
      opacity:.90;
      line-height:1.35;
    }
    .recent-item{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:2px 0;
    }

    /* ===== Schedule: plan list ===== */
    .plan-list{ display:grid; gap:10px; }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{ font-weight:900; margin-bottom:4px; }
    .plan-meta{ font-size:.86rem; opacity:.88; }

    /* ===== Schedule: month calendar (always grid, mobile-safe) ===== */
    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:900;
      text-align:center;
      opacity:.85;
      padding:4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:96px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.22;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .day-cell:hover{ box-shadow: var(--shadow); }
    .day-num{
      font-weight:900;
      font-size:.95rem;
      margin-bottom:4px;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align: top;
    }
    .meet-badge{ background:rgba(194,24,91,.10); }
    .act-badge{ background:rgba(0,128,255,.10); }
    .more-hint{
      display:block;
      font-size:.70rem;
      opacity:.78;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== School ===== */
    .school-wrap{ display:grid; gap:12px; }
    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      box-sizing:border-box;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .slot-num{ font-weight:900; font-size:.9rem; opacity:.8; }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.05rem;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: 40px;
      touch-action: manipulation;
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }
    .slot-input{
      width:100%;
      padding:12px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.95rem;
      background:#FFF6BF; /* fixed pale yellow */
    }

    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:800;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }

    .school-sched-list{ display:grid; gap:10px; }
    .school-sched-item{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      line-height:1.35;
    }
    .school-sched-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .school-sched-date{ font-weight:900; }

    /* ===== Modals ===== */
    .modal-layer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:9998;
      padding: 14px;
      box-sizing: border-box;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(0,0,0,.08);
      max-height: 86vh;
      overflow:auto;
    }
    .modal h3{ margin:0 0 10px 0; font-size:1.05rem; }
    .modal .grid{ display:grid; gap:10px; }
    .modal .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .modal .actions button{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-size:1rem;
      touch-action: manipulation;
    }
    .modal .actions .cancel{ background:#eee; }
    .modal .actions .ok{ background:#111; color:#fff; }

    .detail-block{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      background:#fff;
      line-height:1.4;
    }
    .detail-title{ font-weight:900; margin-bottom:6px; }

    /* ===== Responsive ===== */
    @media (max-width: 520px){
      header{ font-size:1.15rem; padding:14px; }
      section{ padding:12px; }
      .card{ padding:12px; margin-bottom:12px; }
      nav{ justify-content:flex-start; }
      nav button{ font-size:.95rem; padding:8px 10px; }

      .row{ grid-template-columns: 1fr; }
      .thermo-grid-wrap{ grid-template-columns: 1fr; } /* chant detailed thermos stack */

      #schoolGrid{ grid-template-columns: repeat(2, 1fr); }

      /* Mobile schedule: keep real calendar grid, but more compact */
      .month-calendar{ gap:4px; }
      .weekday{ font-size:.72rem; padding:2px 0; }
      .day-cell{ min-height:92px; padding:6px; font-size:.72rem; line-height:1.2; }
      .day-num{ font-size:.88rem; margin-bottom:2px; }
      .badge{ font-size:.68rem; padding:2px 5px; margin:2px 3px 0 0; }
      .more-hint{ font-size:.68rem; }
    }
  </style>

  <!-- Firebase SDK (v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ===== ê³µí†µ ìƒìˆ˜ ===== */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const THERMO_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    const TOTAL_CELLS = 300;         // 20x15
    const CHANT_CELL_MIN = 10;       // 1ì¹¸=10ë¶„
    const ACTIVITY_CELL = 2;         // 2ì¹¸=í™œë™ 1íšŒ
    const BULB_START_CELLS = 12;     // UX: ë²Œë¸Œ ë¨¼ì €
    const RECENT_PER_BRANCH = 3;

    const nicknameKey = "wolbaehwayang_nickname";
    const adminModeKey = "wol_admin_mode";
    const adminPw = "adminPw";

    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);

    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth();
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`;

    let nickname = localStorage.getItem(nicknameKey) || "";

    const $ = (id) => document.getElementById(id);

    /* ===== Helpers ===== */
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function isInThisMonth(dateKey){
      return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix);
    }
    function isAdminMode(){ return localStorage.getItem(adminModeKey) === "1"; }

    function applyAdminModeUI(){
      document.body.classList.toggle("admin", isAdminMode());
      const btn = $("adminModeBtn");
      if (btn) btn.textContent = isAdminMode() ? "ê´€ë¦¬ì ëª¨ë“œ OFF" : "ê´€ë¦¬ì ëª¨ë“œ ON";

      const schoolAddBtn = $("addSchoolScheduleBtn");
      if (schoolAddBtn) schoolAddBtn.style.display = isAdminMode() ? "inline-block" : "none";
    }

    window.toggleAdminMode = () => {
      if (!isAdminMode()){
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (pw !== adminPw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        localStorage.setItem(adminModeKey, "1");
      } else {
        localStorage.removeItem(adminModeKey);
      }
      applyAdminModeUI();
      loadSchoolMonthSchedule();
    };

    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
      window.scrollTo({ top: 0, behavior: "auto" });
    };

    function fillBranchOptions(selectEl, placeholder="ì§€ë¶€ ì„ íƒ") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        selectEl.appendChild(opt);
      });
    }

    function themeForBranch(branch){
      for (const col of THERMO_COLUMNS){
        if (col.branches.includes(branch)) return col.theme;
      }
      return "theme-blue";
    }

    /* ===== Heat color: blue -> yellow -> red ===== */
    function lerp(a,b,t){ return a + (b-a)*t; }
    function rgb(r,g,b){ return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
    function heatColor(t){
      const b1 = {r:59,g:130,b:246};
      const y  = {r:253,g:224,b:71};
      const r2 = {r:239,g:68,b:68};
      if (t <= 0.5){
        const k = t / 0.5;
        return rgb(lerp(b1.r,y.r,k), lerp(b1.g,y.g,k), lerp(b1.b,y.b,k));
      } else {
        const k = (t-0.5) / 0.5;
        return rgb(lerp(y.r,r2.r,k), lerp(y.g,r2.g,k), lerp(y.b,r2.b,k));
      }
    }

    function approxTempC(cells){
      const ratio = Math.max(0, Math.min(1, (cells || 0) / TOTAL_CELLS));
      return Math.round(ratio * 100);
    }

    function computeBulbAndTube(cells){
      const bulbFilled = cells > 0;
      const tubeCells = Math.max(0, cells - BULB_START_CELLS);
      const tubeCap = Math.max(1, TOTAL_CELLS - BULB_START_CELLS);
      const scaled = Math.min(TOTAL_CELLS, Math.floor((tubeCells / tubeCap) * TOTAL_CELLS));
      return { bulbFilled, tubeFilledCells: scaled };
    }

    function buildTubeGridHTML(filledCells){
      const total = TOTAL_CELLS;
      const startFilledPos = total - filledCells + 1;

      let html = `<div class="tube-grid">`;
      for (let pos=1; pos<=total; pos++){
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled){
          html += `<div class="cell"></div>`;
        } else {
          // bottom cold (blue), top hot (red)
          const tHot = (total - pos) / (total - 1);
          html += `<div class="cell" style="background:${heatColor(tHot)};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    function buildRecentHTML(items){
      const top = (items || []).slice(0, RECENT_PER_BRANCH);
      if (top.length === 0) return `<div class="recent-list"><div class="recent-item">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div></div>`;
      return `
        <div class="recent-list">
          ${top.map(x=>`<div class="recent-item">â€¢ ${escapeHtml(x)}</div>`).join("")}
        </div>
      `;
    }

    function goToChantWithBranch(branch){
      window.showTab("chant");
      const sel = $("chantBranch");
      if (sel) sel.value = branch;
    }

    /* ===== Data aggregation ===== */
    async function computeCumulativeByBranchCells() {
      const chantMinByBranch = {};
      const actCountByBranch = {};
      const cellsByBranch = {};
      const recentByBranch = {};

      branches.forEach(b => {
        chantMinByBranch[b]=0;
        actCountByBranch[b]=0;
        cellsByBranch[b]=0;
        recentByBranch[b]=[];
      });

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities")),
        getDocs(collection(db, "meetings"))
      ]);

      chantSnap.forEach(d => {
        const { branch, minutes, dateKey, nickname: nn } = d.data();
        if (!branch || chantMinByBranch[branch] == null) return;
        const m = Number(minutes) || 0;
        chantMinByBranch[branch] += m;
        cellsByBranch[branch] += Math.floor(m / CHANT_CELL_MIN);
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸŒ± ${m}ë¶„ (${nn || ""})`);
      });

      actSnap.forEach(d => {
        const { branch, subject, target, dateKey } = d.data();
        if (!branch || actCountByBranch[branch] == null) return;
        actCountByBranch[branch] += 1;
        cellsByBranch[branch] += ACTIVITY_CELL;
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸ”¥ ${subject || ""}â†’${target || ""}`);
      });

      // meetings: do not affect cells; only for day-detail and schedule
      meetSnap.forEach(d => {
        const { dateKey, title, time, importance } = d.data();
        if (!dateKey) return;
        const imp = importance ? `(${importance})` : "";
        const tt = time ? ` ${time}` : "";
        const line = `${dateKey.slice(5)} ğŸ“Œ íšŒí•© ${title || "íšŒí•©"}${tt}${imp}`;
        // keep in recents lightly (optional)
        branches.forEach(b => recentByBranch[b].push(line));
      });

      branches.forEach(b => recentByBranch[b].sort((a,c)=> (a < c ? 1 : -1)));

      return { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch };
    }

    /* ===== HOME: compact 4-per-row, only name + thermo + temp ===== */
    async function loadHomeThermoCompact(){
      const container = $("homeThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { cellsByBranch, chantMinByBranch } = await computeCumulativeByBranchCells();

      container.innerHTML = "";
      branches.forEach(branch => {
        const theme = themeForBranch(branch);
        const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
        const { tubeFilledCells } = computeBulbAndTube(cells);
        const temp = approxTempC(cells);

        // requirement: bulb filled when chant starts (not just any record)
        const hasChant = (chantMinByBranch?.[branch] || 0) > 0;

        const item = document.createElement("div");
        item.className = `home-thermo-item thermo-mini ${theme}`;
        item.innerHTML = `
          <div class="home-branch-name">${escapeHtml(branch)}</div>
          <div class="thermo-frame ${theme}">
            <div class="tube">
              ${buildTubeGridHTML(tubeFilledCells)}
            </div>
            <div class="bulb ${hasChant ? "filled" : ""}">
              <div class="bulb-fill"></div>
            </div>
          </div>
          <div class="home-temp">${temp}Â°C</div>
        `;
        item.onclick = () => goToChantWithBranch(branch);
        container.appendChild(item);
      });
    }

    /* ===== CHANT: detailed thermometers grouped + recents ===== */
    async function loadChantThermoDetailed(){
      const container = $("chantThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch } =
        await computeCumulativeByBranchCells();

      container.innerHTML = "";

      THERMO_COLUMNS.forEach(colDef => {
        const col = document.createElement("div");
        col.className = `thermo-col ${colDef.theme}`;

        colDef.branches.forEach(branch => {
          const chantMin = chantMinByBranch[branch] || 0;
          const actCnt = actCountByBranch[branch] || 0;
          const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
          const { bulbFilled, tubeFilledCells } = computeBulbAndTube(cells);
          const temp = approxTempC(cells);

          const card = document.createElement("div");
          card.className = "branch-thermo-card";
          card.innerHTML = `
            <div>
              <div class="branch-thermo-title">
                <span>${escapeHtml(branch)}</span>
                <span class="small">${cells}/${TOTAL_CELLS}ì¹¸ Â· ${temp}Â°C</span>
              </div>
              <div class="branch-thermo-meta">
                ëˆ„ì : <strong>${cells}</strong>ì¹¸<br>
                ì°½ì œ: ${chantMin}ë¶„ Â· í™œë™: ${actCnt}íšŒ<br>
                ê¸°ì¤€: 1ì¹¸=${CHANT_CELL_MIN}ë¶„ Â· 2ì¹¸=í™œë™ 1íšŒ
              </div>
              ${buildRecentHTML(recentByBranch[branch] || [])}
              <div class="hint">í´ë¦­í•˜ë©´ ì°½ì œ ì…ë ¥ì˜ ì§€ë¶€ê°€ ì„ íƒë©ë‹ˆë‹¤.</div>
            </div>
            <div class="thermo-frame ${colDef.theme}">
              <div class="tube">
                ${buildTubeGridHTML(tubeFilledCells)}
              </div>
              <div class="bulb ${bulbFilled ? "filled" : ""}">
                <div class="bulb-fill"></div>
              </div>
            </div>
          `;
          card.onclick = () => {
            const sel = $("chantBranch");
            if (sel) sel.value = branch;
          };
          col.appendChild(card);
        });

        container.appendChild(col);
      });
    }

    /* ===== Today summary ===== */
    async function loadTodaySummary(){
      const chantSnap = await getDocs(query(collection(db,"chants"), where("dateKey","==",todayKey)));
      const actSnap = await getDocs(query(collection(db,"activities"), where("dateKey","==",todayKey)));

      let totalMin = 0;
      let detail = "";

      chantSnap.forEach(d=>{
        const { branch, minutes, nickname: nn } = d.data();
        const m = Number(minutes)||0;
        totalMin += m;
        detail += `ğŸŒ± ${escapeHtml(branch)} - ${m}ë¶„ (${escapeHtml(nn||"")})<br>`;
      });

      actSnap.forEach(d=>{
        const { branch, subject, target } = d.data();
        totalMin += 20;
        detail += `ğŸ”¥ ${escapeHtml(branch)} - ${escapeHtml(subject||"")} â†’ ${escapeHtml(target||"")} (20ë¶„)<br>`;
      });

      $("todayTotal").textContent = `${totalMin}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* ===== Input minutes for chant ===== */
    function getChantMinutes(){
      const custom = Number($("chantMinutesCustom").value);
      const preset = Number($("chantMinutes").value);
      const minutes = (custom && custom > 0) ? custom : preset;
      return minutes;
    }

    /* ===== Save nickname ===== */
    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    /* ===== Save chant (limit 3/day per nickname) ===== */
    window.saveChant = async () => {
      const minutes = getChantMinutes();
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì…ë ¥(ì„ íƒ)í•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(collection(db,"chants"),
        where("nickname","==",nickname),
        where("dateKey","==",todayKey)
      );
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db,"chants"),{
        nickname, branch, minutes,
        blocks: minutes/10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived:false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      window.showTab("home");
    };

    /* ===== Save activity (1íšŒ=2ì¹¸) ===== */
    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();
      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db,"activities"),{
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê³„íš ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      window.showTab("schedule");
    };

    /* ===== Schedule: month activity list ===== */
    async function loadMonthPlans(){
      const container = $("monthPlanList");
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const actSnap = await getDocs(collection(db,"activities"));
      const plans = [];
      actSnap.forEach(d=>{
        const x = d.data();
        if (isInThisMonth(x.dateKey)) plans.push(x);
      });
      plans.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (plans.length === 0){
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ê¸°ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p=>{
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">${escapeHtml(p.dateKey||"")} Â· ${escapeHtml(p.branch||"")}</div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${escapeHtml(p.subject||"")}</strong> â†’ ëŒ€ìƒì: <strong>${escapeHtml(p.target||"")}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${escapeHtml(p.method)}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    /* ===== Schedule: meetings modal ===== */
    window.openMeetingModal = () => {
      $("meetDate").value = todayKey;
      $("meetTitle").value = "";
      $("meetTime").value = "";
      $("meetImportance").value = "ë³´í†µ";
      $("meetingModalLayer").style.display = "flex";
    };
    window.closeMeetingModal = () => { $("meetingModalLayer").style.display = "none"; };

    window.saveMeetingFromModal = async () => {
      const dateKey = $("meetDate").value.trim();
      const title = $("meetTitle").value.trim();
      const time = $("meetTime").value.trim();
      const importance = $("meetImportance").value;

      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜ (YYYY-MM-DD)");
      if (!title) return alert("íšŒí•©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

      await addDoc(collection(db,"meetings"),{
        dateKey, title,
        time: time || "",
        importance: importance || "ë³´í†µ",
        createdAt: serverTimestamp()
      });

      window.closeMeetingModal();
      alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadMonthCalendar();
    };

    /* ===== Day detail modal ===== */
    let cachedDayData = null; // {chantsByDate, activitiesByDate, meetingsByDate}

    async function buildMonthCache(){
      const chantsByDate = {};
      const activitiesByDate = {};
      const meetingsByDate = {};

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db,"chants")),
        getDocs(collection(db,"activities")),
        getDocs(collection(db,"meetings"))
      ]);

      chantSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!chantsByDate[x.dateKey]) chantsByDate[x.dateKey] = [];
        chantsByDate[x.dateKey].push(x);
      });

      actSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!activitiesByDate[x.dateKey]) activitiesByDate[x.dateKey] = [];
        activitiesByDate[x.dateKey].push(x);
      });

      meetSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!meetingsByDate[x.dateKey]) meetingsByDate[x.dateKey] = [];
        meetingsByDate[x.dateKey].push(x);
      });

      cachedDayData = { chantsByDate, activitiesByDate, meetingsByDate };
    }

    function openDayDetail(dateKey){
      $("dayDetailTitle").textContent = `ì¼ì • ìƒì„¸ Â· ${dateKey}`;

      const chants = (cachedDayData?.chantsByDate?.[dateKey] || []);
      const acts = (cachedDayData?.activitiesByDate?.[dateKey] || []);
      const meets = (cachedDayData?.meetingsByDate?.[dateKey] || []);

      const chantSum = chants.reduce((s,it)=> s + (Number(it.minutes)||0), 0);

      let html = "";
      html += `<div class="detail-block">
        <div class="detail-title">ğŸŒ± ì°½ì œ</div>
        <div class="small">í•©ê³„: <strong>${chantSum}</strong>ë¶„</div>
        ${chants.length ? chants.map(it=>`
          <div class="small">â€¢ ${escapeHtml(it.branch||"")} Â· ${Number(it.minutes)||0}ë¶„ Â· ${escapeHtml(it.nickname||"")}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      html += `<div class="detail-block">
        <div class="detail-title">ğŸ”¥ í™œë™</div>
        ${acts.length ? acts.map(it=>`
          <div class="small">â€¢ ${escapeHtml(it.branch||"")} Â· ${escapeHtml(it.subject||"")} â†’ ${escapeHtml(it.target||"")}${it.method ? ` Â· ${escapeHtml(it.method)}` : ""}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      html += `<div class="detail-block">
        <div class="detail-title">ğŸ“Œ íšŒí•©</div>
        ${meets.length ? meets.map(it=>`
          <div class="small">â€¢ ${escapeHtml(it.title||"íšŒí•©")}${it.time ? ` Â· ${escapeHtml(it.time)}` : ""}${it.importance ? ` Â· (${escapeHtml(it.importance)})` : ""}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      $("dayDetailBody").innerHTML = html;
      $("dayDetailModalLayer").style.display = "flex";
    }

    window.closeDayDetailModal = () => { $("dayDetailModalLayer").style.display = "none"; };

    /* ===== Month calendar (grid, mobile safe, branch í‘œì‹œ) ===== */
    async function loadMonthCalendar(){
      const cal = $("monthCalendar");
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      await buildMonthCache();

      const chantMinMap = {};
      const actBranchMap = {};  // dateKey -> {branch: count}
      const meetingMap = {};    // dateKey -> count

      Object.entries(cachedDayData.chantsByDate).forEach(([dateKey, arr])=>{
        chantMinMap[dateKey] = arr.reduce((s,it)=> s + (Number(it.minutes)||0), 0);
      });

      Object.entries(cachedDayData.activitiesByDate).forEach(([dateKey, arr])=>{
        if (!actBranchMap[dateKey]) actBranchMap[dateKey] = {};
        arr.forEach(it=>{
          const b = it.branch || "ë¯¸ì§€ì •";
          actBranchMap[dateKey][b] = (actBranchMap[dateKey][b] || 0) + 1;
        });
      });

      Object.entries(cachedDayData.meetingsByDate).forEach(([dateKey, arr])=>{
        meetingMap[dateKey] = arr.length;
      });

      cal.innerHTML = "";

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      weekdays.forEach(w=>{
        const h = document.createElement("div");
        h.className = "weekday";
        h.textContent = w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay();
      for (let i=0;i<firstDayWeek;i++){
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.visibility = "hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();

      const isMobile = window.matchMedia && window.matchMedia("(max-width: 520px)").matches;

      for (let day=1; day<=lastDate; day++){
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        const chantMin = chantMinMap[dateKey] || 0;
        const branchCounts = actBranchMap[dateKey] || null;
        const meetCount = meetingMap[dateKey] || 0;

        // activity badges: show 1 on mobile, 2 on desktop; show "... ë”ë³´ê¸°" if more
        let actBadges = "";
        let hiddenCount = 0;
        if (branchCounts){
          const entries = Object.entries(branchCounts).sort((a,b)=> b[1]-a[1]);
          const take = isMobile ? 1 : 2;
          const top = entries.slice(0, take);
          hiddenCount = Math.max(0, entries.length - take);
          actBadges = top.map(([b,c])=> `<span class="badge act-badge">${escapeHtml(b)}Ã—${c}</span>`).join("");
        }

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actBadges}
          ${meetCount ? `<span class="badge meet-badge">íšŒí•© ${meetCount}ê±´</span>` : ``}
          ${hiddenCount > 0 ? `<span class="more-hint">â€¦ ë”ë³´ê¸°</span>` : ``}
        `;
        cell.addEventListener("click", ()=>openDayDetail(dateKey));
        cal.appendChild(cell);
      }
    }

    /* ===== School: month schedule (admin add/edit) ===== */
    async function loadSchoolMonthSchedule(){
      const list = $("schoolMonthScheduleList");
      list.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const snap = await getDocs(collection(db,"schoolSchedules"));
      const items = [];
      snap.forEach(d=>{
        const x = d.data();
        if (isInThisMonth(x.dateKey)) items.push({ id: d.id, ...x });
      });
      items.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (items.length === 0){
        list.innerHTML = `<div class="small">ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      list.innerHTML = "";
      items.forEach(it=>{
        const div = document.createElement("div");
        div.className = "school-sched-item";
        div.innerHTML = `
          <div class="school-sched-top">
            <div class="school-sched-date">${escapeHtml(it.dateKey||"")}</div>
            ${isAdminMode() ? `<button class="mini-btn" style="padding:8px 10px;font-size:.85rem;" data-edit="${it.id}">ìˆ˜ì •</button>` : ``}
          </div>
          <div><strong>${escapeHtml(it.title||"")}</strong></div>
          ${it.desc ? `<div class="small" style="margin-top:4px;">${escapeHtml(it.desc)}</div>` : ``}
        `;
        list.appendChild(div);

        if (isAdminMode()){
          const btn = div.querySelector(`[data-edit="${it.id}"]`);
          if (btn){
            btn.addEventListener("click", async (e)=>{
              e.stopPropagation();
              await editSchoolSchedule(it.id, it);
            });
          }
        }
      });
    }

    window.addSchoolSchedule = async () => {
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ (YYYY-MM-DD)", todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", "") || "";

      await addDoc(collection(db,"schoolSchedules"),{
        dateKey, title: title.trim(), desc: desc.trim(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    };

    async function editSchoolSchedule(id, current){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ (YYYY-MM-DD)", current.dateKey || todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");

      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", current.title || "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", current.desc || "") || "";

      await updateDoc(doc(db,"schoolSchedules", id),{
        dateKey,
        title: title.trim(),
        desc: desc.trim(),
        updatedAt: serverTimestamp()
      });

      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    }

    /* ===== School: branch progress + 20 slots ===== */
    async function loadThermometerForSchoolBranch(branch){
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";
      if (!branch){
        wrap.innerHTML = `<div class="small">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const confirmed = snap.docs.filter(d=> d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed / 20) * 100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${escapeHtml(branch)} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch){
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const bySlot = new Map();
      snap.forEach(docu=>{
        const data = docu.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: docu.ref, ...data });
      });

      for (let slot=1; slot<=20; slot++){
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        // filled triangle requested: use solid â–² for pending; âœ… for confirmed
        toggle.innerHTML = confirmed ? "âœ…" : "â–²";

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        toggle.onclick = async ()=>{
          const newStatus = !(existing?.confirmed === true);
          toggle.innerHTML = newStatus ? "âœ…" : "â–²";

          if (existing?.ref){
            await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db,"school"),{
              branch, slot,
              confirmed: newStatus,
              name: (input.value || "").trim(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value || "").trim() };
            bySlot.set(slot, existing);
          }

          await loadThermometerForSchoolBranch(branch);
        };

        input.addEventListener("blur", async ()=>{
          const newName = (input.value || "").trim();

          if (existing?.ref){
            await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
            existing.name = newName;
          } else {
            const newRef = await addDoc(collection(db,"school"),{
              branch, slot,
              confirmed: false,
              name: newName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: false, name: newName };
            bySlot.set(slot, existing);
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);
        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ===== Admin: stats + reset ===== */
    window.loadAdminStats = async () => {
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches) {
        const [chantSnap, activitySnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db, "chants"), where("branch", "==", b))),
          getDocs(query(collection(db, "activities"), where("branch", "==", b))),
          getDocs(query(collection(db, "school"), where("branch", "==", b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d => d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${escapeHtml(b)}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${activitySnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    window.resetAllData = async () => {
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©/ìŠ¤ì¿¨ì¼ì •)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants", "activities", "school", "meetings", "schoolSchedules"];
      for (const col of cols) {
        const snap = await getDocs(collection(db, col));
        for (const d of snap.docs) {
          await deleteDoc(d.ref);
        }
      }

      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      window.showTab("home");
    };

    /* ===== Refresh all ===== */
    async function refreshAll(){
      await applyAdminModeUI();

      await loadTodaySummary();
      await loadHomeThermoCompact();
      await loadChantThermoDetailed();

      await loadMonthPlans();
      await loadMonthCalendar();

      await loadSchoolMonthSchedule();

      const selected = $("schoolBranchSelect").value;
      await loadThermometerForSchoolBranch(selected);
      await loadSchoolGrid(selected);
    }

    /* ===== Modal outside click close ===== */
    function bindModalOutsideClose(){
      document.addEventListener("click", (e)=>{
        const m1 = $("meetingModalLayer");
        if (m1 && m1.style.display === "flex" && e.target === m1) m1.style.display = "none";

        const m2 = $("dayDetailModalLayer");
        if (m2 && m2.style.display === "flex" && e.target === m2) m2.style.display = "none";
      });
    }

    /* ===== Init ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      applyAdminModeUI();
      bindModalOutsideClose();

      // nickname gate
      if (!nickname) {
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      // fill selects
      fillBranchOptions($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      $("schoolBranchSelect").addEventListener("change", async (e)=>{
        const branch = e.target.value;
        await loadThermometerForSchoolBranch(branch);
        await loadSchoolGrid(branch);
      });

      // if nickname exists, load everything
      if (nickname) await refreshAll();

      // responsive calendar re-render on resize (keeps grid but recalculates badge take)
      window.addEventListener("resize", ()=>{
        clearTimeout(window.__calResizeT);
        window.__calResizeT = setTimeout(()=> loadMonthCalendar(), 150);
      });
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">
      í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong>
      <div class="hint">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ë¶€ì—°ì„¤ëª…ì´ ë…¸ì¶œë©ë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong><br><br>
      <strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br>
      <div id="todayDetail" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint">í™ˆì—ì„œëŠ” ì˜¨ë„ê³„ + ì§€ë¶€ëª… + ì˜¨ë„ë§Œ í‘œì‹œë©ë‹ˆë‹¤. (í´ë¦­ ì‹œ ì°½ì œ íƒ­ ì´ë™)</div>
      <div style="height:12px;"></div>
      <div id="homeThermoGrid" class="home-thermo-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <strong>ì°½ì œ ê¸°ë¡</strong>
      <div class="hint">í•˜ë£¨ 3íšŒ ì œí•œ Â· ì§ì ‘ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©</div>
      <div style="height:10px;"></div>

      <div class="row">
        <select id="chantBranch"></select>

        <div style="display:grid;gap:8px;">
          <select id="chantMinutes">
            <option value="">ì‹œê°„ ì„ íƒ</option>
            <option value="10">10ë¶„</option>
            <option value="30">30ë¶„</option>
            <option value="60">60ë¶„</option>
          </select>
          <input id="chantMinutesCustom" type="number" min="1" step="1" placeholder="ì§ì ‘ ì…ë ¥(ë¶„) ì˜ˆ: 45" />
        </div>
      </div>

      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
    </div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„(ìƒì„¸)</strong>
      <div class="hint">í´ë¦­í•˜ë©´ ì°½ì œ ì…ë ¥ì˜ ì§€ë¶€ ì„ íƒì´ ë°”ë€ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="chantThermoGrid" class="thermo-grid-wrap"></div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <strong>í™œë™ ê³„íš ê¸°ë¡</strong>
      <div class="hint">í™œë™ 1íšŒëŠ” ëˆ„ì  ì˜¨ë„ê³„ ê¸°ì¤€ 2ì¹¸ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>

      <select id="activityBranch"></select>
      <div style="height:10px;"></div>

      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>

      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>

      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>

      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ê¸°ë¡ ğŸ”¥</button>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
      <div class="hint">ê¸°ë¡ëœ í™œë™ ê³„íšì„ ë‚ ì§œë³„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>
      <div style="height:10px;"></div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="hint">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸(ì°½ì œ/í™œë™/íšŒí•©)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <button class="mini-btn" onclick="openMeetingModal()">+ íšŒí•©</button>
      </div>

      <div style="height:10px;"></div>
      <div id="monthCalendar" class="month-calendar"></div>

      <div class="small" style="margin-top:10px;opacity:.85;">
        ëª¨ë°”ì¼ì—ì„œë„ ì¼ë°˜ ë‹¬ë ¥(ì£¼ì°¨/ìš”ì¼)ì„ ìœ ì§€í•˜ë©°, ì…€ì—ëŠ” ìš”ì•½ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <strong>ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¼ì • ì¶”ê°€/ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
        <button id="addSchoolScheduleBtn" class="mini-btn" onclick="addSchoolSchedule()" style="display:none;">+ ì¼ì • ì¶”ê°€</button>
      </div>
      <div style="height:10px;"></div>
      <div id="schoolMonthScheduleList" class="school-sched-list"></div>
    </div>

    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸)</strong>
      <div class="hint">â–²(ë¯¸í™•ì •) / âœ…(í™•ì •) Â· ì´ë¦„ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì €ì¥</div>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
    </div>

    <div class="card school-wrap">
      <div id="schoolThermoWrap"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œ ON ì‹œ ë¶€ì—°ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <button id="adminModeBtn" class="mini-btn" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ON</button>
      </div>

      <div style="height:12px;"></div>
      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME MODAL -->
  <div id="nicknameLayer">
    <div class="card">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
      <div class="small" style="margin-top:10px;opacity:.8;">
        ë‹‰ë„¤ì„ì€ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --card-bg: rgba(255,255,255,.92);
      --bd: rgba(0,0,0,.10);
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.35rem;
      font-weight:900;
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(8px);
    }
    nav{
      display:flex;
      gap:6px;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      flex-wrap:wrap;
      position: sticky;
      top: 64px;
      z-index: 25;
      backdrop-filter: blur(8px);
    }
    nav button{
      border:none;
      background:none;
      padding:8px 12px;
      font-size:1rem;
      border-radius:12px;
      cursor:pointer;
      touch-action: manipulation;
    }
    nav button:hover{ background:rgba(0,0,0,.06); }

    section{ display:none; padding:16px; }
    section.active{ display:block; }

    .card{
      background:var(--card-bg);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:12px 12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
      touch-action: manipulation;
    }
    .btn.secondary{ background:#444; }
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-size:.9rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .mini-btn:hover{ opacity:.92; }
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      outline:none;
      font-size: 1rem;
    }
    .small{ font-size:.9rem; opacity:.86; }
    .hint{ display:none; font-size:.88rem; opacity:.82; }
    body.admin .hint{ display:block; }

    /* ===== í™ˆ: 4ê°œ/í–‰ ì˜¨ë„ê³„ ===== */
    .home-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .home-grid{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width: 720px){ .home-grid{ grid-template-columns:repeat(2,1fr); } }

    .home-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
      text-align:center;
    }
    .home-item:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .home-branch{ font-weight:900; margin-bottom:6px; }
    .home-temp{ font-weight:900; margin-top:6px; }

    /* ===== ì°½ì œ: ìƒì„¸ ì˜¨ë„ê³„ 3ì—´ ê·¸ë£¹ ===== */
    .thermo-grid-wrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .thermo-col{ display:flex; flex-direction:column; gap:12px; min-width:0; }
    @media (max-width: 520px){
      section{ padding:12px; }
      .row{ grid-template-columns:1fr; }
      .thermo-grid-wrap{ grid-template-columns: 1fr; }
    }

    .branch-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 92px;
      gap: 10px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .branch-thermo-card:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }

    .branch-thermo-title{
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .branch-thermo-meta{ font-size:.88rem; opacity:.86; line-height:1.35; }
    .recent-list{ margin-top:8px; font-size:.82rem; opacity:.92; line-height:1.35; }
    .recent-item{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:2px 0; }

    /* ===== ì˜¨ë„ê³„ í”„ë ˆì„ ===== */
    .thermo-frame{ width:92px; height:252px; position:relative; display:flex; align-items:flex-start; justify-content:center; }
    .tube{
      width:60px; height:192px;
      border-radius:999px;
      background: rgba(255,255,255,.90);
      border:2px solid rgba(0,0,0,.12);
      overflow:hidden;
      padding:8px;
      box-sizing:border-box;
      display:flex;
    }
    .tube-grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns:repeat(20,1fr);
      grid-template-rows:repeat(15,1fr);
      gap:1px;
      background: rgba(0,0,0,.05);
      border-radius:12px;
      padding:2px;
      box-sizing:border-box;
    }
    .cell{
      background: rgba(255,255,255,.60);
      border-radius: 1px;
    }
    .bulb{
      width:82px; height:82px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      border:2px solid rgba(0,0,0,.12);
      position:absolute;
      bottom:0;
      overflow:hidden;
      box-sizing:border-box;
    }
    .bulb-fill{
      position:absolute;
      inset:10px;
      border-radius:999px;
      opacity:0;
      transform: scale(.92);
      transition: opacity .25s ease, transform .25s ease;
    }
    .bulb.filled .bulb-fill{
      opacity:1;
      transform: scale(1);
    }

    /* í…Œë§ˆ í”„ë ˆì„(ì°½ì œ íƒ­) */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }
    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }
    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* í™ˆ ë²Œë¸Œ ì±„ì›€: í”„ë ˆì„ ìƒ‰(ìš”ì²­) */
    .theme-blue .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(0,128,255,.45) 0%, rgba(0,128,255,.85) 60%, rgba(0,128,255,.95) 100%); }
    .theme-yellow .bulb-fill{ background: radial-gradient(circle at 30% 30%, rgba(255,193,7,.45) 0%, rgba(255,193,7,.85) 60%, rgba(255,193,7,.95) 100%); }
    .theme-pink .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(194,24,91,.35) 0%, rgba(194,24,91,.80) 60%, rgba(194,24,91,.95) 100%); }

    /* í™ˆì€ ì•½ê°„ ë” ì‘ê²Œ */
    .thermo-mini .thermo-frame{ width:88px; height:234px; }
    .thermo-mini .tube{ width:56px; height:176px; padding:7px; }
    .thermo-mini .bulb{ width:76px; height:76px; }

    /* ===== ì¼ì •(ë‹¬ë ¥) ===== */
    .card-header{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:10px;
    }
    .plan-list{ display:grid; gap:10px; }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{ font-weight:900; margin-bottom:4px; }
    .plan-meta{ font-size:.86rem; opacity:.88; }

    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:900;
      text-align:center;
      opacity:.82;
      padding: 4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:86px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.25;
      cursor:pointer;
      overflow:hidden;
    }
    .day-cell:hover{ box-shadow: var(--shadow); }
    .day-num{ font-weight:900; font-size:.95rem; margin-bottom:4px; }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align: top;
    }
    .meet-badge{ background:rgba(194,24,91,.10); }
    .act-badge{ background:rgba(0, 128, 255, .10); }
    .more-hint{ display:none; font-size:.72rem; opacity:.78; margin-top:4px; }

    /* ëª¨ë°”ì¼ì—ì„œë„ "ì¼ë°˜ ë‹¬ë ¥" ìœ ì§€ + ì˜ë¦¼ ë°©ì§€(ìš”ì²­) */
    @media (max-width: 520px){
      .month-calendar{ gap:4px; }
      .weekday{ font-size:.72rem; padding:2px 0; }
      .day-cell{
        min-height:96px;
        padding:6px;
        font-size:.72rem;
        line-height:1.2;
      }
      .day-num{ font-size:.88rem; margin-bottom:2px; }
      .badge{ font-size:.68rem; padding:2px 5px; margin:2px 3px 0 0; }
      .more-hint{ display:block; }
    }

    /* ===== ìŠ¤ì¿¨ ===== */
    .school-sched-list{ display:grid; gap:10px; }
    .school-sched-item{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      line-height:1.35;
    }
    .school-sched-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .school-sched-date{ font-weight:900; }

    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:800;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }

    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      #schoolGrid{ grid-template-columns:repeat(2,1fr); }
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
    }
    .slot-num{ font-weight:900; font-size:.9rem; opacity:.82; }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.05rem;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.05);
      min-width:40px;
      text-align:center;
      touch-action: manipulation;
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }
    .tri{
      color:#8e8e8e;
      font-weight:900; /* ì±„ì›Œì§„ ëŠë‚Œ */
    }
    .slot-input{
      width:100%;
      padding:12px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.95rem;
      background:#FFF6BF; /* ìš”ì²­: ì—°ë…¸ë‘ ê³ ì • */
    }

    /* ===== ëª¨ë‹¬(ê³µìš©) ===== */
    .modal-layer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:9999;
      padding:14px;
      box-sizing:border-box;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(0,0,0,.10);
      max-height: 86vh;
      overflow:auto;
    }
    .modal h3{ margin:0 0 10px 0; font-size:1.05rem; }
    .modal .grid{ display:grid; gap:10px; }
    .modal .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .modal .actions button{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-size:1rem;
      touch-action: manipulation;
    }
    .modal .actions .cancel{ background:#eee; }
    .modal .actions .ok{ background:#111; color:#fff; }

    .detail-block{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      background:#fff;
      line-height:1.4;
    }
    .detail-title{ font-weight:900; margin-bottom:6px; }

    /* ë‹‰ë„¤ì„ ë ˆì´ì–´ */
    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:10000;
      padding:14px;
      box-sizing:border-box;
    }
  </style>

  <!-- Firebase SDK (v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const THERMO_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    const TOTAL_CELLS = 300;        // íŠœë¸Œ ê²©ì ì¹¸ìˆ˜(20x15)
    const CHANT_CELL_MIN = 10;      // 1ì¹¸=10ë¶„
    const ACTIVITY_CELL = 2;        // í™œë™ 1íšŒ=2ì¹¸
    const BULB_START_CELLS = 12;    // ë²Œë¸Œ ë¨¼ì €(UX)
    const RECENT_PER_BRANCH = 3;

    const nicknameKey = "wolbaehwayang_nickname";
    const adminModeKey = "wol_admin_mode";
    const adminPw = "adminPw";

    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);
    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth();
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`;

    let nickname = localStorage.getItem(nicknameKey) || "";

    const $ = (id) => document.getElementById(id);
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function isAdminMode(){ return localStorage.getItem(adminModeKey) === "1"; }
    function applyAdminModeUI(){
      document.body.classList.toggle("admin", isAdminMode());
      const btn = $("adminModeBtn");
      if (btn) btn.textContent = isAdminMode() ? "ê´€ë¦¬ì ëª¨ë“œ OFF" : "ê´€ë¦¬ì ëª¨ë“œ ON";
      const schBtn = $("addSchoolScheduleBtn");
      if (schBtn) schBtn.style.display = isAdminMode() ? "inline-block" : "none";
    }

    window.toggleAdminMode = () => {
      if (!isAdminMode()){
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (pw !== adminPw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        localStorage.setItem(adminModeKey, "1");
      } else {
        localStorage.removeItem(adminModeKey);
      }
      applyAdminModeUI();
      loadSchoolMonthSchedule();
    };

    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
      window.scrollTo({ top: 0, behavior: "auto" });
    };

    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    function fillBranch( ÑĞµĞ», placeholder="ì§€ë¶€ ì„ íƒ"){
      // (ì£¼ì˜) í•œê¸€ ë³€ìˆ˜ëª… ë°©ì§€: ì‹¤ì œ í˜¸ì¶œì—ì„œëŠ” fillSelect ì‚¬ìš©
    }
    function fillSelect(selectEl, placeholder="ì§€ë¶€ ì„ íƒ"){
      selectEl.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "";
      o0.textContent = placeholder;
      selectEl.appendChild(o0);
      branches.forEach(b=>{
        const o = document.createElement("option");
        o.value = b; o.textContent = b;
        selectEl.appendChild(o);
      });
    }

    function themeForBranch(branch){
      for (const col of THERMO_COLUMNS){
        if (col.branches.includes(branch)) return col.theme;
      }
      return "theme-blue";
    }

    /* ===== ì˜¨ë„/ìƒ‰ ===== */
    function lerp(a,b,t){ return a + (b-a)*t; }
    function rgb(r,g,b){ return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
    function heatColor(t){
      // t=0(ì•„ë˜/ì°¨ê°€ì›€) íŒŒë‘ -> t=0.5 ë…¸ë‘ -> t=1 ë¹¨ê°•
      const b1={r:59,g:130,b:246}, y={r:253,g:224,b:71}, r2={r:239,g:68,b:68};
      if (t<=0.5){
        const k=t/0.5;
        return rgb(lerp(b1.r,y.r,k), lerp(b1.g,y.g,k), lerp(b1.b,y.b,k));
      } else {
        const k=(t-0.5)/0.5;
        return rgb(lerp(y.r,r2.r,k), lerp(y.g,r2.g,k), lerp(y.b,r2.b,k));
      }
    }
    function approxTempC(cells){
      const ratio = Math.max(0, Math.min(1, (cells||0)/TOTAL_CELLS));
      return Math.round(ratio * 100);
    }

    function computeBulbAndTube(cells){
      const tubeCells = Math.max(0, cells - BULB_START_CELLS);
      const tubeCap = Math.max(1, TOTAL_CELLS - BULB_START_CELLS);
      const scaled = Math.min(TOTAL_CELLS, Math.floor((tubeCells / tubeCap) * TOTAL_CELLS));
      return { tubeFilledCells: scaled };
    }

    function buildTubeGridHTML(filledCells){
      const total = TOTAL_CELLS;
      const startFilledPos = total - filledCells + 1;
      let html = `<div class="tube-grid">`;
      for (let pos=1; pos<=total; pos++){
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled){
          html += `<div class="cell"></div>`;
        } else {
          // ì•„ë˜(íŒŒë‘) -> ìœ„(ë¹¨ê°•)
          const tHot = (total - pos) / (total - 1);
          html += `<div class="cell" style="background:${heatColor(tHot)};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    function buildRecentHTML(items){
      const top = (items || []).slice(0, RECENT_PER_BRANCH);
      if (top.length === 0) return `<div class="recent-list"><div class="recent-item">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div></div>`;
      return `
        <div class="recent-list">
          ${top.map(x=>`<div class="recent-item">â€¢ ${esc(x)}</div>`).join("")}
        </div>
      `;
    }

    function isInThisMonth(dateKey){ return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix); }

    /* ===== ë°ì´í„° ì§‘ê³„ ===== */
    async function computeCumulative(){
      const chantMinByBranch = {};
      const actCountByBranch = {};
      const cellsByBranch = {};
      const recentByBranch = {};
      branches.forEach(b=>{
        chantMinByBranch[b]=0;
        actCountByBranch[b]=0;
        cellsByBranch[b]=0;
        recentByBranch[b]=[];
      });

      const [chantSnap, actSnap] = await Promise.all([
        getDocs(collection(db,"chants")),
        getDocs(collection(db,"activities"))
      ]);

      chantSnap.forEach(d=>{
        const { branch, minutes, dateKey, nickname: nn } = d.data();
        if (!branch || chantMinByBranch[branch]==null) return;
        const m = Number(minutes)||0;
        chantMinByBranch[branch]+=m;
        cellsByBranch[branch]+=Math.floor(m/CHANT_CELL_MIN);
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸŒ± ${m}ë¶„ (${nn||""})`);
      });

      actSnap.forEach(d=>{
        const { branch, subject, target, dateKey } = d.data();
        if (!branch || actCountByBranch[branch]==null) return;
        actCountByBranch[branch]+=1;
        cellsByBranch[branch]+=ACTIVITY_CELL;
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸ”¥ ${subject||""}â†’${target||""}`);
      });

      branches.forEach(b=> recentByBranch[b].sort((a,c)=> (a<c?1:-1)));
      return { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch };
    }

    /* ===== í™ˆ: ê°„ì†Œ ì˜¨ë„ê³„ (ì´ë¦„+ì˜¨ë„ê³„+ì˜¨ë„) ===== */
    async function loadHomeThermoCompact(){
      const container = $("homeThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { cellsByBranch, chantMinByBranch } = await computeCumulative();

      container.innerHTML = "";
      branches.forEach(branch=>{
        const theme = themeForBranch(branch);
        const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
        const { tubeFilledCells } = computeBulbAndTube(cells);
        const temp = approxTempC(cells);

        // ìš”ì²­: ë™ê·¸ë¼ë¯¸ëŠ” "ì°½ì œ ê¸°ë¡ ì‹œì‘" ì‹œ í”„ë ˆì„ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
        const hasChant = (chantMinByBranch[branch] || 0) > 0;

        const div = document.createElement("div");
        div.className = `home-item thermo-mini ${theme}`;
        div.innerHTML = `
          <div class="home-branch">${esc(branch)}</div>
          <div class="thermo-frame ${theme}">
            <div class="tube">${buildTubeGridHTML(tubeFilledCells)}</div>
            <div class="bulb ${hasChant ? "filled" : ""}">
              <div class="bulb-fill"></div>
            </div>
          </div>
          <div class="home-temp">${temp}Â°C</div>
        `;
        div.onclick = () => {
          showTab("chant");
          const sel = $("chantBranch");
          if (sel) sel.value = branch;
        };
        container.appendChild(div);
      });
    }

    /* ===== ì°½ì œ íƒ­: ìƒì„¸ ì˜¨ë„ê³„ (ìµœê·¼ê¸°ë¡ í¬í•¨) ===== */
    async function loadChantThermoDetailed(){
      const container = $("chantThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch } = await computeCumulative();
      container.innerHTML = "";

      THERMO_COLUMNS.forEach(colDef=>{
        const col = document.createElement("div");
        col.className = `thermo-col ${colDef.theme}`;

        colDef.branches.forEach(branch=>{
          const theme = colDef.theme;
          const chantMin = chantMinByBranch[branch] || 0;
          const actCnt = actCountByBranch[branch] || 0;
          const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
          const { tubeFilledCells } = computeBulbAndTube(cells);
          const temp = approxTempC(cells);

          const card = document.createElement("div");
          card.className = `branch-thermo-card ${theme}`;
          card.innerHTML = `
            <div>
              <div class="branch-thermo-title">
                <span>${esc(branch)}</span>
                <span class="small">${cells}/${TOTAL_CELLS}ì¹¸ Â· ${temp}Â°C</span>
              </div>

              <div class="branch-thermo-meta">
                ëˆ„ì : <strong>${cells}</strong>ì¹¸<br>
                ì°½ì œ: ${chantMin}ë¶„ Â· í™œë™: ${actCnt}íšŒ<br>
                ê¸°ì¤€: 1ì¹¸=${CHANT_CELL_MIN}ë¶„ Â· 2ì¹¸=í™œë™ 1íšŒ
              </div>

              ${buildRecentHTML(recentByBranch[branch] || [])}
              <div class="hint" style="margin-top:8px;">í´ë¦­í•˜ë©´ ì§€ë¶€ê°€ ì„ íƒë©ë‹ˆë‹¤.</div>
            </div>

            <div class="thermo-frame ${theme}">
              <div class="tube">${buildTubeGridHTML(tubeFilledCells)}</div>
              <div class="bulb ${(chantMin>0) ? "filled" : ""}">
                <div class="bulb-fill"></div>
              </div>
            </div>
          `;
          card.onclick = ()=> { const sel=$("chantBranch"); if(sel) sel.value=branch; };
          col.appendChild(card);
        });

        container.appendChild(col);
      });
    }

    /* ===== ê¸°ë¡ ì €ì¥ ===== */
    function getChantMinutes(){
      const custom = Number($("chantMinutesCustom").value);
      const preset = Number($("chantMinutes").value);
      const minutes = (custom && custom > 0) ? custom : preset;
      return minutes;
    }

    window.saveChant = async () => {
      const minutes = getChantMinutes();
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì…ë ¥(ì„ íƒ)í•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      // 1ì¼ 3íšŒ ì œí•œ(ë‹‰ë„¤ì„ ê¸°ì¤€)
      const q = query(collection(db,"chants"), where("nickname","==",nickname), where("dateKey","==",todayKey));
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db,"chants"),{
        nickname, branch, minutes,
        blocks: minutes/10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived:false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      showTab("home");
    };

    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db,"activities"),{
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê³„íš ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      showTab("schedule");
    };

    /* ===== ì˜¤ëŠ˜ ìš”ì•½ ===== */
    async function loadTodaySummary(){
      const chantSnap = await getDocs(query(collection(db,"chants"), where("dateKey","==",todayKey)));
      const actSnap = await getDocs(query(collection(db,"activities"), where("dateKey","==",todayKey)));

      let totalMin = 0;
      let detail = "";

      chantSnap.forEach(d=>{
        const { nickname: n, branch, minutes } = d.data();
        const m = Number(minutes)||0;
        totalMin += m;
        detail += `ğŸŒ± ${esc(branch)} - ${m}ë¶„ (${esc(n)})<br>`;
      });

      actSnap.forEach(d=>{
        const { branch, subject, target } = d.data();
        totalMin += 20;
        detail += `ğŸ”¥ ${esc(branch)} - ${esc(subject)} â†’ ${esc(target)} (20ë¶„)<br>`;
      });

      $("todayTotal").innerHTML = `${totalMin}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* ===== ì¼ì •: í™œë™ ë¦¬ìŠ¤íŠ¸ ===== */
    async function loadMonthPlans(){
      const container = $("monthPlanList");
      if (!container) return;
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const actSnap = await getDocs(collection(db,"activities"));
      const plans = [];
      actSnap.forEach(d=>{
        const x = d.data();
        if (isInThisMonth(x.dateKey)) plans.push(x);
      });
      plans.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (plans.length === 0){
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ê¸°ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p=>{
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">${esc(p.dateKey||"")} Â· ${esc(p.branch||"")}</div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${esc(p.subject||"")}</strong> â†’ ëŒ€ìƒì: <strong>${esc(p.target||"")}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${esc(p.method)}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    /* ===== ì¼ì •: íšŒí•© ëª¨ë‹¬ ===== */
    window.openMeetingModal = () => {
      $("meetDate").value = todayKey;
      $("meetTitle").value = "";
      $("meetTime").value = "";
      $("meetImportance").value = "ë³´í†µ";
      $("meetingModalLayer").style.display = "flex";
    };
    window.closeMeetingModal = () => { $("meetingModalLayer").style.display = "none"; };

    window.saveMeetingFromModal = async () => {
      const dateKey = $("meetDate").value.trim();
      const title = $("meetTitle").value.trim();
      const time = $("meetTime").value.trim();
      const importance = $("meetImportance").value;

      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜(YYYY-MM-DD).");
      if (!title) return alert("íšŒí•©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

      await addDoc(collection(db,"meetings"),{
        dateKey, title,
        time: time || "",
        importance: importance || "ë³´í†µ",
        createdAt: serverTimestamp()
      });

      closeMeetingModal();
      alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadMonthCalendar();
    };

    /* ===== ì¼ì •: ë‚ ì§œ í´ë¦­ ìƒì„¸ ===== */
    let cachedDayData = null; // {chantsByDate, activitiesByDate, meetingsByDate}
    async function buildMonthCache(){
      const chantsByDate = {};
      const activitiesByDate = {};
      const meetingsByDate = {};

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db,"chants")),
        getDocs(collection(db,"activities")),
        getDocs(collection(db,"meetings"))
      ]);

      chantSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        (chantsByDate[x.dateKey] ||= []).push(x);
      });

      actSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        (activitiesByDate[x.dateKey] ||= []).push(x);
      });

      meetSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        (meetingsByDate[x.dateKey] ||= []).push(x);
      });

      cachedDayData = { chantsByDate, activitiesByDate, meetingsByDate };
    }

    function openDayDetail(dateKey){
      $("dayDetailTitle").textContent = `ì¼ì • ìƒì„¸ Â· ${dateKey}`;
      const body = $("dayDetailBody");

      const chants = cachedDayData?.chantsByDate?.[dateKey] || [];
      const acts = cachedDayData?.activitiesByDate?.[dateKey] || [];
      const meets = cachedDayData?.meetingsByDate?.[dateKey] || [];

      const chantSum = chants.reduce((s,it)=> s + (Number(it.minutes)||0), 0);

      body.innerHTML = `
        <div class="detail-block">
          <div class="detail-title">ğŸŒ± ì°½ì œ</div>
          <div class="small">í•©ê³„: <strong>${chantSum}</strong>ë¶„</div>
          ${chants.length ? chants.map(it=>`
            <div class="small">â€¢ ${esc(it.branch||"")} Â· ${(Number(it.minutes)||0)}ë¶„ Â· ${esc(it.nickname||"")}</div>
          `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
        </div>

        <div class="detail-block">
          <div class="detail-title">ğŸ”¥ í™œë™</div>
          ${acts.length ? acts.map(it=>`
            <div class="small">â€¢ ${esc(it.branch||"")} Â· ${esc(it.subject||"")} â†’ ${esc(it.target||"")}${it.method?` Â· ${esc(it.method)}`:""}</div>
          `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
        </div>

        <div class="detail-block">
          <div class="detail-title">ğŸ“Œ íšŒí•©</div>
          ${meets.length ? meets.map(it=>`
            <div class="small">â€¢ ${esc(it.title||"íšŒí•©")}${it.time?` Â· ${esc(it.time)}`:""}${it.importance?` Â· (${esc(it.importance)})`:""}</div>
          `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
        </div>
      `;

      $("dayDetailModalLayer").style.display = "flex";
    }
    window.closeDayDetailModal = () => { $("dayDetailModalLayer").style.display = "none"; };

    /* ===== ì¼ì •: ë‹¬ë ¥ ë Œë”(ëª¨ë°”ì¼ë„ ì¼ë°˜ ë‹¬ë ¥ ìœ ì§€) ===== */
    async function loadMonthCalendar(){
      const cal = $("monthCalendar");
      if (!cal) return;
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      await buildMonthCache();

      const chantMinMap = {};
      const actBranchMap = {};
      const meetCountMap = {};

      Object.entries(cachedDayData.chantsByDate).forEach(([k,arr])=>{
        chantMinMap[k] = arr.reduce((s,it)=> s+(Number(it.minutes)||0), 0);
      });

      Object.entries(cachedDayData.activitiesByDate).forEach(([k,arr])=>{
        const m = {};
        arr.forEach(it=>{
          const b = it.branch || "ë¯¸ì§€ì •";
          m[b] = (m[b]||0)+1;
        });
        actBranchMap[k] = m;
      });

      Object.entries(cachedDayData.meetingsByDate).forEach(([k,arr])=>{
        meetCountMap[k] = arr.length;
      });

      cal.className = "month-calendar";
      cal.innerHTML = "";

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      weekdays.forEach(w=>{
        const h=document.createElement("div");
        h.className="weekday";
        h.textContent=w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay();
      for(let i=0;i<firstDayWeek;i++){
        const blank=document.createElement("div");
        blank.className="day-cell";
        blank.style.visibility="hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();
      const mobileView = window.matchMedia && window.matchMedia("(max-width: 520px)").matches;

      for(let day=1; day<=lastDate; day++){
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        const chantMin = chantMinMap[dateKey] || 0;
        const branchCounts = actBranchMap[dateKey] || null;
        const meetCount = meetCountMap[dateKey] || 0;

        let actBadges = "";
        let hiddenCount = 0;

        if (branchCounts){
          const entries = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1]);
          const take = mobileView ? 1 : 2;
          const top = entries.slice(0,take);
          hiddenCount = Math.max(0, entries.length - take);
          actBadges = top.map(([b,c])=>`<span class="badge act-badge">${esc(b)}Ã—${c}</span>`).join("");
        }

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actBadges}
          ${meetCount ? `<span class="badge meet-badge">íšŒí•© ${meetCount}ê±´</span>` : ``}
          ${hiddenCount>0 ? `<div class="more-hint">â€¦ ë”ë³´ê¸°</div>` : ``}
        `;
        cell.onclick = ()=> openDayDetail(dateKey);
        cal.appendChild(cell);
      }
    }

    /* ===== ìŠ¤ì¿¨: ì´ë‹¬ ì¼ì • (ê´€ë¦¬ìë§Œ ì¶”ê°€/ìˆ˜ì •) ===== */
    async function loadSchoolMonthSchedule(){
      const list = $("schoolMonthScheduleList");
      if (!list) return;

      list.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      const snap = await getDocs(collection(db,"schoolSchedules"));
      const items = [];
      snap.forEach(d=>{
        const x = d.data();
        if (isInThisMonth(x.dateKey)) items.push({ id: d.id, ...x });
      });
      items.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (items.length === 0){
        list.innerHTML = `<div class="small">ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      list.innerHTML = "";
      items.forEach(it=>{
        const div=document.createElement("div");
        div.className="school-sched-item";
        div.innerHTML = `
          <div class="school-sched-top">
            <div class="school-sched-date">${esc(it.dateKey||"")}</div>
            ${isAdminMode() ? `<button class="mini-btn" style="padding:8px 10px;font-size:.85rem;" data-edit="${it.id}">ìˆ˜ì •</button>` : ``}
          </div>
          <div><strong>${esc(it.title||"")}</strong></div>
          ${it.desc ? `<div class="small" style="margin-top:4px;">${esc(it.desc)}</div>` : ``}
        `;
        list.appendChild(div);

        if (isAdminMode()){
          const btn = div.querySelector(`[data-edit="${it.id}"]`);
          if (btn){
            btn.onclick = (e)=>{ e.stopPropagation(); editSchoolSchedule(it.id, it); };
          }
        }
      });
    }

    window.addSchoolSchedule = async () => {
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ(YYYY-MM-DD)", todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", "") || "";

      await addDoc(collection(db,"schoolSchedules"),{
        dateKey,
        title: title.trim(),
        desc: desc.trim(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    };

    async function editSchoolSchedule(id, current){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ(YYYY-MM-DD)", current.dateKey || todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", current.title || "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", current.desc || "") || "";

      await updateDoc(doc(db,"schoolSchedules",id),{
        dateKey,
        title: title.trim(),
        desc: desc.trim(),
        updatedAt: serverTimestamp()
      });
      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    }

    /* ===== ìŠ¤ì¿¨: ì§„í–‰ë¥  + 20ì¹¸ ===== */
    async function loadThermometerForSchoolBranch(branch){
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";
      if (!branch){
        wrap.innerHTML = `<div class="small hint">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const confirmed = snap.docs.filter(d=> d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed/20)*100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${esc(branch)} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch){
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const bySlot = new Map();
      snap.forEach(docu=>{
        const data = docu.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: docu.ref, ...data });
      });

      for (let slot=1; slot<=20; slot++){
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        toggle.innerHTML = confirmed ? "âœ…" : `<span class="tri">â–²</span>`;

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        toggle.onclick = async ()=>{
          const newStatus = !(existing?.confirmed === true);
          toggle.innerHTML = newStatus ? "âœ…" : `<span class="tri">â–²</span>`;

          if (existing?.ref){
            await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db,"school"),{
              branch, slot,
              confirmed: newStatus,
              name: (input.value||"").trim(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value||"").trim() };
            bySlot.set(slot, existing);
          }

          await loadThermometerForSchoolBranch(branch);
        };

        input.addEventListener("blur", async ()=>{
          const newName = (input.value||"").trim();
          if (existing?.ref){
            await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
            existing.name = newName;
          } else {
            const newRef = await addDoc(collection(db,"school"),{
              branch, slot,
              confirmed:false,
              name:newName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed:false, name:newName };
            bySlot.set(slot, existing);
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);
        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ===== ê´€ë¦¬ì: í†µê³„/ë¦¬ì…‹ ===== */
    window.loadAdminStats = async ()=>{
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches){
        const [chantSnap, actSnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db,"chants"), where("branch","==",b))),
          getDocs(query(collection(db,"activities"), where("branch","==",b))),
          getDocs(query(collection(db,"school"), where("branch","==",b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d=> d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${esc(b)}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${actSnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    window.resetAllData = async ()=>{
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©/ìŠ¤ì¿¨ì¼ì •)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants","activities","school","meetings","schoolSchedules"];
      for (const col of cols){
        const snap = await getDocs(collection(db,col));
        for (const d of snap.docs){
          await deleteDoc(d.ref);
        }
      }
      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      showTab("home");
    };

    /* ===== ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸° ===== */
    function bindModalOutsideClose(){
      document.addEventListener("click",(e)=>{
        const m1=$("meetingModalLayer");
        if (m1 && m1.style.display==="flex" && e.target===m1) m1.style.display="none";
        const m2=$("dayDetailModalLayer");
        if (m2 && m2.style.display==="flex" && e.target===m2) m2.style.display="none";
      });
    }

    /* ===== ì „ì²´ ìƒˆë¡œê³ ì¹¨ ===== */
    async function refreshAll(){
      await loadTodaySummary();
      await loadHomeThermoCompact();
      await loadChantThermoDetailed();
      await loadMonthPlans();
      await loadMonthCalendar();
      await loadSchoolMonthSchedule();

      const selected = $("schoolBranchSelect").value;
      await loadThermometerForSchoolBranch(selected);
      await loadSchoolGrid(selected);

      applyAdminModeUI();
    }

    /* ===== ì´ˆê¸°í™” ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      applyAdminModeUI();
      bindModalOutsideClose();

      if (!nickname){
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillSelect($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillSelect($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillSelect($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      $("schoolBranchSelect").addEventListener("change", async (e)=>{
        const b = e.target.value;
        await loadThermometerForSchoolBranch(b);
        await loadSchoolGrid(b);
      });

      if (nickname) await refreshAll();
    });

    // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë‹¬ë ¥/í™ˆ ìš”ì•½ ì¬ë Œë”(ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± í‘œì‹œ ìµœì )
    window.addEventListener("resize", ()=>{
      clearTimeout(window.__rerT);
      window.__rerT = setTimeout(()=>{
        loadMonthCalendar();
      }, 180);
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>
    <div class="card">ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong></div>
    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint" style="margin-top:6px;">ì§€ë¶€ ì˜¨ë„ê³„ë¥¼ í´ë¦­í•˜ë©´ ì°½ì œ íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="homeThermoGrid" class="home-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <strong>ì°½ì œ ê¸°ë¡</strong>
      <div class="hint" style="margin-top:6px;">í•˜ë£¨ 3íšŒ ì œí•œ Â· ì§ì ‘ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©</div>
      <div style="height:10px;"></div>

      <div class="row">
        <select id="chantBranch"></select>
        <div style="display:grid; gap:8px;">
          <select id="chantMinutes">
            <option value="">ì‹œê°„ ì„ íƒ</option>
            <option value="10">10ë¶„</option>
            <option value="30">30ë¶„</option>
            <option value="60">60ë¶„</option>
          </select>
          <input id="chantMinutesCustom" type="number" min="1" step="1" placeholder="ì§ì ‘ ì…ë ¥(ë¶„) ì˜ˆ: 45" />
        </div>
      </div>

      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
    </div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint" style="margin-top:6px;">ì°½ì œ íƒ­ì—ì„œëŠ” ìƒì„¸/ìµœê·¼ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="chantThermoGrid" class="thermo-grid-wrap"></div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <strong>í™œë™ ê³„íš ê¸°ë¡</strong>
      <div class="hint" style="margin-top:6px;">í™œë™ 1íšŒëŠ” ëˆ„ì  ì˜¨ë„ê³„ ê¸°ì¤€ 2ì¹¸ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</div>
      <div style="height:10px;"></div>

      <select id="activityBranch"></select>
      <div style="height:10px;"></div>
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>
      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>
      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ê¸°ë¡ ğŸ”¥</button>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
          <div class="hint">ê¸°ë¡ëœ í™œë™ ê³„íšì„ ë‚ ì§œë³„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="hint">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì¼ì •(ì°½ì œ/í™œë™/íšŒí•©)ì´ ì—´ë¦½ë‹ˆë‹¤.</div>
        </div>
        <button class="mini-btn" onclick="openMeetingModal()">+ íšŒí•©</button>
      </div>
      <div id="monthCalendar" class="month-calendar"></div>
      <div class="small" style="margin-top:10px;">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œ ì „ì²´ ì¼ì • ë° ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¼ì • ì¶”ê°€/ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
        <button id="addSchoolScheduleBtn" class="mini-btn" onclick="addSchoolSchedule()" style="display:none;">+ ì¼ì • ì¶”ê°€</button>
      </div>
      <div id="schoolMonthScheduleList" class="school-sched-list"></div>
    </div>

    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="hint" style="margin-top:8px;">â–²(ë¯¸í™•ì •) / âœ…(í™•ì •) Â· ì´ë¦„ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì €ì¥</div>
    </div>

    <div class="card">
      <div id="schoolThermoWrap"></div>
      <div style="height:10px;"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œ ON ì‹œ ë¶€ì—° ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <button id="adminModeBtn" class="mini-btn" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ON</button>
      </div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
    </div>
  </div>

  <!-- MEETING MODAL -->
  <div id="meetingModalLayer" class="modal-layer">
    <div class="modal">
      <h3>íšŒí•© ì¼ì • ì¶”ê°€</h3>
      <div class="grid">
        <input id="meetDate" placeholder="íšŒí•© ì¼ì •(YYYY-MM-DD)" />
        <input id="meetTitle" placeholder="íšŒí•©ëª…" />
        <input id="meetTime" placeholder="ì‹œê°„(ì˜ˆ: 19:30)" />
        <select id="meetImportance">
          <option value="ë‚®ìŒ">ì¤‘ìš”ë„: ë‚®ìŒ</option>
          <option value="ë³´í†µ" selected>ì¤‘ìš”ë„: ë³´í†µ</option>
          <option value="ë†’ìŒ">ì¤‘ìš”ë„: ë†’ìŒ</option>
        </select>
      </div>
      <div class="actions">
        <button class="cancel" onclick="closeMeetingModal()">ì·¨ì†Œ</button>
        <button class="ok" onclick="saveMeetingFromModal()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- DAY DETAIL MODAL -->
  <div id="dayDetailModalLayer" class="modal-layer">
    <div class="modal">
      <h3 id="dayDetailTitle">ì¼ì • ìƒì„¸</h3>
      <div id="dayDetailBody"></div>
      <div class="actions">
        <button class="cancel" onclick="closeDayDetailModal()">ë‹«ê¸°</button>
        <button class="ok" onclick="closeDayDetailModal()">í™•ì¸</button>
      </div>
    </div>
  </div>
</body>
</html>
