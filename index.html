<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase SDK (v9 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* ğŸ”¥ Firebase ì„¤ì • */
    const firebaseConfig = { 
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ğŸ” ê´€ë¦¬ì ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ë³´í˜¸ìš©) */
    const ADMIN_PASSWORD = "admin-1234";

    window.db = db;
    window.ADMIN_PASSWORD = ADMIN_PASSWORD;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: url("https://images.unsplash.com/photo-1505483531331-8325e0ed3f6e") center / cover no-repeat fixed;
      color: #222;
    }
    header {
      text-align: center;
      padding: 16px;
      font-size: 22px;
      font-weight: bold;
      background: rgba(255,255,255,0.85);
    }
    nav {
      display: flex;
      justify-content: space-around;
      background: rgba(255,255,255,0.9);
      padding: 8px 0;
      flex-wrap: wrap;
    }
    nav button {
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      margin: 4px;
    }
    section {
      display: none;
      padding: 16px;
      background: rgba(255,255,255,0.88);
      min-height: 70vh;
    }
    section.active { display: block; }

    .card {
      background: white;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
    }

    /* ğŸŒ¡ ì˜¨ë„ê³„ */
    .thermo-wrap {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
      text-align: center;
    }
    .thermometer {
      width: 40px;
      height: 180px;
      border: 3px solid #aaa;
      border-radius: 20px;
      margin: 8px auto;
      display: flex;
      flex-direction: column-reverse;
      overflow: hidden;
      background: #f5f5f5;
    }
    .thermo-fill {
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, #ff4d4d, #ffd966, #66ccff);
      transition: height 0.6s;
    }

    /* ğŸ“… ë‹¬ë ¥ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      text-align: center;
      font-size: 12px;
    }
    .day {
      background: #f2f2f2;
      border-radius: 6px;
      padding: 6px;
    }
    .day strong { display:block; }

    input, select, button {
      padding: 8px;
      margin-top: 6px;
      width: 100%;
    }

    .rank { font-size: 14px; margin: 4px 0; }
    .hidden { display:none; }
  </style>
</head>

<body>

<header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

<nav>
  <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
  <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
  <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
  <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
  <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
  <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
</nav>

<!-- ğŸŒ¸ HOME -->
<section id="home" class="active">
  <div class="card">
    <h3>ğŸŒ¸ ì§€ë¶€ë³„ ì˜¨ë„ê³„</h3>
    <div class="thermo-wrap" id="branchThermos"></div>
  </div>

  <div class="card">
    <h3>ğŸ† ì „ì²´ ë­í‚¹ (ìƒìœ„ 5)</h3>
    <div id="ranking"></div>
  </div>
</section>

<!-- ğŸŒ± CHANT -->
<section id="chant">
  <div class="card">
    <h3>ğŸŒ± ì°½ì œ ê¸°ë¡</h3>
    <div id="nicknameBox">
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <button onclick="saveNickname()">ë‹‰ë„¤ì„ ì €ì¥</button>
    </div>
    <p id="savedNickname" class="hidden"></p>

    <select id="branchSelect">
      <option value="">ì§€ë¶€ ì„ íƒ</option>
      <option>ë‹¬ë¹„</option><option>ìƒì¸</option><option>ì›ë•</option>
      <option>ëŒ€ê³¡</option><option>ì›”ë°°</option><option>ìœ ì²œ</option>
      <option>ì§„ì²œ</option><option>ì˜ë‚¨</option><option>ì˜¥í¬</option><option>í™”ì›</option>
    </select>
    <select id="timeSelect">
      <option value="">ì‹œê°„ ì„ íƒ</option>
      <option value="10">10ë¶„</option>
      <option value="30">30ë¶„</option>
      <option value="60">60ë¶„</option>
    </select>
    <button onclick="saveChant()">ì €ì¥</button>
    <p id="chantMsg"></p>
  </div>
</section>

<!-- ğŸ”¥ ACTIVITY -->
<section id="activity">
  <div class="card">
    <h3>ğŸ”¥ í™œë™ ê¸°ë¡</h3>
    <input id="activityTitle" placeholder="í™œë™ ë‚´ìš©" />
    <select id="activityBranch">
      <option value="">ì§€ë¶€ ì„ íƒ</option>
      <option>ë‹¬ë¹„</option><option>ìƒì¸</option><option>ì›ë•</option>
      <option>ëŒ€ê³¡</option><option>ì›”ë°°</option><option>ìœ ì²œ</option>
      <option>ì§„ì²œ</option><option>ì˜ë‚¨</option><option>ì˜¥í¬</option><option>í™”ì›</option>
    </select>
    <button onclick="saveActivity()">í™œë™ ì €ì¥</button>
    <p id="activityMsg"></p>
  </div>
</section>

<!-- ğŸ“… SCHEDULE -->
<section id="schedule">
  <div class="card">
    <h3>ğŸ“… ì´ë²ˆ ë‹¬ ì°½ì œ ë‹¬ë ¥</h3>
    <div class="calendar" id="calendar"></div>
  </div>
</section>

<!-- ğŸ“ SCHOOL -->
<section id="school">
  <div class="card">
    <h3>ğŸ“ ìŠ¤ì¿¨ ëª…ë‹¨ (ì§€ë¶€ë³„ 20ëª…)</h3>
    <p>â€» â–³ ë„ì „ì¤‘ / âœ… í™•ë‹µ</p>
    <p>â€» ê´€ë¦¬ì ì—†ì´ ëˆ„êµ¬ë‚˜ ìˆ˜ì • ê°€ëŠ¥</p>
  </div>
</section>

<!-- ğŸ” ADMIN -->
<section id="admin">
  <div class="card">
    <h3>ğŸ” ê´€ë¦¬ì íŒ¨ë„</h3>
    <input id="adminPw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
    <button onclick="adminLogin()">ë¡œê·¸ì¸</button>

    <div id="adminControls" class="hidden">
      <hr/>
      <p>âš  ì›”ë³„ ì´ˆê¸°í™” (ì‹¤ì œ ì‚­ì œ ì—†ìŒ, isArchived ì²˜ë¦¬)</p>
      <label><input type="checkbox" id="confirmCheck" /> ì´í•´í–ˆìŠµë‹ˆë‹¤</label>
      <input id="confirmText" placeholder="ì´ˆê¸°í™”í•©ë‹ˆë‹¤ ì…ë ¥" />
      <button onclick="monthlyReset()">ì›”ë³„ ì´ˆê¸°í™”</button>
    </div>
  </div>
</section>

<script type="module">
  import { collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const db = window.db;
  const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];

  window.showTab = (id) => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  };

  // ğŸ”‘ ë‹‰ë„¤ì„
  window.saveNickname = () => {
    const nick = document.getElementById("nicknameInput").value.trim();
    if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
    localStorage.setItem("nickname", nick);
    applyNicknameUI();
  };

  function applyNicknameUI() {
    const nick = localStorage.getItem("nickname");
    if (nick) {
      document.getElementById("nicknameBox").classList.add("hidden");
      const p = document.getElementById("savedNickname");
      p.innerText = `í˜„ì¬ ë‹‰ë„¤ì„: ${nick}`;
      p.classList.remove("hidden");
    }
  }

  // ğŸŒ± ì°½ì œ (1ì¼ 3íšŒ ì œí•œ)
  window.saveChant = async () => {
    const nickname = localStorage.getItem("nickname");
    const branch = document.getElementById("branchSelect").value;
    const minutes = Number(document.getElementById("timeSelect").value);
    const msg = document.getElementById("chantMsg");

    if (!nickname || !branch || !minutes) {
      msg.innerText = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”";
      return;
    }

    const today = new Date().toISOString().slice(0,10);
    const q = query(collection(db, "chants"), where("nickname","==",nickname), where("dateKey","==",today));
    const snap = await getDocs(q);
    if (snap.size >= 3) {
      msg.innerText = "í•˜ë£¨ ìµœëŒ€ 3íšŒê¹Œì§€ë§Œ ê¸°ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤";
      return;
    }

    await addDoc(collection(db, "chants"), {
      nickname, branch, minutes,
      blocks: minutes / 10,
      dateKey: today,
      createdAt: serverTimestamp(),
      isArchived: false
    });

    msg.innerText = "ì €ì¥ ì™„ë£Œ ğŸŒ±";
    loadHome();
    loadCalendar();
  };

  // ğŸ”¥ í™œë™ (1íšŒ = 2ì¹¸)
  window.saveActivity = async () => {
    const nickname = localStorage.getItem("nickname");
    const branch = document.getElementById("activityBranch").value;
    const title = document.getElementById("activityTitle").value.trim();
    const msg = document.getElementById("activityMsg");

    if (!nickname || !branch || !title) {
      msg.innerText = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”";
      return;
    }

    await addDoc(collection(db, "activities"), {
      nickname, branch, title,
      blocks: 2,
      createdAt: serverTimestamp(),
      isArchived: false
    });

    msg.innerText = "í™œë™ ì €ì¥ ì™„ë£Œ ğŸ”¥";
    loadHome();
  };

  // ğŸ” ê´€ë¦¬ì
  window.adminLogin = () => {
    const pw = document.getElementById("adminPw").value;
    if (pw === window.ADMIN_PASSWORD) {
      document.getElementById("adminControls").classList.remove("hidden");
      alert("ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ");
    } else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  };

  window.monthlyReset = () => {
    if (!document.getElementById("confirmCheck").checked) return;
    if (document.getElementById("confirmText").value !== "ì´ˆê¸°í™”í•©ë‹ˆë‹¤") return;
    alert("â€» ì‹¤ì œ ìš´ì˜ ì‹œ Cloud Functionìœ¼ë¡œ isArchived ì²˜ë¦¬ ê¶Œì¥");
  };

  async function loadHome() {
    const thermoWrap = document.getElementById("branchThermos");
    const rankingBox = document.getElementById("ranking");
    thermoWrap.innerHTML = "";
    rankingBox.innerHTML = "";

    const chantSnap = await getDocs(query(collection(db, "chants"), where("isArchived","==",false)));
    const actSnap = await getDocs(query(collection(db, "activities"), where("isArchived","==",false)));

    const branchSum = {};
    const userSum = {};

    chantSnap.forEach(d => {
      const { branch, blocks, nickname } = d.data();
      branchSum[branch] = (branchSum[branch] || 0) + blocks;
      userSum[nickname] = (userSum[nickname] || 0) + blocks;
    });

    actSnap.forEach(d => {
      const { branch, blocks, nickname } = d.data();
      branchSum[branch] = (branchSum[branch] || 0) + blocks;
      userSum[nickname] = (userSum[nickname] || 0) + blocks;
    });

    branches.forEach(b => {
      const blocks = branchSum[b] || 0;
      const percent = Math.min((blocks / 300) * 100, 100);
      const div = document.createElement("div");
      div.innerHTML = `
        <div>${b}</div>
        <div class="thermometer"><div class="thermo-fill" style="height:${percent}%"></div></div>
        <small>${blocks * 10}ë¶„</small>
      `;
      thermoWrap.appendChild(div);
    });

    Object.entries(userSum)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,5)
      .forEach(([name,blocks],i)=>{
        const p = document.createElement("div");
        p.className = "rank";
        p.innerText = `${i+1}. ${name} - ${blocks*10}ë¶„`;
        rankingBox.appendChild(p);
      });
  }

  async function loadCalendar() {
    const cal = document.getElementById("calendar");
    cal.innerHTML = "";
    const snap = await getDocs(query(collection(db, "chants"), where("isArchived","==",false)));
    const map = {};

    snap.forEach(d => {
      const { dateKey, minutes } = d.data();
      map[dateKey] = (map[dateKey] || 0) + minutes;
    });

    Object.keys(map).forEach(date => {
      const div = document.createElement("div");
      div.className = "day";
      div.innerHTML = `<strong>${date.slice(-2)}</strong>${map[date]}ë¶„`;
      cal.appendChild(div);
    });
  }

  applyNicknameUI();
  loadHome();
  loadCalendar();
</script>

</body>
</html>
