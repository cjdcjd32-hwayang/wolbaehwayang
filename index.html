<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.35rem;
      font-weight:800;
    }

    nav{
      display:flex;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      gap:6px;
      flex-wrap:wrap;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
    }
    nav button{
      border:none;
      background:none;
      font-size:1rem;
      cursor:pointer;
      padding:8px 12px;
      border-radius:12px;
      touch-action: manipulation;
    }
    nav button:hover{ background:rgba(0,0,0,.05); }

    section{display:none;padding:16px}
    section.active{display:block}

    .card{
      background:rgba(255,255,255,.92);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }

    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:9999;
    }

    /* ê³µí†µ ì…ë ¥ */
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      background:#fff;
      font-size: 1rem;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
      touch-action: manipulation;
    }
    .btn.secondary{background:#444}
    .small{font-size:.9rem;opacity:.85}

    /* íŒíŠ¸(ë¶€ì—°ì„¤ëª…): ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ */
    .hint{ display:none; }
    body.admin .hint{ display:block; }

    /* ===== í™ˆ ì˜¨ë„ê³„ (ìš”ì²­: 4ê°œ/í–‰, ì´ë¦„+ì˜¨ë„ê³„ë§Œ) ===== */
    .home-thermo-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .home-thermo-item{
      background:#fff;
      border-radius:16px;
      padding:12px 10px;
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .home-thermo-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .home-branch-name{
      font-weight:900;
      font-size:1rem;
      letter-spacing:-0.2px;
    }
    .home-temp{
      font-weight:900;
      font-size:.92rem;
      opacity:.92;
      margin-top:-4px;
    }

    /* ===== ì°½ì œ íƒ­: ê¸°ì¡´ ìƒì„¸ ì˜¨ë„ê³„(3ì—´ ê·¸ë£¹ ìœ ì§€) ===== */
    .thermo-grid-wrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .thermo-col{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 0;
    }

    .branch-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 92px;
      gap: 10px;
      align-items: stretch;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .branch-thermo-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .branch-thermo-title{
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .branch-thermo-meta{
      font-size: .88rem;
      opacity: .86;
      line-height: 1.35;
    }
    .recent-list{
      margin-top:8px;
      font-size:.82rem;
      opacity:.90;
      line-height:1.35;
    }
    .recent-item{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:2px 0;
    }

    /* ===== ì˜¨ë„ê³„ í”„ë ˆì„ ===== */
    .thermo-frame{
      width: 92px;
      height: 252px;
      position: relative;
      display:flex;
      align-items: flex-start;
      justify-content: center;
      box-sizing: border-box;
    }
    .tube{
      width: 60px;
      height: 192px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 2px solid rgba(0,0,0,.12);
      position: relative;
      z-index: 2;
      overflow:hidden;
      box-sizing: border-box;
      padding: 8px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }

    /* ê²©ì 300ì¹¸(20x15) */
    .tube-grid{
      width: 100%;
      height: 100%;
      display:grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.05);
      border-radius: 12px;
      padding: 2px;
      box-sizing: border-box;
    }
    .cell{
      background: rgba(255,255,255,.60);
      border-radius: 1px;
    }

    .bulb{
      width: 82px;
      height: 82px;
      border-radius: 999px;
      background: rgba(255,255,255,.90);
      border: 2px solid rgba(0,0,0,.12);
      position:absolute;
      bottom: 0;
      z-index: 1;
      overflow:hidden;
      box-sizing:border-box;
    }
    .bulb-fill{
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      opacity: 0;
      transform: scale(.92);
      transition: opacity .25s ease, transform .25s ease;
      background: radial-gradient(circle at 30% 30%, #7dd3fc 0%, #fde047 55%, #ef4444 100%);
    }
    .bulb.filled .bulb-fill{
      opacity: 1;
      transform: scale(1);
    }

    /* 3ì—´ í…Œë§ˆ(í”„ë ˆì„ë§Œ ìœ ì§€) */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }

    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }

    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* í™ˆ ì „ìš© ì†Œí˜• ì˜¨ë„ê³„ */
    .thermo-mini .thermo-frame{ width: 88px; height: 234px; }
    .thermo-mini .tube{ width: 56px; height: 176px; padding: 7px; }
    .thermo-mini .bulb{ width: 76px; height: 76px; }
    .thermo-mini .tube-grid{ border-radius: 12px; }

    /* ===== ì¼ì • íƒ­ ===== */
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-size:.9rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .mini-btn:hover{ opacity:.92; }

    .plan-list{ display:grid; gap:10px; }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{ font-weight:900; margin-bottom:4px; }
    .plan-meta{ font-size:.86rem; opacity:.88; }

    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:800;
      text-align:center;
      opacity:.8;
      padding: 4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:82px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.25;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .day-cell:hover{ box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .day-num{
      font-weight:900;
      font-size:.95rem;
      margin-bottom:4px;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
    }
    .meet-badge{ background:rgba(194,24,91,.10); }
    .act-badge{ background:rgba(0, 128, 255, .10); }

    /* ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸í˜• ë‹¬ë ¥(ìš”ì²­: ì˜ë¦¼ í•´ê²°) */
    .calendar-list{
      display:grid;
      gap:10px;
    }
    .day-row{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
    }
    .day-row:hover{ box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .day-row-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .day-row-date{ font-weight:900; }
    .day-row-badges{ display:flex; flex-wrap:wrap; gap:6px; }

    /* ===== ìŠ¤ì¿¨ íƒ­ ===== */
    .school-wrap{display:grid;gap:12px}

    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      box-sizing:border-box;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .slot-num{
      font-weight:900;
      font-size:.9rem;
      opacity:.8;
    }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.05rem;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: 38px;
      touch-action: manipulation;
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }
    .tri{
      color:#9e9e9e;
      font-weight:900;
      line-height:1;
    }

    /* ìŠ¤ì¿¨ ì…ë ¥ì¹¸ ì—°ë…¸ë‘ ê³ ì • */
    .slot-input{
      width:100%;
      padding:12px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.95rem;
      background: #FFF6BF;
    }

    /* ìŠ¤ì¿¨ ì§„í–‰ë¥  ë°” */
    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:700;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }

    /* ===== ëª¨ë‹¬(ê³µìš©) ===== */
    .modal-layer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:9998;
      padding: 14px;
      box-sizing: border-box;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(0,0,0,.08);
      max-height: 80vh;
      overflow:auto;
    }
    .modal h3{
      margin:0 0 10px 0;
      font-size:1.05rem;
    }
    .modal .grid{
      display:grid;
      gap:10px;
    }
    .modal .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .modal .actions button{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-size:1rem;
      touch-action: manipulation;
    }
    .modal .actions .cancel{ background:#eee; }
    .modal .actions .ok{ background:#111; color:#fff; }

    /* ì¼ì • ìƒì„¸ */
    .detail-block{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      background:#fff;
      line-height:1.4;
    }
    .detail-title{ font-weight:900; margin-bottom:6px; }

    /* ìŠ¤ì¿¨ ì¼ì • */
    .school-sched-list{ display:grid; gap:10px; }
    .school-sched-item{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      line-height:1.35;
    }
    .school-sched-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .school-sched-date{ font-weight:900; }

    /* ===== ë°˜ì‘í˜• ===== */
    @media (max-width: 980px){
      .home-thermo-grid{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 720px){
      .home-thermo-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      header{ font-size:1.15rem; padding:14px; }
      section{ padding:12px; }
      .card{ padding:12px; margin-bottom:12px; }

      nav{ justify-content:flex-start; }
      nav button{ font-size:.95rem; padding:8px 10px; }

      .row{ grid-template-columns: 1fr; }
      .thermo-grid-wrap{ grid-template-columns: 1fr; } /* ì°½ì œ íƒ­ ìƒì„¸ ì˜¨ë„ê³„ëŠ” ëª¨ë°”ì¼ì—ì„œ 1ì—´ */
      .branch-thermo-card{ grid-template-columns: 1fr 84px; }

      #schoolGrid{ grid-template-columns: repeat(2, 1fr); }
      .modal{ max-height: 86vh; }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);

    const nicknameKey = "wolbaehwayang_nickname";
    let nickname = localStorage.getItem(nicknameKey) || "";

    /* ê´€ë¦¬ì ëª¨ë“œ */
    const adminModeKey = "wol_admin_mode";
    const adminPw = "adminPw";
    function isAdminMode(){ return localStorage.getItem(adminModeKey) === "1"; }
    function applyAdminModeUI(){
      document.body.classList.toggle("admin", isAdminMode());
      const btn = document.getElementById("adminModeBtn");
      if (btn) btn.textContent = isAdminMode() ? "ê´€ë¦¬ì ëª¨ë“œ OFF" : "ê´€ë¦¬ì ëª¨ë“œ ON";
      const addBtn = document.getElementById("addSchoolScheduleBtn");
      if (addBtn) addBtn.style.display = isAdminMode() ? "inline-block" : "none";
    }
    window.toggleAdminMode = () => {
      if (!isAdminMode()) {
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (pw !== adminPw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        localStorage.setItem(adminModeKey, "1");
      } else {
        localStorage.removeItem(adminModeKey);
      }
      applyAdminModeUI();
      loadSchoolMonthSchedule();
    };

    /* ëˆ„ì  ì˜¨ë„ê³„ ê¸°ì¤€ */
    const TOTAL_CELLS = 300;         // íŠœë¸Œ ê²©ì ì¹¸ ìˆ˜(20x15)
    const CHANT_CELL_MIN = 10;       // 1ì¹¸=10ë¶„
    const ACTIVITY_CELL = 2;         // 2ì¹¸=í™œë™ 1íšŒ
    const BULB_START_CELLS = 12;     // ë²Œë¸Œ ë¨¼ì € ì°¨ëŠ” êµ¬ê°„(UX)
    const RECENT_PER_BRANCH = 3;

    /* ì°½ì œ íƒ­: ê¸°ì¡´ 3ì—´ ê·¸ë£¹ */
    const THERMO_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    /* ì¼ì •(ì´ë‹¬) */
    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth();
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`;

    const $ = (id) => document.getElementById(id);
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function isInThisMonth(dateKey){
      return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix);
    }
    function isMobileView(){
      return window.matchMedia && window.matchMedia("(max-width: 520px)").matches;
    }

    function fillBranchOptions(selectEl, placeholder="ì§€ë¶€ ì„ íƒ") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        selectEl.appendChild(opt);
      });
    }

    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
      window.scrollTo({ top: 0, behavior: "auto" });
    };

    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    function goToChantWithBranch(branch){
      window.showTab("chant");
      const sel = $("chantBranch");
      if (sel) sel.value = branch;
    }

    /* ===== (ìš”ì²­ 2) ì°½ì œ ì‹œê°„: ì„ íƒ + ì§ì ‘ì…ë ¥ ===== */
    function getChantMinutes(){
      const custom = Number($("chantMinutesCustom").value);
      const preset = Number($("chantMinutes").value);
      const minutes = (custom && custom > 0) ? custom : preset;
      return minutes;
    }

    /* ===== ê¸°ë¡ ì €ì¥ ===== */
    window.saveChant = async () => {
      const minutes = getChantMinutes();
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì…ë ¥(ì„ íƒ)í•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(collection(db, "chants"), where("nickname", "==", nickname), where("dateKey", "==", todayKey));
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "chants"), {
        nickname, branch, minutes,
        blocks: minutes / 10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived: false
      });

      // ì…ë ¥ UX: ì»¤ìŠ¤í…€ ì…ë ¥ì€ ìœ ì§€(ì›í•˜ì‹œë©´ ì €ì¥ í›„ ì´ˆê¸°í™”ë„ ê°€ëŠ¥)
      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      window.showTab("home");
    };

    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "activities"), {
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê³„íš ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      window.showTab("schedule");
    };

    /* ===== ì˜¤ëŠ˜ ìš”ì•½ ===== */
    async function loadTodaySummary() {
      const chantSnap = await getDocs(query(collection(db, "chants"), where("dateKey", "==", todayKey)));
      const activitySnap = await getDocs(query(collection(db, "activities"), where("dateKey", "==", todayKey)));

      let totalMin = 0;
      let detail = "";

      chantSnap.forEach(d => {
        const { nickname: n, branch, minutes } = d.data();
        totalMin += Number(minutes) || 0;
        detail += `ğŸŒ± ${branch} - ${minutes}ë¶„ (${n})<br>`;
      });

      activitySnap.forEach(d => {
        const { branch, subject, target } = d.data();
        totalMin += 20;
        detail += `ğŸ”¥ ${branch} - ${subject} â†’ ${target} (20ë¶„)<br>`;
      });

      $("todayTotal").innerHTML = `${totalMin}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* ===== (ìš”ì²­ 1) ì˜¨ë„ ìƒ‰ìƒ: ê³µí†µ ë¸”ë£¨â†’ì˜ë¡œâ†’ë ˆë“œ ê·¸ë¼ë°ì´ì…˜ ===== */
    function lerp(a,b,t){ return a + (b-a)*t; }
    function rgb(r,g,b){ return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
    function heatColor(t){
      // t=0(ì•„ë˜/ì°¨ê°€ì›€) -> íŒŒë‘, t=0.5 -> ë…¸ë‘, t=1 -> ë¹¨ê°•
      // íŒŒë‘(59,130,246) -> ë…¸ë‘(253,224,71) -> ë¹¨ê°•(239,68,68)
      const b1 = {r:59,g:130,b:246};
      const y  = {r:253,g:224,b:71};
      const r2 = {r:239,g:68,b:68};

      if (t <= 0.5){
        const k = t / 0.5;
        return rgb(lerp(b1.r,y.r,k), lerp(b1.g,y.g,k), lerp(b1.b,y.b,k));
      } else {
        const k = (t-0.5) / 0.5;
        return rgb(lerp(y.r,r2.r,k), lerp(y.g,r2.g,k), lerp(y.b,r2.b,k));
      }
    }

    function approxTempC(cells){
      // 0~100Â°Cë¡œ ë‹¨ìˆœ í™˜ì‚° (ìš”ì²­: ëŒ€ëµì  í˜„ì¬ ì˜¨ë„ í‘œì‹œ)
      const ratio = Math.max(0, Math.min(1, (cells || 0) / TOTAL_CELLS));
      return Math.round(ratio * 100);
    }

    /* ===== ëˆ„ì  ì§‘ê³„(ì¹¸ ê¸°ì¤€) ===== */
    async function computeCumulativeByBranchCells() {
      const chantMinByBranch = {};
      const actCountByBranch = {};
      const cellsByBranch = {};
      const recentByBranch = {};

      branches.forEach(b => {
        chantMinByBranch[b]=0;
        actCountByBranch[b]=0;
        cellsByBranch[b]=0;
        recentByBranch[b]=[];
      });

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities")),
        getDocs(collection(db, "meetings"))
      ]);

      chantSnap.forEach(d => {
        const { branch, minutes, dateKey } = d.data();
        if (!branch || chantMinByBranch[branch] == null) return;
        const m = Number(minutes) || 0;
        chantMinByBranch[branch] += m;
        cellsByBranch[branch] += Math.floor(m / CHANT_CELL_MIN);
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸŒ± ${m}ë¶„`);
      });

      actSnap.forEach(d => {
        const { branch, subject, target, dateKey } = d.data();
        if (!branch || actCountByBranch[branch] == null) return;
        actCountByBranch[branch] += 1;
        cellsByBranch[branch] += ACTIVITY_CELL;
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸ”¥ ${subject || ""}â†’${target || ""}`);
      });

      // íšŒí•©: ì§€ë¶€ë³„ ë¶„ë¦¬ ì—†ì´ ìµœê·¼ ê¸°ë¡ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í¬í•¨(ì›í•˜ì‹œë©´ ìŠ¤ì¿¨/ì¼ì •ìª½ë§Œ ë…¸ì¶œë¡œ ë³€ê²½ ê°€ëŠ¥)
      meetSnap.forEach(d => {
        const { dateKey, title, time, importance } = d.data();
        if (!dateKey) return;
        const imp = importance ? `(${importance})` : "";
        const tt = time ? ` ${time}` : "";
        const line = `${dateKey.slice(5)} ğŸ“Œ íšŒí•© ${title || "íšŒí•©"}${tt}${imp}`;
        branches.forEach(b => recentByBranch[b].push(line));
      });

      branches.forEach(b => {
        recentByBranch[b].sort((a, c) => (a < c ? 1 : -1));
      });

      return { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch };
    }

    function buildRecentHTML(items){
      const top = (items || []).slice(0, RECENT_PER_BRANCH);
      if (top.length === 0) return `<div class="recent-list"><div class="recent-item">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div></div>`;
      return `
        <div class="recent-list">
          ${top.map(x=>`<div class="recent-item">â€¢ ${escapeHtml(x)}</div>`).join("")}
        </div>
      `;
    }

    function buildTubeGridHTML(filledCells){
      const total = TOTAL_CELLS;
      const startFilledPos = total - filledCells + 1;

      let html = `<div class="tube-grid">`;
      for (let pos=1; pos<=total; pos++){
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled){
          html += `<div class="cell"></div>`;
        } else {
          // ì•„ë˜ê°€ íŒŒë‘(ì°¨ê°€ì›€) / ìœ„ê°€ ë¹¨ê°•(ëœ¨ê±°ì›€)
          // posê°€ í´ìˆ˜ë¡ ì•„ë˜, posê°€ ì‘ì„ìˆ˜ë¡ ìœ„
          const tHot = (total - pos) / (total - 1); // 0=ì•„ë˜(íŒŒë‘) ... 1=ìœ„(ë¹¨ê°•)
          html += `<div class="cell" style="background:${heatColor(tHot)};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    function computeBulbAndTube(cells){
      const bulbFilled = cells > 0;
      const tubeCells = Math.max(0, cells - BULB_START_CELLS);
      const tubeCap = Math.max(1, TOTAL_CELLS - BULB_START_CELLS);
      const scaled = Math.min(TOTAL_CELLS, Math.floor((tubeCells / tubeCap) * TOTAL_CELLS));
      return { bulbFilled, tubeFilledCells: scaled };
    }

    /* ===== í™ˆ ì „ìš©: ê°„ì†Œ UI(ì´ë¦„+ì˜¨ë„ê³„+ì˜¨ë„í‘œì‹œ) / 4ê°œ/í–‰ ===== */
    async function loadHomeThermoCompact(){
      const container = $("homeThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { cellsByBranch } = await computeCumulativeByBranchCells();

      container.innerHTML = "";
      branches.forEach(branch => {
        const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
        const { bulbFilled, tubeFilledCells } = computeBulbAndTube(cells);
        const temp = approxTempC(cells);

        const item = document.createElement("div");
        item.className = "home-thermo-item thermo-mini";
        item.innerHTML = `
          <div class="home-branch-name">${escapeHtml(branch)}</div>

          <div class="thermo-frame">
            <div class="tube">
              ${buildTubeGridHTML(tubeFilledCells)}
            </div>
            <div class="bulb ${bulbFilled ? "filled" : ""}">
              <div class="bulb-fill"></div>
            </div>
          </div>

          <div class="home-temp">${temp}Â°C</div>
        `;
        item.onclick = () => goToChantWithBranch(branch);
        container.appendChild(item);
      });
    }

    /* ===== ì°½ì œ íƒ­: ê¸°ì¡´ ìƒì„¸ ì˜¨ë„ê³„(3ì—´ ê·¸ë£¹) ===== */
    function renderChantThermometers(){
      return async () => {
        const container = $("chantThermoGrid");
        if (!container) return;

        container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

        const { chantMinByBranch, actCountByBranch, cellsByBranch, recentByBranch } =
          await computeCumulativeByBranchCells();

        container.innerHTML = "";

        THERMO_COLUMNS.forEach(colDef => {
          const col = document.createElement("div");
          col.className = `thermo-col ${colDef.theme}`;

          colDef.branches.forEach(branch => {
            const chantMin = chantMinByBranch[branch] || 0;
            const actCnt = actCountByBranch[branch] || 0;
            const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);

            const { bulbFilled, tubeFilledCells } = computeBulbAndTube(cells);
            const temp = approxTempC(cells);

            const card = document.createElement("div");
            card.className = "branch-thermo-card";
            card.innerHTML = `
              <div>
                <div class="branch-thermo-title">
                  <span>${escapeHtml(branch)}</span>
                  <span class="small">${cells}/${TOTAL_CELLS}ì¹¸ Â· ${temp}Â°C</span>
                </div>

                <div class="branch-thermo-meta">
                  ëˆ„ì : <strong>${cells}</strong>ì¹¸<br>
                  ì°½ì œ: ${chantMin}ë¶„ Â· í™œë™: ${actCnt}íšŒ<br>
                  ê¸°ì¤€: 1ì¹¸=${CHANT_CELL_MIN}ë¶„ Â· 2ì¹¸=í™œë™ 1íšŒ
                </div>

                ${buildRecentHTML(recentByBranch[branch] || [])}
                <div class="hint small" style="margin-top:8px;">í´ë¦­í•˜ë©´ ì§€ë¶€ê°€ ì„ íƒë©ë‹ˆë‹¤.</div>
              </div>

              <div class="thermo-frame ${colDef.theme}">
                <div class="tube">
                  ${buildTubeGridHTML(tubeFilledCells)}
                </div>
                <div class="bulb ${bulbFilled ? "filled" : ""}">
                  <div class="bulb-fill"></div>
                </div>
              </div>
            `;
            card.onclick = () => {
              const sel = $("chantBranch");
              if (sel) sel.value = branch;
            };
            col.appendChild(card);
          });

          container.appendChild(col);
        });
      };
    }
    const loadChantThermo = renderChantThermometers();

    /* ===== ì¼ì • íƒ­: í™œë™ ë¦¬ìŠ¤íŠ¸ ===== */
    async function loadMonthPlans() {
      const container = $("monthPlanList");
      if (!container) return;
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const actSnap = await getDocs(collection(db, "activities"));
      const plans = [];
      actSnap.forEach(d => {
        const data = d.data();
        if (isInThisMonth(data.dateKey)) plans.push(data);
      });
      plans.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (plans.length === 0) {
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ê¸°ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p => {
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">${escapeHtml(p.dateKey || "")} Â· ${escapeHtml(p.branch || "")}</div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${escapeHtml(p.subject || "")}</strong> â†’ ëŒ€ìƒì: <strong>${escapeHtml(p.target || "")}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${escapeHtml(p.method)}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    /* ===== íšŒí•© ëª¨ë‹¬ ===== */
    window.openMeetingModal = () => {
      $("meetDate").value = todayKey;
      $("meetTitle").value = "";
      $("meetTime").value = "";
      $("meetImportance").value = "ë³´í†µ";
      $("meetingModalLayer").style.display = "flex";
    };
    window.closeMeetingModal = () => { $("meetingModalLayer").style.display = "none"; };

    window.saveMeetingFromModal = async () => {
      const dateKey = $("meetDate").value.trim();
      const title = $("meetTitle").value.trim();
      const time = $("meetTime").value.trim();
      const importance = $("meetImportance").value;

      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("íšŒí•© ì¼ì •(ë‚ ì§œ) í˜•ì‹ ì˜¤ë¥˜. ì˜ˆ: 2026-01-16");
      if (!title) return alert("íšŒí•©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

      await addDoc(collection(db, "meetings"), {
        dateKey,
        title,
        time: time || "",
        importance: importance || "ë³´í†µ",
        createdAt: serverTimestamp()
      });

      window.closeMeetingModal();
      alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadMonthCalendar();
      await loadHomeThermoCompact();
      await loadChantThermo();
    };

    /* ===== ë‹¬ë ¥ ë Œë” + ë‚ ì§œ í´ë¦­ ìƒì„¸ ===== */
    let cachedDayData = null; // {chantsByDate, activitiesByDate, meetingsByDate}
    async function buildMonthCache() {
      const chantsByDate = {};
      const activitiesByDate = {};
      const meetingsByDate = {};

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities")),
        getDocs(collection(db, "meetings"))
      ]);

      chantSnap.forEach(d => {
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!chantsByDate[x.dateKey]) chantsByDate[x.dateKey] = [];
        chantsByDate[x.dateKey].push(x);
      });

      actSnap.forEach(d => {
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!activitiesByDate[x.dateKey]) activitiesByDate[x.dateKey] = [];
        activitiesByDate[x.dateKey].push(x);
      });

      meetSnap.forEach(d => {
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        if (!meetingsByDate[x.dateKey]) meetingsByDate[x.dateKey] = [];
        meetingsByDate[x.dateKey].push(x);
      });

      cachedDayData = { chantsByDate, activitiesByDate, meetingsByDate };
    }

    function openDayDetail(dateKey){
      const layer = $("dayDetailModalLayer");
      const body = $("dayDetailBody");
      $("dayDetailTitle").textContent = `ì¼ì • ìƒì„¸ Â· ${dateKey}`;

      const chants = (cachedDayData?.chantsByDate?.[dateKey] || []);
      const acts = (cachedDayData?.activitiesByDate?.[dateKey] || []);
      const meets = (cachedDayData?.meetingsByDate?.[dateKey] || []);

      const chantSum = chants.reduce((s, it)=>s + (Number(it.minutes)||0), 0);

      let html = "";

      html += `<div class="detail-block">
        <div class="detail-title">ğŸŒ± ì°½ì œ</div>
        <div class="small">í•©ê³„: <strong>${chantSum}</strong>ë¶„</div>
        ${chants.length ? chants.map(it => `
          <div class="small">â€¢ ${escapeHtml(it.branch||"")} Â· ${Number(it.minutes)||0}ë¶„ Â· ${escapeHtml(it.nickname||"")}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      html += `<div class="detail-block">
        <div class="detail-title">ğŸ”¥ í™œë™</div>
        ${acts.length ? acts.map(it => `
          <div class="small">â€¢ ${escapeHtml(it.branch||"")} Â· ${escapeHtml(it.subject||"")} â†’ ${escapeHtml(it.target||"")}${it.method ? ` Â· ${escapeHtml(it.method)}` : ""}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      html += `<div class="detail-block">
        <div class="detail-title">ğŸ“Œ íšŒí•©</div>
        ${meets.length ? meets.map(it => `
          <div class="small">â€¢ ${escapeHtml(it.title||"íšŒí•©")}${it.time ? ` Â· ${escapeHtml(it.time)}` : ""}${it.importance ? ` Â· (${escapeHtml(it.importance)})` : ""}</div>
        `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
      </div>`;

      body.innerHTML = html;
      layer.style.display = "flex";
    }
    window.closeDayDetailModal = () => { $("dayDetailModalLayer").style.display = "none"; };

    /* (ìš”ì²­ 3) ëª¨ë°”ì¼ì—ì„œ ë‹¬ë ¥ ì˜ë¦¼ ë°©ì§€: ëª¨ë°”ì¼ì€ ë¦¬ìŠ¤íŠ¸í˜•ìœ¼ë¡œ ë Œë”ë§ */
    async function loadMonthCalendar() {
      const cal = $("monthCalendar");
      if (!cal) return;
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      await buildMonthCache();

      const chantMinMap = {};
      const actBranchMap = {};
      const meetingCountMap = {};

      Object.entries(cachedDayData.chantsByDate).forEach(([dateKey, arr]) => {
        chantMinMap[dateKey] = arr.reduce((s, it)=>s + (Number(it.minutes)||0), 0);
      });

      Object.entries(cachedDayData.activitiesByDate).forEach(([dateKey, arr]) => {
        if (!actBranchMap[dateKey]) actBranchMap[dateKey] = {};
        arr.forEach(it => {
          const b = it.branch || "ë¯¸ì§€ì •";
          actBranchMap[dateKey][b] = (actBranchMap[dateKey][b] || 0) + 1;
        });
      });

      Object.entries(cachedDayData.meetingsByDate).forEach(([dateKey, arr]) => {
        meetingCountMap[dateKey] = arr.length;
      });

      const mobile = isMobileView();

      if (mobile){
        // ë¦¬ìŠ¤íŠ¸í˜• ë Œë”
        cal.className = "calendar-list";
        cal.innerHTML = "";

        const lastDate = monthEnd.getDate();
        for (let day=1; day<=lastDate; day++){
          const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

          const chantMin = chantMinMap[dateKey] || 0;
          const branchCounts = actBranchMap[dateKey] || null;
          const meetCount = meetingCountMap[dateKey] || 0;

          let actBadges = "";
          if (branchCounts) {
            const entries = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1]);
            const top3 = entries.slice(0,3);
            actBadges = top3.map(([b,c]) => `<span class="badge act-badge">${escapeHtml(b)}Ã—${c}</span>`).join("");
            if (entries.length > 3) {
              actBadges += `<span class="badge act-badge">ì™¸ ${entries.length-3}ì§€ë¶€</span>`;
            }
          }

          const row = document.createElement("div");
          row.className = "day-row";
          row.dataset.dateKey = dateKey;
          row.innerHTML = `
            <div class="day-row-top">
              <div class="day-row-date">${escapeHtml(dateKey)}</div>
              <div class="small">${(chantMin||branchCounts||meetCount) ? "ìƒì„¸ ë³´ê¸°" : ""}</div>
            </div>
            <div class="day-row-badges">
              ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
              ${actBadges}
              ${meetCount ? `<span class="badge meet-badge">íšŒí•© ${meetCount}ê±´</span>` : ``}
              ${(!chantMin && !branchCounts && !meetCount) ? `<span class="badge">ì¼ì • ì—†ìŒ</span>` : ``}
            </div>
          `;
          row.addEventListener("click", ()=>openDayDetail(dateKey));
          cal.appendChild(row);
        }
        return;
      }

      // ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿: ê·¸ë¦¬ë“œí˜• ë Œë”
      cal.className = "month-calendar";
      cal.innerHTML = "";

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      weekdays.forEach(w => {
        const h = document.createElement("div");
        h.className = "weekday";
        h.textContent = w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay();
      for (let i = 0; i < firstDayWeek; i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.visibility = "hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();
      for (let day=1; day<=lastDate; day++){
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        const chantMin = chantMinMap[dateKey] || 0;
        const branchCounts = actBranchMap[dateKey] || null;
        const meetCount = meetingCountMap[dateKey] || 0;

        let actBadges = "";
        if (branchCounts) {
          const entries = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1]);
          const top2 = entries.slice(0,2);
          actBadges = top2.map(([b,c]) => `<span class="badge act-badge">${escapeHtml(b)}Ã—${c}</span>`).join("");
          if (entries.length > 2) {
            actBadges += `<div class="small" style="margin-top:4px;opacity:.85;">í™œë™ ì™¸ ${entries.length-2}ì§€ë¶€</div>`;
          }
        }

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.dataset.dateKey = dateKey;
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actBadges}
          ${meetCount ? `<span class="badge meet-badge">íšŒí•© ${meetCount}ê±´</span>` : ``}
        `;
        cell.addEventListener("click", ()=>openDayDetail(dateKey));
        cal.appendChild(cell);
      }
    }

    /* ===== ìŠ¤ì¿¨ ì¼ì • ===== */
    async function loadSchoolMonthSchedule(){
      const list = $("schoolMonthScheduleList");
      if (!list) return;
      list.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const snap = await getDocs(collection(db, "schoolSchedules"));
      const items = [];
      snap.forEach(d => {
        const x = d.data();
        if (isInThisMonth(x.dateKey)) items.push({ id: d.id, ...x });
      });

      items.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (items.length === 0){
        list.innerHTML = `<div class="small">ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      list.innerHTML = "";
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "school-sched-item";
        div.innerHTML = `
          <div class="school-sched-top">
            <div class="school-sched-date">${escapeHtml(it.dateKey || "")}</div>
            ${isAdminMode() ? `<button class="mini-btn" style="padding:8px 10px;font-size:.85rem;" data-edit="${it.id}">ìˆ˜ì •</button>` : ``}
          </div>
          <div><strong>${escapeHtml(it.title || "")}</strong></div>
          ${it.desc ? `<div class="small" style="margin-top:4px;">${escapeHtml(it.desc)}</div>` : ``}
        `;
        list.appendChild(div);

        if (isAdminMode()){
          const btn = div.querySelector(`[data-edit="${it.id}"]`);
          if (btn){
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              editSchoolSchedule(it.id, it);
            });
          }
        }
      });
    }

    async function addSchoolSchedule(){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ (YYYY-MM-DD)", todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", "") || "";

      await addDoc(collection(db, "schoolSchedules"), {
        dateKey,
        title: title.trim(),
        desc: desc.trim(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    }
    window.addSchoolSchedule = addSchoolSchedule;

    async function editSchoolSchedule(id, current){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ (YYYY-MM-DD)", current.dateKey || todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");

      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", current.title || "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", current.desc || "") || "";

      await updateDoc(doc(db, "schoolSchedules", id), {
        dateKey,
        title: title.trim(),
        desc: desc.trim(),
        updatedAt: serverTimestamp()
      });

      alert("ìŠ¤ì¿¨ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadSchoolMonthSchedule();
    }

    /* ===== ìŠ¤ì¿¨ íƒ­ ===== */
    async function loadThermometerForSchoolBranch(branch) {
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";
      if (!branch) {
        wrap.innerHTML = `<div class="small hint">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));
      const confirmed = snap.docs.filter(d => d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed / 20) * 100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${escapeHtml(branch)} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch) {
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));
      const bySlot = new Map();
      snap.forEach(docu => {
        const data = docu.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: docu.ref, ...data });
      });

      for (let slot = 1; slot <= 20; slot++) {
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        toggle.innerHTML = confirmed ? "âœ…" : `<span class="tri">â–²</span>`;

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        toggle.onclick = async () => {
          const newStatus = !(existing?.confirmed === true);
          toggle.innerHTML = newStatus ? "âœ…" : `<span class="tri">â–²</span>`;

          if (existing?.ref) {
            await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: newStatus,
              name: (input.value || "").trim(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value || "").trim() };
            bySlot.set(slot, existing);
          }

          await loadThermometerForSchoolBranch(branch);
        };

        input.addEventListener("blur", async () => {
          const newName = (input.value || "").trim();

          if (existing?.ref) {
            await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
            existing.name = newName;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: false,
              name: newName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: false, name: newName };
            bySlot.set(slot, existing);
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);

        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ê´€ë¦¬ì: í†µê³„/ë¦¬ì…‹ */
    window.loadAdminStats = async () => {
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches) {
        const [chantSnap, activitySnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db, "chants"), where("branch", "==", b))),
          getDocs(query(collection(db, "activities"), where("branch", "==", b))),
          getDocs(query(collection(db, "school"), where("branch", "==", b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d => d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${escapeHtml(b)}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${activitySnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    window.resetAllData = async () => {
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©/ìŠ¤ì¿¨ì¼ì •)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants", "activities", "school", "meetings", "schoolSchedules"];
      for (const col of cols) {
        const snap = await getDocs(collection(db, col));
        for (const d of snap.docs) {
          await deleteDoc(d.ref);
        }
      }

      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      window.showTab("home");
    };

    async function refreshAll() {
      await loadTodaySummary();

      // í™ˆ: ê°„ì†Œ ì˜¨ë„ê³„
      await loadHomeThermoCompact();

      // ì°½ì œ íƒ­: ê¸°ì¡´ ìƒì„¸ ì˜¨ë„ê³„
      await loadChantThermo();

      await loadMonthPlans();
      await loadMonthCalendar();

      await loadSchoolMonthSchedule();

      const selected = $("schoolBranchSelect").value;
      await loadThermometerForSchoolBranch(selected);
      await loadSchoolGrid(selected);

      applyAdminModeUI();
    }

    function bindModalOutsideClose(){
      document.addEventListener("click", (e) => {
        const layer = $("meetingModalLayer");
        if (layer && layer.style.display === "flex" && e.target === layer) layer.style.display = "none";
      });
      document.addEventListener("click", (e) => {
        const layer = $("dayDetailModalLayer");
        if (layer && layer.style.display === "flex" && e.target === layer) layer.style.display = "none";
      });
    }

    /* í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ: ì¼ì • ë‹¬ë ¥ ì¬ë Œë”(ëª¨ë°”ì¼/ê·¸ë¦¬ë“œ ì „í™˜) */
    function bindResponsiveCalendarRerender(){
      window.addEventListener("resize", () => {
        // ë„ˆë¬´ ìì£¼ í˜¸ì¶œë˜ì§€ ì•Šë„ë¡ ê°„ë‹¨ ë””ë°”ìš´ìŠ¤
        clearTimeout(window.__calResizeT);
        window.__calResizeT = setTimeout(() => {
          loadMonthCalendar();
        }, 150);
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      applyAdminModeUI();
      bindModalOutsideClose();
      bindResponsiveCalendarRerender();

      if (!nickname) {
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillBranchOptions($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      $("schoolBranchSelect").addEventListener("change", async (e) => {
        const branch = e.target.value;
        await loadThermometerForSchoolBranch(branch);
        await loadSchoolGrid(branch);
      });

      if (nickname) await refreshAll();
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>
    <div class="card">ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong></div>
    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint small" style="margin-top:6px;">ê° ì§€ë¶€ ì˜¨ë„ê³„ë¥¼ í´ë¦­í•˜ë©´ ì°½ì œ íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <!-- (ìš”ì²­) í™ˆì—ì„œëŠ” 4ê°œ/í–‰ ê°„ì†Œí˜• -->
      <div id="homeThermoGrid" class="home-thermo-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <div class="row">
        <select id="chantBranch"></select>

        <div style="display:grid;gap:8px;">
          <select id="chantMinutes">
            <option value="">ì‹œê°„ ì„ íƒ</option>
            <option value="10">10ë¶„</option>
            <option value="30">30ë¶„</option>
            <option value="60">60ë¶„</option>
          </select>
          <!-- (ìš”ì²­ 2) ì§ì ‘ ì…ë ¥ -->
          <input id="chantMinutesCustom" type="number" min="1" step="1" placeholder="ì§ì ‘ ì…ë ¥(ë¶„) ì˜ˆ: 45" />
        </div>
      </div>

      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
      <div class="hint small" style="margin-top:8px;">í•˜ë£¨ 3íšŒ ì œí•œ Â· ì§ì ‘ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©</div>
    </div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint small" style="margin-top:6px;">ì°½ì œ íƒ­ì—ì„œëŠ” ê¸°ì¡´ì²˜ëŸ¼ ìƒì„¸/ìµœê·¼ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="chantThermoGrid" class="thermo-grid-wrap"></div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <select id="activityBranch"></select>
      <div style="height:10px;"></div>
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>
      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>
      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ê¸°ë¡ ğŸ”¥</button>
      <div class="hint small" style="margin-top:8px;">í™œë™ 1íšŒëŠ” ëˆ„ì  ì˜¨ë„ê³„ ê¸°ì¤€ 2ì¹¸ìœ¼ë¡œ ì§‘ê³„</div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
          <div class="hint small">ê¸°ë¡ëœ í™œë™ ê³„íšì„ ë‚ ì§œë³„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="hint small">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì¼ì •ì´ ì—´ë¦½ë‹ˆë‹¤. (ëª¨ë°”ì¼ì€ ë¦¬ìŠ¤íŠ¸í˜•ìœ¼ë¡œ í‘œì‹œ)</div>
        </div>
        <button class="mini-btn" onclick="openMeetingModal()">+ íšŒí•©</button>
      </div>

      <div id="monthCalendar" class="month-calendar"></div>
      <div class="small" style="margin-top:10px;opacity:.85;">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œ ìƒì„¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •</strong>
          <div class="hint small">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¼ì • ì¶”ê°€/ìˆ˜ì • ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <button id="addSchoolScheduleBtn" class="mini-btn" onclick="addSchoolSchedule()" style="display:none;">+ ì¼ì • ì¶”ê°€</button>
      </div>
      <div id="schoolMonthScheduleList" class="school-sched-list"></div>
    </div>

    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="hint small" style="margin-top:8px;">â–²(ë¯¸í™•ì •) / âœ…(í™•ì •) Â· ì´ë¦„ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì €ì¥</div>
    </div>

    <div class="card school-wrap">
      <div id="schoolThermoWrap"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
          <div class="hint small">ê´€ë¦¬ì ëª¨ë“œ ON ì‹œ ë¶€ì—°ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <button id="adminModeBtn" class="mini-btn" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ON</button>
      </div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
    </div>
  </div>

  <!-- MEETING MODAL -->
  <div id="meetingModalLayer" class="modal-layer">
    <div class="modal">
      <h3>íšŒí•© ì¼ì • ì¶”ê°€</h3>
      <div class="grid">
        <input id="meetDate" placeholder="íšŒí•© ì¼ì •(YYYY-MM-DD)" />
        <input id="meetTitle" placeholder="íšŒí•©ëª…" />
        <input id="meetTime" placeholder="ì‹œê°„(ì˜ˆ: 19:30)" />
        <select id="meetImportance">
          <option value="ë‚®ìŒ">ì¤‘ìš”ë„: ë‚®ìŒ</option>
          <option value="ë³´í†µ" selected>ì¤‘ìš”ë„: ë³´í†µ</option>
          <option value="ë†’ìŒ">ì¤‘ìš”ë„: ë†’ìŒ</option>
        </select>
      </div>
      <div class="actions">
        <button class="cancel" onclick="closeMeetingModal()">ì·¨ì†Œ</button>
        <button class="ok" onclick="saveMeetingFromModal()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- DAY DETAIL MODAL -->
  <div id="dayDetailModalLayer" class="modal-layer">
    <div class="modal">
      <h3 id="dayDetailTitle">ì¼ì • ìƒì„¸</h3>
      <div id="dayDetailBody"></div>
      <div class="actions">
        <button class="cancel" onclick="closeDayDetailModal()">ë‹«ê¸°</button>
        <button class="ok" onclick="closeDayDetailModal()">í™•ì¸</button>
      </div>
    </div>
  </div>

</body>
</html>
