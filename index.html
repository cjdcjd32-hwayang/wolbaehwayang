<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --card-bg: rgba(255,255,255,.92);
      --bd: rgba(0,0,0,.10);
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.35rem;
      font-weight:900;
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(8px);
    }
    nav{
      display:flex;
      gap:6px;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      flex-wrap:wrap;
      position: sticky;
      top: 64px;
      z-index: 25;
      backdrop-filter: blur(8px);
    }
    nav button{
      border:none;
      background:none;
      padding:8px 12px;
      font-size:1rem;
      border-radius:12px;
      cursor:pointer;
      touch-action: manipulation;
    }
    nav button:hover{ background:rgba(0,0,0,.06); }

    section{ display:none; padding:16px; }
    section.active{ display:block; }

    .card{
      background:var(--card-bg);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:12px 12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
      touch-action: manipulation;
    }
    .btn.secondary{ background:#444; }
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-size:.9rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .mini-btn.light{
      background:#eee;
      color:#111;
      border:1px solid rgba(0,0,0,.12);
    }
    .mini-btn:hover{ opacity:.92; }

    select, input, textarea{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      outline:none;
      font-size: 1rem;
    }
    textarea{ min-height:120px; resize:vertical; }
    .small{ font-size:.9rem; opacity:.86; }
    .hint{ display:none; font-size:.88rem; opacity:.82; }
    body.admin .hint{ display:block; }

    /* ===== í™ˆ: 4ê°œ/í–‰ ì˜¨ë„ê³„ ===== */
    .home-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .home-grid{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width: 720px){ .home-grid{ grid-template-columns:repeat(2,1fr); } }

    .home-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .12s ease;
      text-align:center;
    }
    .home-item:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .home-branch{ font-weight:900; margin-bottom:6px; }
    .home-temp{ font-weight:900; margin-top:6px; }

    /* ===== ì°½ì œ: ìƒì„¸ ì˜¨ë„ê³„ 3ì—´ ê·¸ë£¹ ===== */
    .thermo-grid-wrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .thermo-col{ display:flex; flex-direction:column; gap:12px; min-width:0; }

    @media (max-width: 520px){
      section{ padding:12px; }
      .row{ grid-template-columns:1fr; }
      .thermo-grid-wrap{ grid-template-columns: 1fr; }
    }

    .branch-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 92px;
      gap: 10px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .branch-thermo-card:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }

    .branch-thermo-title{
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .branch-thermo-meta{ font-size:.88rem; opacity:.86; line-height:1.35; }
    .recent-list{ margin-top:8px; font-size:.82rem; opacity:.92; line-height:1.35; }
    .recent-item{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:2px 0; }

    /* ===== ì˜¨ë„ê³„ í”„ë ˆì„ ===== */
    .thermo-frame{ width:92px; height:252px; position:relative; display:flex; align-items:flex-start; justify-content:center; }
    .tube{
      width:60px; height:192px;
      border-radius:999px;
      background: rgba(255,255,255,.90);
      border:2px solid rgba(0,0,0,.12);
      overflow:hidden;
      padding:8px;
      box-sizing:border-box;
      display:flex;
    }
    .tube-grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns:repeat(20,1fr);
      grid-template-rows:repeat(15,1fr);
      gap:1px;
      background: rgba(0,0,0,.05);
      border-radius:12px;
      padding:2px;
      box-sizing:border-box;
    }
    .cell{
      background: rgba(255,255,255,.60);
      border-radius: 1px;
    }
    .bulb{
      width:82px; height:82px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      border:2px solid rgba(0,0,0,.12);
      position:absolute;
      bottom:0;
      overflow:hidden;
      box-sizing:border-box;
    }
    .bulb-fill{
      position:absolute;
      inset:10px;
      border-radius:999px;
      opacity:0;
      transform: scale(.92);
      transition: opacity .25s ease, transform .25s ease;
    }
    .bulb.filled .bulb-fill{
      opacity:1;
      transform: scale(1);
    }

    /* í…Œë§ˆ í”„ë ˆì„ */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }
    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }
    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* ë²Œë¸Œ ì±„ì›€: í”„ë ˆì„ìƒ‰(ìš”ì²­) */
    .theme-blue .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(0,128,255,.45) 0%, rgba(0,128,255,.85) 60%, rgba(0,128,255,.95) 100%); }
    .theme-yellow .bulb-fill{ background: radial-gradient(circle at 30% 30%, rgba(255,193,7,.45) 0%, rgba(255,193,7,.85) 60%, rgba(255,193,7,.95) 100%); }
    .theme-pink .bulb-fill  { background: radial-gradient(circle at 30% 30%, rgba(194,24,91,.35) 0%, rgba(194,24,91,.80) 60%, rgba(194,24,91,.95) 100%); }

    /* í™ˆì€ ì•½ê°„ ë” ì‘ê²Œ */
    .thermo-mini .thermo-frame{ width:88px; height:234px; }
    .thermo-mini .tube{ width:56px; height:176px; padding:7px; }
    .thermo-mini .bulb{ width:76px; height:76px; }

    /* ===== ì¼ì •(ë‹¬ë ¥) ===== */
    .card-header{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:10px;
    }
    .plan-list{ display:grid; gap:10px; }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{ font-weight:900; margin-bottom:4px; }
    .plan-meta{ font-size:.86rem; opacity:.88; }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      font-size:.78rem;
      margin-left:6px;
      background:#f4f4f4;
    }
    .pill.done{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); }
    .pill.todo{ background:rgba(251,146,60,.12); border-color:rgba(251,146,60,.35); }

    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:900;
      text-align:center;
      opacity:.82;
      padding: 4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:86px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.25;
      cursor:pointer;
      overflow:hidden;
    }
    .day-cell:hover{ box-shadow: var(--shadow); }
    .day-num{ font-weight:900; font-size:.95rem; margin-bottom:4px; }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align: top;
    }
    .meet-badge{ background:rgba(194,24,91,.10); }
    .act-badge{ background:rgba(0, 128, 255, .10); }
    .more-hint{ display:none; font-size:.72rem; opacity:.78; margin-top:4px; }
    .act-done{ background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); }
    .act-todo{ background:rgba(251,146,60,.12); border:1px solid rgba(251,146,60,.35); }

    

    @media (max-width: 520px){
      .month-calendar{ gap:4px; }
      .weekday{ font-size:.72rem; padding:2px 0; }
      .day-cell{
        min-height:96px;
        padding:6px;
        font-size:.72rem;
        line-height:1.2;
      }
      .day-num{ font-size:.88rem; margin-bottom:2px; }
      .badge{ font-size:.68rem; padding:2px 5px; margin:2px 3px 0 0; }
      .more-hint{ display:block; }
    }

    /* ===== ìŠ¤ì¿¨ ===== */
    .school-sched-list{ display:grid; gap:10px; }
    .school-sched-item{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      line-height:1.35;
    }
    .school-sched-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .school-sched-date{ font-weight:900; }

    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:800;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }

    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      #schoolGrid{ grid-template-columns:repeat(2,1fr); }
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
    }
    .slot-num{ font-weight:900; font-size:.9rem; opacity:.82; }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.05rem;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.05);
      min-width:40px;
      text-align:center;
      touch-action: manipulation;
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }
    .tri{
      color:#8e8e8e;
      font-weight:900;
    }
    .slot-input{
      width:100%;
      padding:12px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.95rem;
      background:#FFF6BF; /* ì—°ë…¸ë‘ ê³ ì • */
    }

    /* ===== ëª¨ë‹¬(ê³µìš©) ===== */
    .modal-layer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:9999;
      padding:14px;
      box-sizing:border-box;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(0,0,0,.10);
      max-height: 86vh;
      overflow:auto;
    }
    .modal h3{ margin:0 0 10px 0; font-size:1.05rem; }
    .modal .grid{ display:grid; gap:10px; }
    .modal .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .modal .actions button{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-size:1rem;
      touch-action: manipulation;
    }
    .modal .actions .cancel{ background:#eee; }
    .modal .actions .ok{ background:#111; color:#fff; }

    .detail-block{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      background:#fff;
      line-height:1.4;
    }
    .detail-title{ font-weight:900; margin-bottom:6px; }

    /* ìƒì„¸ íƒ­ UI */
    .tabbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 6px 0;
    }
    .tab{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#f4f4f4;
      cursor:pointer;
      font-size:.9rem;
    }
    .tab.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    /* ë‹‰ë„¤ì„ ë ˆì´ì–´ */
    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:10000;
      padding:14px;
      box-sizing:border-box;
    }

    /* ìŠ¤í”¼ì¹˜ ë¯¸ë¦¬ë³´ê¸° */
    .speech-preview{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
    }
    .speech-title{ font-weight:900; margin-bottom:6px; }
    .speech-meta{ font-size:.86rem; opacity:.8; margin-bottom:8px; }
    .speech-snippet{ font-size:.95rem; line-height:1.35; opacity:.92; }
    .speech-list{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .speech-item{
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;

      <button class="mini-btn light" data-edit="${it.id}">ìˆ˜ì •</button>
      div.querySelector(`[data-edit="${it.id}"]`).onclick = (e)=>{ e.stopPropagation(); openSpeechEdit(it.id); };
    }
    .speech-item:hover{ box-shadow: var(--shadow); }
    .speech-item-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
  </style>

  <!-- Firebase SDK (v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const THERMO_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    const TOTAL_CELLS = 300;        // íŠœë¸Œ ê²©ì ì¹¸ìˆ˜(20x15)
    const CHANT_CELL_MIN = 10;      // 1ì¹¸=10ë¶„
    const ACTIVITY_CELL = 2;        // í™œë™ 1íšŒ=2ì¹¸
    const BULB_START_CELLS = 12;    // ë²Œë¸Œ ë¨¼ì €(UX)
    const RECENT_PER_BRANCH = 3;

    const nicknameKey = "wolbaehwayang_nickname";
    const adminModeKey = "wol_admin_mode";
    const adminPw = "adminPw";

    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);
    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth();
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`;

    let nickname = localStorage.getItem(nicknameKey) || "";

    const $ = (id) => document.getElementById(id);
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function isAdminMode(){ return localStorage.getItem(adminModeKey) === "1"; }
    function applyAdminModeUI(){
      document.body.classList.toggle("admin", isAdminMode());
      const btn = $("adminModeBtn");
      if (btn) btn.textContent = isAdminMode() ? "ê´€ë¦¬ì ëª¨ë“œ OFF" : "ê´€ë¦¬ì ëª¨ë“œ ON";
      const schBtn = $("addSchoolScheduleBtn");
      if (schBtn) schBtn.style.display = isAdminMode() ? "inline-block" : "none";
    }

    window.toggleAdminMode = () => {
      if (!isAdminMode()){
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (pw !== adminPw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        localStorage.setItem(adminModeKey, "1");
      } else {
        localStorage.removeItem(adminModeKey);
      }
      applyAdminModeUI();
      loadSchoolMonthSchedule();
    };

    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
      window.scrollTo({ top: 0, behavior: "auto" });
    };

    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    function fillSelect(selectEl, placeholder="ì§€ë¶€ ì„ íƒ"){
      selectEl.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "";
      o0.textContent = placeholder;
      selectEl.appendChild(o0);
      branches.forEach(b=>{
        const o = document.createElement("option");
        o.value = b; o.textContent = b;
        selectEl.appendChild(o);
      });
    }

    function themeForBranch(branch){
      for (const col of THERMO_COLUMNS){
        if (col.branches.includes(branch)) return col.theme;
      }
      return "theme-blue";
    }

    /* ===== ì˜¨ë„/ìƒ‰: íŒŒë‘->ë…¸ë‘->ë¹¨ê°• ===== */
    function lerp(a,b,t){ return a + (b-a)*t; }
    function rgb(r,g,b){ return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
    function heatColor(t){
      const b1={r:59,g:130,b:246}, y={r:253,g:224,b:71}, r2={r:239,g:68,b:68};
      if (t<=0.5){
        const k=t/0.5;
        return rgb(lerp(b1.r,y.r,k), lerp(b1.g,y.g,k), lerp(b1.b,y.b,k));
      } else {
        const k=(t-0.5)/0.5;
        return rgb(lerp(y.r,r2.r,k), lerp(y.g,r2.g,k), lerp(y.b,r2.b,k));
      }
    }
    function approxTempC(cells){
      const ratio = Math.max(0, Math.min(1, (cells||0)/TOTAL_CELLS));
      return Math.round(ratio * 100);
    }

    function computeBulbAndTube(cells){
      const tubeCells = Math.max(0, cells - BULB_START_CELLS);
      const tubeCap = Math.max(1, TOTAL_CELLS - BULB_START_CELLS);
      const scaled = Math.min(TOTAL_CELLS, Math.floor((tubeCells / tubeCap) * TOTAL_CELLS));
      return { tubeFilledCells: scaled };
    }

    function buildTubeGridHTML(filledCells){
      const total = TOTAL_CELLS;
      const startFilledPos = total - filledCells + 1;
      let html = `<div class="tube-grid">`;
      for (let pos=1; pos<=total; pos++){
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled){
          html += `<div class="cell"></div>`;
        } else {
          const tHot = (total - pos) / (total - 1);
          html += `<div class="cell" style="background:${heatColor(tHot)};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    function buildRecentHTML(items){
      const top = (items || []).slice(0, RECENT_PER_BRANCH);
      if (top.length === 0) return `<div class="recent-list"><div class="recent-item">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div></div>`;
      return `
        <div class="recent-list">
          ${top.map(x=>`<div class="recent-item">â€¢ ${esc(x)}</div>`).join("")}
        </div>
      `;
    }

    function isInThisMonth(dateKey){ return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix); }

    /* =========================================================
       í™œë™: ê³„íš/ì™„ë£Œ ëª¨ë¸
       - activities: plannedDateKey(string), isDone(boolean), doneAt(timestamp)
       - ì˜¨ë„ê³„/ë‹¬ë ¥ ëˆ„ì : isDone === true ë§Œ ë°˜ì˜
    ========================================================= */

    /* ===== ë°ì´í„° ì§‘ê³„(ì˜¨ë„ê³„ìš©) ===== */
    async function computeCumulative(){
      const chantMinByBranch = {};
      const doneActCountByBranch = {};
      const cellsByBranch = {};
      const recentByBranch = {};

      branches.forEach(b=>{
        chantMinByBranch[b]=0;
        doneActCountByBranch[b]=0;
        cellsByBranch[b]=0;
        recentByBranch[b]=[];
      });

      const [chantSnap, actSnap] = await Promise.all([
        getDocs(collection(db,"chants")),
        getDocs(collection(db,"activities"))
      ]);

      chantSnap.forEach(d=>{
        const { branch, minutes, dateKey, nickname: nn } = d.data();
        if (!branch || chantMinByBranch[branch]==null) return;
        const m = Number(minutes)||0;
        chantMinByBranch[branch]+=m;
        cellsByBranch[branch]+=Math.floor(m/CHANT_CELL_MIN);
        if (dateKey) recentByBranch[branch].push(`${dateKey.slice(5)} ğŸŒ± ${m}ë¶„ (${nn||""})`);
      });

      actSnap.forEach(d=>{
        const x = d.data();
        const branch = x.branch;
        if (!branch || doneActCountByBranch[branch]==null) return;

        const isDone = x.isDone === true;
        // âœ… ì™„ë£Œëœ í™œë™ë§Œ ëˆ„ì 
        if (!isDone) return;

        doneActCountByBranch[branch]+=1;
        cellsByBranch[branch]+=ACTIVITY_CELL;

        const dk = x.plannedDateKey || x.dateKey; // ê³¼ê±° í˜¸í™˜
        if (dk) recentByBranch[branch].push(`${dk.slice(5)} âœ… í™œë™ ${x.subject||""}â†’${x.target||""}`);
      });

      branches.forEach(b=> recentByBranch[b].sort((a,c)=> (a<c?1:-1)));
      return { chantMinByBranch, doneActCountByBranch, cellsByBranch, recentByBranch };
    }

    /* ===== í™ˆ: ê°„ì†Œ ì˜¨ë„ê³„ ===== */
    async function loadHomeThermoCompact(){
      const container = $("homeThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { cellsByBranch, chantMinByBranch } = await computeCumulative();

      container.innerHTML = "";
      branches.forEach(branch=>{
        const theme = themeForBranch(branch);
        const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
        const { tubeFilledCells } = computeBulbAndTube(cells);
        const temp = approxTempC(cells);

        // ìš”ì²­: ë™ê·¸ë¼ë¯¸ëŠ” "ì°½ì œ ê¸°ë¡ ì‹œì‘" ì‹œ í”„ë ˆì„ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
        const hasChant = (chantMinByBranch[branch] || 0) > 0;

        const div = document.createElement("div");
        div.className = `home-item thermo-mini ${theme}`;
        div.innerHTML = `
          <div class="home-branch">${esc(branch)}</div>
          <div class="thermo-frame ${theme}">
            <div class="tube">${buildTubeGridHTML(tubeFilledCells)}</div>
            <div class="bulb ${hasChant ? "filled" : ""}">
              <div class="bulb-fill"></div>
            </div>
          </div>
          <div class="home-temp">${temp}Â°C</div>
        `;
        div.onclick = () => {
          showTab("chant");
          const sel = $("chantBranch");
          if (sel) sel.value = branch;
        };
        container.appendChild(div);
      });
    }

    /* ===== ì°½ì œ íƒ­: ìƒì„¸ ì˜¨ë„ê³„ ===== */
    async function loadChantThermoDetailed(){
      const container = $("chantThermoGrid");
      if (!container) return;
      container.innerHTML = `<div class="small">ì§‘ê³„ ì¤‘...</div>`;

      const { chantMinByBranch, doneActCountByBranch, cellsByBranch, recentByBranch } = await computeCumulative();
      container.innerHTML = "";

      THERMO_COLUMNS.forEach(colDef=>{
        const col = document.createElement("div");
        col.className = `thermo-col ${colDef.theme}`;

        colDef.branches.forEach(branch=>{
          const theme = colDef.theme;
          const chantMin = chantMinByBranch[branch] || 0;
          const doneActCnt = doneActCountByBranch[branch] || 0;
          const cells = Math.min(TOTAL_CELLS, cellsByBranch[branch] || 0);
          const { tubeFilledCells } = computeBulbAndTube(cells);
          const temp = approxTempC(cells);

          const card = document.createElement("div");
          card.className = `branch-thermo-card ${theme}`;
          card.innerHTML = `
            <div>
              <div class="branch-thermo-title">
                <span>${esc(branch)}</span>
                <span class="small">${cells}/${TOTAL_CELLS}ì¹¸ Â· ${temp}Â°C</span>
              </div>

              <div class="branch-thermo-meta">
                ëˆ„ì : <strong>${cells}</strong>ì¹¸<br>
                ì°½ì œ: ${chantMin}ë¶„ Â· í™œë™(ì™„ë£Œ): ${doneActCnt}íšŒ<br>
                ê¸°ì¤€: 1ì¹¸=${CHANT_CELL_MIN}ë¶„ Â· 2ì¹¸=í™œë™ 1íšŒ(ì™„ë£Œ)
              </div>

              ${buildRecentHTML(recentByBranch[branch] || [])}
              <div class="hint" style="margin-top:8px;">í´ë¦­í•˜ë©´ ì§€ë¶€ê°€ ì„ íƒë©ë‹ˆë‹¤.</div>
            </div>

            <div class="thermo-frame ${theme}">
              <div class="tube">${buildTubeGridHTML(tubeFilledCells)}</div>
              <div class="bulb ${(chantMin>0) ? "filled" : ""}">
                <div class="bulb-fill"></div>
              </div>
            </div>
          `;
          card.onclick = ()=> { const sel=$("chantBranch"); if(sel) sel.value=branch; };
          col.appendChild(card);
        });

        container.appendChild(col);
      });
    }

    /* ===== ê¸°ë¡ ì €ì¥ ===== */
    function getChantMinutes(){
      const custom = Number($("chantMinutesCustom").value);
      const preset = Number($("chantMinutes").value);
      const minutes = (custom && custom > 0) ? custom : preset;
      return minutes;
    }

    window.saveChant = async () => {
      const minutes = getChantMinutes();
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì…ë ¥(ì„ íƒ)í•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(collection(db,"chants"), where("nickname","==",nickname), where("dateKey","==",todayKey));
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db,"chants"),{
        nickname, branch, minutes, time,
        blocks: minutes/10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived:false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      showTab("home");
    };

    // í™œë™ ê³„íš ì €ì¥: ê¸°ë³¸ì€ ê³„íš(isDone=false)
    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();
      const plannedDateKey = ($("activityDateKey").value || todayKey).trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
      if (!/^\d{4}-\d{2}-\d{2}$/.test(plannedDateKey)) return alert("í™œë™ ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜(YYYY-MM-DD).");

      await addDoc(collection(db,"activities"),{
        branch, subject, target, method,
        plannedDateKey,
        isDone: false,
        doneAt: null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      alert("í™œë™ ê³„íšì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¯¸ì‹¤í–‰)");
      $("activitySubject").value = "";
      $("activityTarget").value = "";
      $("activityMethod").value = "";
      await refreshAll();
      showTab("activity");
    };

    /* ===== í™ˆ ì˜¤ëŠ˜ ìš”ì•½: ì°½ì œ/í™œë™(ì™„ë£Œ) ë¶„ë¦¬ ===== */
    async function loadTodaySummary(){
      const chantSnap = await getDocs(query(collection(db,"chants"), where("dateKey","==",todayKey)));
      const actSnap = await getDocs(collection(db,"activities"));

      let chantMinSum = 0;
      let doneActCountToday = 0;

      let detail = "";

      chantSnap.forEach(d=>{
        const { nickname: n, branch, minutes } = d.data();
        const m = Number(minutes)||0;
        chantMinSum += m;
        detail += `ğŸŒ± ${esc(branch)} - ${m}ë¶„ (${esc(n)})<br>`;
      });

      // ì˜¤ëŠ˜ ë‚ ì§œ plannedDateKey ê¸°ì¤€, ì™„ë£Œ(isDone)ë§Œ ì˜¤ëŠ˜ ì™„ë£Œ í™œë™ í•©ê³„
      actSnap.forEach(d=>{
        const x = d.data();
        const dk = x.plannedDateKey || x.dateKey;
        if (dk !== todayKey) return;
        const isDone = x.isDone === true;
        if (!isDone) return;
        doneActCountToday += 1;
        detail += `âœ… ${esc(x.branch)} - ${esc(x.subject)} â†’ ${esc(x.target)}<br>`;
      });

      $("todayChantTotal").innerHTML = `${chantMinSum}ë¶„`;
      $("todayActivityTotal").innerHTML = `${doneActCountToday}íšŒ (í™˜ì‚° ${doneActCountToday*20}ë¶„)`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* =========================================================
       í™œë™ ë¦¬ìŠ¤íŠ¸ + ì™„ë£Œ ì²´í¬
    ========================================================= */
    function tsToMillis(ts){
      if (!ts) return 0;
      if (typeof ts.seconds === "number") return ts.seconds*1000;
      return 0;
    }

    async function loadActivityList(){
      const box = $("activityList");
      if (!box) return;
      box.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const snap = await getDocs(collection(db,"activities"));
      const items = [];
      snap.forEach(d=>{
        const x = d.data();
        const plannedDateKey = x.plannedDateKey || x.dateKey;
        if (!plannedDateKey) return;
        // ì´ë‹¬ í™œë™ë§Œ ë…¸ì¶œ (ì›í•˜ë©´ ì „ì²´ë¡œ ë³€ê²½ ê°€ëŠ¥)
        if (!isInThisMonth(plannedDateKey)) return;
        items.push({ id: d.id, ref: d.ref, ...x, plannedDateKey });
      });

      items.sort((a,b)=>{
        const ak = a.plannedDateKey || "";
        const bk = b.plannedDateKey || "";
        if (ak !== bk) return ak.localeCompare(bk);
        return tsToMillis(b.createdAt) - tsToMillis(a.createdAt);
      });

      if (items.length === 0){
        box.innerHTML = `<div class="small">ì´ë‹¬ì— ë“±ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      box.innerHTML = "";
      items.forEach(it=>{
        const done = it.isDone === true;
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">
            ${esc(it.plannedDateKey)} Â· ${esc(it.branch)}
            <span class="pill ${done ? "done" : "todo"}">${done ? "ì™„ë£Œ" : "ë¯¸ì‹¤í–‰"}</span>
          </div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${esc(it.subject||"")}</strong> â†’ ëŒ€ìƒì: <strong>${esc(it.target||"")}</strong></div>
          ${it.method ? `<div class="plan-meta">ë°©ë²•: ${esc(it.method)}</div>` : ``}
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button class="mini-btn ${done ? "light" : ""}" data-toggle="${it.id}">${done ? "ì™„ë£Œ í•´ì œ" : "ì‹¤í–‰ ì™„ë£Œ"}</button>
            <button class="mini-btn light" data-del="${it.id}">ì‚­ì œ</button>
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
            <button class="mini-btn light" data-edit="${it.id}">ìˆ˜ì •</button>
            <button class="mini-btn ${done ? "light" : ""}" data-toggle="${it.id}">${done ? "ì™„ë£Œ í•´ì œ" : "ì‹¤í–‰ ì™„ë£Œ"}</button>
            <button class="mini-btn light" data-del="${it.id}">ì‚­ì œ</button>
          </div>
        `;
        box.appendChild(div);

        div.querySelector(`[data-edit="${it.id}"]`).onclick = async ()=>{
          const newDate = prompt("ë‚ ì§œ(YYYY-MM-DD)", it.plannedDateKey || "");
          if (newDate === null) return;
          if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate.trim())) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜(YYYY-MM-DD)");

          const newTime = prompt("ì‹œê°„(ì˜ˆ: 19:30) (ì„ íƒ)", it.time || "");
          if (newTime === null) return;

          const newBranch = prompt("ì§€ë¶€", it.branch || "");
          if (newBranch === null) return;
          if (!newBranch.trim()) return alert("ì§€ë¶€ëŠ” ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const newSubject = prompt("ì£¼ì²´ì", it.subject || "");
          if (newSubject === null) return;
          if (!newSubject.trim()) return alert("ì£¼ì²´ìëŠ” ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const newTarget = prompt("ëŒ€ìƒì", it.target || "");
          if (newTarget === null) return;
          if (!newTarget.trim()) return alert("ëŒ€ìƒìëŠ” ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const newMethod = prompt("í™œë™ ë°©ë²•(ì„ íƒ)", it.method || "");
          if (newMethod === null) return;

          try{
            await updateDoc(it.ref, {
              plannedDateKey: newDate.trim(),
              time: newTime.trim(),
              branch: newBranch.trim(),
              subject: newSubject.trim(),
              target: newTarget.trim(),
              method: (newMethod||"").trim(),
              updatedAt: serverTimestamp()
            });
            await refreshAll();
          }catch(e){
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e?.message || e));
          }
        };

          try{
            await updateDoc(it.ref, {
              isDone: newDone,
              doneAt: newDone ? serverTimestamp() : null,
              updatedAt: serverTimestamp()
            });
            await refreshAll();
          }catch(e){
            alert("í™œë™ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + (e?.message || e));
          }
        };

        div.querySelector(`[data-del="${it.id}"]`).onclick = async ()=>{
          if (!confirm("ì´ í™œë™ ê³„íšì„ ì‚­ì œí• ê¹Œìš”?")) return;
          try{
            await deleteDoc(it.ref);
            await refreshAll();
          }catch(e){
            alert("ì‚­ì œ ì‹¤íŒ¨: " + (e?.message || e));
          }
        };
      });
    }

    /* ===== ì¼ì •: í™œë™ ë¦¬ìŠ¤íŠ¸(ì´ë‹¬) ===== */
    async function loadMonthPlans(){
      const container = $("monthPlanList");
      if (!container) return;
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const snap = await getDocs(collection(db,"activities"));
      const plans = [];
      snap.forEach(d=>{
        const x = d.data();
        const dk = x.plannedDateKey || x.dateKey;
        if (!dk || !isInThisMonth(dk)) return;
        plans.push({ id:d.id, ...x, plannedDateKey: dk });
      });

      plans.sort((a,b)=>{
        if (a.plannedDateKey !== b.plannedDateKey) return (a.plannedDateKey||"").localeCompare(b.plannedDateKey||"");
        return tsToMillis(b.createdAt) - tsToMillis(a.createdAt);
      });

      if (plans.length === 0){
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ë“±ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p=>{
        const done = p.isDone === true;
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">
            ${esc(p.plannedDateKey||"")} Â· ${esc(p.branch||"")}
            <span class="pill ${done ? "done" : "todo"}">${done ? "ì™„ë£Œ" : "ë¯¸ì‹¤í–‰"}</span>
          </div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${esc(p.subject||"")}</strong> â†’ ëŒ€ìƒì: <strong>${esc(p.target||"")}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${esc(p.method)}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    /* ===== ì¼ì •: íšŒí•© ëª¨ë‹¬ ===== */
    window.openMeetingModal = () => {
      $("meetDate").value = todayKey;
      $("meetTitle").value = "";
      $("meetTime").value = "";
      $("meetImportance").value = "ë³´í†µ";
      $("meetingModalLayer").style.display = "flex";
    };
    window.closeMeetingModal = () => { $("meetingModalLayer").style.display = "none"; };

    window.saveMeetingFromModal = async () => {
      const dateKey = $("meetDate").value.trim();
      const title = $("meetTitle").value.trim();
      const time = $("meetTime").value.trim();
      const importance = $("meetImportance").value;

      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜(YYYY-MM-DD).");
      if (!title) return alert("íšŒí•©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

      try{
        await addDoc(collection(db,"meetings"),{
          dateKey, title,
          time: time || "",
          importance: importance || "ë³´í†µ",
          createdAt: serverTimestamp()
        });
        closeMeetingModal();
        alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        await refreshAll();
      }catch(e){
        alert("íšŒí•© ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e));
      }
    };

    /* ===== ì¼ì •: ë‚ ì§œ í´ë¦­ ìƒì„¸(íƒ­ UI) ===== */
    let cachedDayData = null;
    async function buildMonthCache(){
      const chantsByDate = {};
      const activitiesByDate = {};
      const meetingsByDate = {};

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db,"chants")),
        getDocs(collection(db,"activities")),
        getDocs(collection(db,"meetings"))
      ]);

      chantSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        (chantsByDate[x.dateKey] ||= []).push(x);
      });

      actSnap.forEach(d=>{
        const x = d.data();
        const dk = x.plannedDateKey || x.dateKey;
        if (!dk || !isInThisMonth(dk)) return;
        // ë‹¬ë ¥/ì˜¨ë„ê³„ ë°˜ì˜ì€ ì™„ë£Œë§Œ, í•˜ì§€ë§Œ ìƒì„¸ë³´ê¸°ì—ëŠ” ê³„íš/ì™„ë£Œ ë‘˜ ë‹¤ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ëª¨ë‘ ìºì‹œ
        (activitiesByDate[dk] ||= []).push(x);
      });

      meetSnap.forEach(d=>{
        const x = d.data();
        if (!isInThisMonth(x.dateKey)) return;
        (meetingsByDate[x.dateKey] ||= []).push({ id: d.id, ...x });
      });

      cachedDayData = { chantsByDate, activitiesByDate, meetingsByDate };
    }

    function renderDayDetailTabs(dateKey){
      const chants = cachedDayData?.chantsByDate?.[dateKey] || [];
      const actsAll = cachedDayData?.activitiesByDate?.[dateKey] || [];
      const meets = cachedDayData?.meetingsByDate?.[dateKey] || [];

      const chantSum = chants.reduce((s,it)=> s + (Number(it.minutes)||0), 0);
      const actsDone = actsAll.filter(x=> x.isDone === true);
      const actsTodo = actsAll.filter(x=> x.isDone !== true);

      // íƒ­ ë²„íŠ¼
      const tabbar = $("dayTabbar");
      tabbar.innerHTML = `
        <div class="tab active" data-tab="all">ì „ì²´</div>
        <div class="tab" data-tab="chant">ì°½ì œ</div>
        <div class="tab" data-tab="activity">í™œë™</div>
        <div class="tab" data-tab="meeting">íšŒí•©</div>
      `;

      function setActive(name){
        tabbar.querySelectorAll(".tab").forEach(t=>{
          t.classList.toggle("active", t.dataset.tab === name);
        });
      }

      const body = $("dayDetailBody");

      function renderAll(){
        body.innerHTML = `
          <div class="detail-block">
            <div class="detail-title">ğŸŒ± ì°½ì œ</div>
            <div class="small">í•©ê³„: <strong>${chantSum}</strong>ë¶„</div>
            ${chants.length ? chants.map(it=>`
              <div class="small">â€¢ ${esc(it.branch||"")} Â· ${(Number(it.minutes)||0)}ë¶„ Â· ${esc(it.nickname||"")}</div>
            `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
          </div>

          <div class="detail-block">
            <div class="detail-title">ğŸ”¥ í™œë™</div>
            ${actsAll.length ? actsAll.map(it=>{
              const done = it.isDone === true;
              const badge = done ? "âœ…ì™„ë£Œ" : "â˜ë¯¸ì‹¤í–‰";
              return `<div class="small">â€¢ ${badge} Â· ${esc(it.branch||"")} Â· ${esc(it.subject||"")} â†’ ${esc(it.target||"")}${it.time?` Â· ${esc(it.time)}`:""}${it.method?` Â· ${esc(it.method)}`:""}</div>`; : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
          </div>

          <div class="detail-block">
            <div class="detail-title">ğŸ“Œ íšŒí•©</div>
            ${meets.length ? meets.map(it=>`
              <div class="small">â€¢ ${esc(it.title||"íšŒí•©")}${it.time?` Â· ${esc(it.time)}`:""}${it.importance?` Â· (${esc(it.importance)})`:""}</div>
            `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
          </div>
        `;
      }

      function renderChant(){
        body.innerHTML = `
          <div class="detail-block">
            <div class="detail-title">ğŸŒ± ì°½ì œ</div>
            <div class="small">í•©ê³„: <strong>${chantSum}</strong>ë¶„</div>
            ${chants.length ? chants.map(it=>`
              <div class="small">â€¢ ${esc(it.branch||"")} Â· ${(Number(it.minutes)||0)}ë¶„ Â· ${esc(it.nickname||"")}</div>
            `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
          </div>
        `;
      }

      function renderActivity(){
        body.innerHTML = `
          <div class="detail-block">
            <div class="detail-title">ğŸ”¥ í™œë™(ì™„ë£Œ)</div>
            ${actsDone.length ? actsDone.map(it=>`
              <div class="small">â€¢ âœ… ${esc(it.branch||"")} Â· ${esc(it.subject||"")} â†’ ${esc(it.target||"")}${it.method?` Â· ${esc(it.method)}`:""}</div>
            `).join("") : `<div class="small">ì™„ë£Œëœ í™œë™ ì—†ìŒ</div>`}
          </div>

          <div class="detail-block">
            <div class="detail-title">ğŸ”¥ í™œë™(ë¯¸ì‹¤í–‰)</div>
            ${actsTodo.length ? actsTodo.map(it=>`
              <div class="small">â€¢ â˜ ${esc(it.branch||"")} Â· ${esc(it.subject||"")} â†’ ${esc(it.target||"")}${it.method?` Â· ${esc(it.method)}`:""}</div>
            `).join("") : `<div class="small">ë¯¸ì‹¤í–‰ í™œë™ ì—†ìŒ</div>`}
          </div>
        `;
      }

      function renderMeeting(){
        body.innerHTML = `
          <div class="detail-block">
            <div class="detail-title">ğŸ“Œ íšŒí•©</div>
            ${meets.length ? meets.map((it, idx)=>`
              <div class="small" style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                <div style="flex:1;min-width:0;">
                  â€¢ ${esc(it.title||"íšŒí•©")}${it.time?` Â· ${esc(it.time)}`:""}${it.importance?` Â· (${esc(it.importance)})`:""}
                </div>
                <div style="display:flex;gap:8px;flex:0 0 auto;">
                  <button class="mini-btn light" data-meet-edit="${it.id}">ìˆ˜ì •</button>
                  <button class="mini-btn light" data-meet-del="${it.id}">ì‚­ì œ</button>
                </div>
              </div>
            `).join("") : `<div class="small">ê¸°ë¡ ì—†ìŒ</div>`}
          </div>
        `;

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        meets.forEach(it=>{
          const editBtn = body.querySelector(`[data-meet-edit="${it.id}"]`);
          const delBtn  = body.querySelector(`[data-meet-del="${it.id}"]`);

          if (editBtn){
            editBtn.onclick = async ()=>{
              const newTitle = prompt("íšŒí•©ëª…", it.title || "");
              if (newTitle === null) return;
              const newTime = prompt("ì‹œê°„(ì˜ˆ: 19:30)", it.time || "");
              if (newTime === null) return;
              const newImp = prompt("ì¤‘ìš”ë„(ë‚®ìŒ/ë³´í†µ/ë†’ìŒ)", it.importance || "ë³´í†µ");
              if (newImp === null) return;

              try{
                await updateDoc(doc(db,"meetings", it.id),{
                  title: newTitle.trim(),
                  time: (newTime||"").trim(),
                  importance: (newImp||"ë³´í†µ").trim(),
                  updatedAt: serverTimestamp()
                });
                alert("ìˆ˜ì • ì™„ë£Œ");
                await refreshAll();
                // í˜„ì¬ ë‚ ì§œ ìƒì„¸ ë‹¤ì‹œ ì—´ì–´ ê°±ì‹ 
                openDayDetail(dateKey);
              }catch(e){
                alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e?.message || e));
              }
            };
          }

        if (delBtn){
          delBtn.onclick = async ()=>{
            if (!confirm("ì´ íšŒí•©ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            try{
              await deleteDoc(doc(db,"meetings", it.id));
              alert("ì‚­ì œ ì™„ë£Œ");
              await refreshAll();
              openDayDetail(dateKey);
            }catch(e){
              alert("ì‚­ì œ ì‹¤íŒ¨: " + (e?.message || e));
            }
          };
        }
      });
    }

      // íƒ­ ì´ë²¤íŠ¸
      tabbar.querySelectorAll(".tab").forEach(t=>{
        t.onclick = ()=>{
          const name = t.dataset.tab;
          setActive(name);
          if (name==="all") renderAll();
          if (name==="chant") renderChant();
          if (name==="activity") renderActivity();
          if (name==="meeting") renderMeeting();
        };
      });

      // ê¸°ë³¸ ì „ì²´
      renderAll();
    }

    function openDayDetail(dateKey){
      $("dayDetailTitle").textContent = `ì¼ì • ìƒì„¸ Â· ${dateKey}`;
      renderDayDetailTabs(dateKey);
      $("dayDetailModalLayer").style.display = "flex";
    }
    window.closeDayDetailModal = () => { $("dayDetailModalLayer").style.display = "none"; };

    /* ===== ì¼ì •: ë‹¬ë ¥ ë Œë”(ì™„ë£Œ í™œë™ë§Œ ë°°ì§€ í‘œì‹œ + ì§€ë¶€ í‘œì‹œ) ===== */
    async function loadMonthCalendar(){
      const cal = $("monthCalendar");
      if (!cal) return;
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      await buildMonthCache();

      const chantMinMap = {};
      const meetCountMap = {};
      const actBranchMap = {}; // dateKey -> { done:{branch:cnt}, todo:{branch:cnt} }

    Object.entries(cachedDayData.activitiesByDate).forEach(([k,arr])=>{
      const done = {};
      const todo = {};
      arr.forEach(it=>{
        const b = it.branch || "ë¯¸ì§€ì •";
        if (it.isDone === true) done[b] = (done[b]||0)+1;
        else todo[b] = (todo[b]||0)+1;
      });
      actBranchMap[k] = { done, todo };
    });

      const pack = actBranchMap[dateKey] || { done:{}, todo:{} };
      const doneEntries = Object.entries(pack.done).sort((a,b)=>b[1]-a[1]);
      const todoEntries = Object.entries(pack.todo).sort((a,b)=>b[1]-a[1]);

      // ëª¨ë°”ì¼/PC í‘œì‹œ ê°œìˆ˜ ì œí•œ(ê¸°ì¡´ take ë¡œì§ ì¬ì‚¬ìš©)
      const take = mobileView ? 1 : 2;

    // âœ… ì™„ë£Œ ë°°ì§€
    const doneTop = doneEntries.slice(0, take);
    let doneBadges = doneTop.map(([b,c])=>`<span class="badge act-badge act-done">âœ… ${esc(b)}Ã—${c}</span>`).join("");

    // â˜ ë¯¸ì™„ë£Œ ë°°ì§€
    const todoTop = todoEntries.slice(0, take);
    let todoBadges = todoTop.map(([b,c])=>`<span class="badge act-badge act-todo">â˜ ${esc(b)}Ã—${c}</span>`).join("");

    actBadges = doneBadges + todoBadges;

    // ë”ë³´ê¸° ê³„ì‚°(ë‘˜ í•©ì‚° ê¸°ì¤€)
    hiddenCount = Math.max(0, (doneEntries.length - take)) + Math.max(0, (todoEntries.length - take));


      Object.entries(cachedDayData.meetingsByDate).forEach(([k,arr])=>{
        meetCountMap[k] = arr.length;
      });

      cal.className = "month-calendar";
      cal.innerHTML = "";

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      weekdays.forEach(w=>{
        const h=document.createElement("div");
        h.className="weekday";
        h.textContent=w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay();
      for(let i=0;i<firstDayWeek;i++){
        const blank=document.createElement("div");
        blank.className="day-cell";
        blank.style.visibility="hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();
      const mobileView = window.matchMedia && window.matchMedia("(max-width: 520px)").matches;

      for(let day=1; day<=lastDate; day++){
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        const chantMin = chantMinMap[dateKey] || 0;
        const branchCounts = actBranchMapDone[dateKey] || null;
        const meetCount = meetCountMap[dateKey] || 0;

        let actBadges = "";
        let hiddenCount = 0;

        if (branchCounts){
          const entries = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1]);
          const take = mobileView ? 1 : 2;
          const top = entries.slice(0,take);
          hiddenCount = Math.max(0, entries.length - take);
          actBadges = top.map(([b,c])=>`<span class="badge act-badge">${esc(b)}Ã—${c}</span>`).join("");
        }

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actBadges}
          ${meetCount ? `<span class="badge meet-badge">íšŒí•© ${meetCount}ê±´</span>` : ``}
          ${hiddenCount>0 ? `<div class="more-hint">â€¦ ë”ë³´ê¸°</div>` : ``}
        `;
        cell.onclick = ()=> openDayDetail(dateKey);
        cal.appendChild(cell);
      }
    }

    /* =========================================================
       ìŠ¤í”¼ì¹˜ ê²Œì‹œíŒ (ëª¨ë“  ì‚¬ìš©ì ì‘ì„±/ìˆ˜ì •/ì‚­ì œ)
       - speeches: title, content, author(nickname), createdAt, updatedAt
    ========================================================= */
    let speechCache = []; // {id, ref, ...}

    function snippet(text, n=80){
      const t = String(text||"").trim();
      if (t.length<=n) return t;
      return t.slice(0,n) + "â€¦";
    }

    async function loadSpeechPreview(){
      const box = $("speechPreviewBox");
      if (!box) return;
      box.innerHTML = `<div class="small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

      const snap = await getDocs(collection(db,"speeches"));
      const list = [];
      snap.forEach(d=>{
        const x = d.data();
        list.push({ id:d.id, ref:d.ref, ...x });
      });
      list.sort((a,b)=> tsToMillis(b.createdAt) - tsToMillis(a.createdAt));
      speechCache = list;

      if (list.length===0){
        box.innerHTML = `
          <div class="speech-preview" onclick="openSpeechBoard()">
            <div class="speech-title">ìŠ¤í”¼ì¹˜ ê²Œì‹œíŒ</div>
            <div class="speech-meta">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”.</div>
            <div class="speech-snippet">í´ë¦­í•˜ì—¬ ê²Œì‹œê¸€ ì‘ì„±/ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        `;
        return;
      }

      const one = list[0];
      const dt = one.createdAt?.seconds ? new Date(one.createdAt.seconds*1000) : null;
      const meta = `${dt ? dt.toLocaleString() : ""} Â· ${esc(one.author||"")}`;

      box.innerHTML = `
        <div class="speech-preview" onclick="openSpeechBoard()">
          <div class="speech-title">${esc(one.title||"(ì œëª© ì—†ìŒ)")}</div>
          <div class="speech-meta">${meta}</div>
          <div class="speech-snippet">${esc(snippet(one.content||"", 110))}</div>
          <div class="small" style="margin-top:8px;">í´ë¦­í•˜ë©´ ì „ì²´ ê²Œì‹œê¸€ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      `;
    }

    window.openSpeechBoard = async ()=>{
      $("speechModalLayer").style.display = "flex";
      await renderSpeechBoard();
    };
    window.closeSpeechBoard = ()=>{ $("speechModalLayer").style.display = "none"; };

    async function renderSpeechBoard(){
      const listBox = $("speechList");
      listBox.innerHTML = `<div class="small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

      // ìµœì‹  ìºì‹œ ë°˜ì˜
      const snap = await getDocs(collection(db,"speeches"));
      const list = [];
      snap.forEach(d=>{
        const x = d.data();
        list.push({ id:d.id, ref:d.ref, ...x });
      });
      list.sort((a,b)=> tsToMillis(b.createdAt) - tsToMillis(a.createdAt));
      speechCache = list;

      if (list.length===0){
        listBox.innerHTML = `<div class="small">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      listBox.innerHTML = "";
      list.forEach(it=>{
        const dt = it.createdAt?.seconds ? new Date(it.createdAt.seconds*1000) : null;
        const meta = `${dt ? dt.toLocaleString() : ""} Â· ${esc(it.author||"")}`;
        const div = document.createElement("div");
        div.className = "speech-item";
        div.innerHTML = `
          <div class="speech-item-top">
            <div>
              <div style="font-weight:900;">${esc(it.title||"(ì œëª© ì—†ìŒ)")}</div>
              <div class="speech-meta">${meta}</div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="mini-btn light" data-edit="${it.id}" style="padding:8px 10px;">ìˆ˜ì •</button>
              <button class="mini-btn light" data-del="${it.id}" style="padding:8px 10px;">ì‚­ì œ</button>
            </div>
          </div>
          <div class="speech-snippet">${esc(snippet(it.content||"", 140))}</div>
        `;
        listBox.appendChild(div);

        div.onclick = (e)=>{
          // ë²„íŠ¼ í´ë¦­ì€ ë³„ë„
          if (e.target?.dataset?.edit || e.target?.dataset?.del) return;
          openSpeechDetail(it.id);
        };
        div.querySelector(`[data-edit="${it.id}"]`).onclick = (e)=>{ e.stopPropagation(); openSpeechEdit(it.id); };
        div.querySelector(`[data-del="${it.id}"]`).onclick = async (e)=>{
          e.stopPropagation();
          if (!confirm("ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
          try{
            await deleteDoc(doc(db,"speeches", it.id));
            await renderSpeechBoard();
            await loadSpeechPreview();
          }catch(err){
            alert("ì‚­ì œ ì‹¤íŒ¨: " + (err?.message||err));
          }
        };
      });
    }

    function openSpeechDetail(id){
      const it = speechCache.find(x=>x.id===id);
      if (!it) return;
      const dt = it.createdAt?.seconds ? new Date(it.createdAt.seconds*1000) : null;
      $("speechDetailTitle").textContent = it.title || "(ì œëª© ì—†ìŒ)";
      $("speechDetailMeta").textContent = `${dt ? dt.toLocaleString() : ""} Â· ${it.author||""}`;
      $("speechDetailContent").textContent = it.content || "";
      $("speechDetailLayer").style.display = "flex";
    }
    window.closeSpeechDetail = ()=>{ $("speechDetailLayer").style.display = "none"; };

    function openSpeechEdit(id){
      const it = speechCache.find(x=>x.id===id);
      if (!it) return;
      $("speechEditId").value = it.id;
      $("speechEditTitle").value = it.title || "";
      $("speechEditContent").value = it.content || "";
      $("speechEditLayer").style.display = "flex";
    }
    window.closeSpeechEdit = ()=>{ $("speechEditLayer").style.display = "none"; };

    window.openSpeechNew = ()=>{
      $("speechEditId").value = "";
      $("speechEditTitle").value = "";
      $("speechEditContent").value = "";
      $("speechEditLayer").style.display = "flex";
    };

    window.saveSpeech = async ()=>{
      const id = $("speechEditId").value.trim();
      const title = $("speechEditTitle").value.trim();
      const content = $("speechEditContent").value.trim();
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      if (!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

      try{
        if (!id){
          await addDoc(collection(db,"speeches"),{
            title, content,
            author: nickname,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        } else {
          await updateDoc(doc(db,"speeches", id),{
            title, content,
            updatedAt: serverTimestamp()
          });
        }
        closeSpeechEdit();
        await renderSpeechBoard();
        await loadSpeechPreview();
      }catch(err){
        alert("ì €ì¥ ì‹¤íŒ¨: " + (err?.message||err));
      }
    };

    /* ===== ìŠ¤ì¿¨: ì´ë‹¬ ì¼ì • (ì €ì¥ ì‹¤íŒ¨ ì›ì¸ ë…¸ì¶œ) ===== */

    const nextMonthYear = (monthIndex === 11) ? (monthYear + 1) : monthYear;
    const nextMonthIndex = (monthIndex === 11) ? 0 : (monthIndex + 1);
    const nextMonthKeyPrefix = `${nextMonthYear}-${String(nextMonthIndex+1).padStart(2,"0")}-`;

    function isInThisMonthOrNextMonth(dateKey){
      return typeof dateKey === "string" &&
        (dateKey.startsWith(monthKeyPrefix) || dateKey.startsWith(nextMonthKeyPrefix));
    }

    async function loadSchoolMonthSchedule(){
      const list = $("schoolMonthScheduleList");
      if (!list) return;

      list.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      const snap = await getDocs(collection(db,"schoolSchedules"));

      const items = [];
      snap.forEach(d=>{
       const x = d.data();
       if (x.dateKey && isInThisMonthOrNextMonth(x.dateKey)) {
         items.push({ id: d.id, ...x });
       }
      });

      items.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||""));

      if (items.length === 0){
        list.innerHTML = `<div class="small">ì´ë²ˆë‹¬/ë‹¤ìŒë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      list.innerHTML = "";
      items.forEach(it=>{
        const div=document.createElement("div");
        div.className="school-sched-item";
        div.innerHTML = `
          <div class="school-sched-top">
            <div class="school-sched-date">${esc(it.dateKey||"")}</div>
            ${isAdminMode() ? `<button class="mini-btn light" style="padding:8px 10px;font-size:.85rem;" data-edit="${it.id}">ìˆ˜ì •</button>` : ``}
          </div>
          <div><strong>${esc(it.title||"")}</strong></div>
          ${it.desc ? `<div class="small" style="margin-top:4px;">${esc(it.desc)}</div>` : ``}
        `;
        list.appendChild(div);

        if (isAdminMode()){
          const btn = div.querySelector(`[data-edit="${it.id}"]`);
          if (btn){
            btn.onclick = (e)=>{ 
              e.stopPropagation();
              openSchoolScheduleEditMenu(it.id, it); 
            };
          }
        }
      });
    }

    async function openSchoolScheduleEditMenu(id, current){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      // 1) ë©”ë‰´ ì„ íƒ
      const action = prompt(
        "ì‘ì—… ì„ íƒ: 1=ìˆ˜ì •, 2=ì‚­ì œ, (ì·¨ì†ŒëŠ” ë¹ˆì¹¸/Cancel)\n" +
        `ëŒ€ìƒ: ${current.dateKey || ""} Â· ${current.title || ""}`
      );

      if (action === null || action.trim() === "") return;

      // 2) ì‚­ì œ
      if (action.trim() === "2"){
        if (!confirm("ì´ ìŠ¤ì¿¨ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        try{
          await deleteDoc(doc(db,"schoolSchedules", id));
          alert("ì‚­ì œ ì™„ë£Œ");
          await loadSchoolMonthSchedule();
        }catch(e){
          alert("ì‚­ì œ ì‹¤íŒ¨: " + (e?.message || e));
        }
        return;
      }

      // 3) ìˆ˜ì •(ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©)
      if (action.trim() === "1"){
        await editSchoolSchedule(id, current);
        return;
      }  

      alert("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. 1 ë˜ëŠ” 2ë§Œ ì…ë ¥í•˜ì„¸ìš”.");
    }

    window.addSchoolSchedule = async () => {
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      // ì•ˆì •ì  ì…ë ¥: date input ì‚¬ìš© ëª¨ë‹¬ ëŒ€ì‹  ê°„ë‹¨ prompt ìœ ì§€ + ê²€ì¦ ê°•í™”
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ(YYYY-MM-DD)", todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", "") || "";

      try{
        await addDoc(collection(db,"schoolSchedules"),{
          dateKey,
          title: title.trim(),
          desc: desc.trim(),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        alert("ìŠ¤ì¿¨ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadSchoolMonthSchedule();
      }catch(e){
        alert("ìŠ¤ì¿¨ ì¼ì • ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e));
      }
    };

    async function editSchoolSchedule(id, current){
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      const dateKey = prompt("ìŠ¤ì¿¨ ì¼ì • ë‚ ì§œ(YYYY-MM-DD)", current.dateKey || todayKey);
      if (!dateKey || !/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");
      const title = prompt("ìŠ¤ì¿¨ ì¼ì • ì œëª©", current.title || "");
      if (!title) return alert("ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", current.desc || "") || "";

      try{
        await updateDoc(doc(db,"schoolSchedules",id),{
          dateKey,
          title: title.trim(),
          desc: desc.trim(),
          updatedAt: serverTimestamp()
        });
        alert("ìŠ¤ì¿¨ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadSchoolMonthSchedule();
      }catch(e){
        alert("ìŠ¤ì¿¨ ì¼ì • ìˆ˜ì • ì‹¤íŒ¨: " + (e?.message || e));
      }
    }

    /* ===== ìŠ¤ì¿¨: ì§„í–‰ë¥  + 20ì¹¸ ===== */
    async function loadThermometerForSchoolBranch(branch){
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";
      if (!branch){
        wrap.innerHTML = `<div class="small hint">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const confirmed = snap.docs.filter(d=> d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed/20)*100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${esc(branch)} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch){
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db,"school"), where("branch","==",branch)));
      const bySlot = new Map();
      snap.forEach(docu=>{
        const data = docu.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: docu.ref, ...data });
      });

      for (let slot=1; slot<=20; slot++){
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        toggle.innerHTML = confirmed ? "âœ…" : `<span class="tri">â–²</span>`;

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        toggle.onclick = async ()=>{
          const newStatus = !(existing?.confirmed === true);
          toggle.innerHTML = newStatus ? "âœ…" : `<span class="tri">â–²</span>`;

          try{
            if (existing?.ref){
              await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
              existing.confirmed = newStatus;
            } else {
              const newRef = await addDoc(collection(db,"school"),{
                branch, slot,
                confirmed: newStatus,
                name: (input.value||"").trim(),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
              existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value||"").trim() };
              bySlot.set(slot, existing);
            }
            await loadThermometerForSchoolBranch(branch);
          }catch(e){
            alert("ìŠ¤ì¿¨ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨: " + (e?.message||e));
          }
        };

        input.addEventListener("blur", async ()=>{
          const newName = (input.value||"").trim();
          try{
            if (existing?.ref){
              await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
              existing.name = newName;
            } else {
              const newRef = await addDoc(collection(db,"school"),{
                branch, slot,
                confirmed:false,
                name:newName,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
              existing = { ref: newRef, branch, slot, confirmed:false, name:newName };
              bySlot.set(slot, existing);
            }
          }catch(e){
            alert("ì´ë¦„ ì €ì¥ ì‹¤íŒ¨: " + (e?.message||e));
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);
        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ===== ê´€ë¦¬ì: í†µê³„/ë¦¬ì…‹ ===== */
    window.loadAdminStats = async ()=>{
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches){
        const [chantSnap, actSnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db,"chants"), where("branch","==",b))),
          getDocs(query(collection(db,"activities"), where("branch","==",b))),
          getDocs(query(collection(db,"school"), where("branch","==",b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d=> d.data().confirmed === true).length;
        const doneActs = actSnap.docs.filter(d=> d.data().isDone === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${esc(b)}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™(ì™„ë£Œ) ${doneActs}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    window.resetAllData = async ()=>{
      if (!isAdminMode()) return alert("ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©/ìŠ¤ì¿¨ì¼ì •/ìŠ¤í”¼ì¹˜)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants","activities","school","meetings","schoolSchedules","speeches"];
      try{
        for (const col of cols){
          const snap = await getDocs(collection(db,col));
          for (const d of snap.docs){
            await deleteDoc(d.ref);
          }
        }
        alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
        await refreshAll();
        showTab("home");
      }catch(e){
        alert("ë¦¬ì…‹ ì‹¤íŒ¨: " + (e?.message||e));
      }
    };

    /* ===== ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸° ===== */
    function bindModalOutsideClose(){
      document.addEventListener("click",(e)=>{
        const layers = ["meetingModalLayer","dayDetailModalLayer","speechModalLayer","speechDetailLayer","speechEditLayer"];
        for (const id of layers){
          const lay = $(id);
          if (lay && lay.style.display==="flex" && e.target===lay) lay.style.display="none";
        }
      });
    }

    /* ===== ì „ì²´ ìƒˆë¡œê³ ì¹¨ ===== */
    async function refreshAll(){
      await loadSpeechPreview();
      await loadTodaySummary();
      await loadHomeThermoCompact();
      await loadChantThermoDetailed();

      await loadActivityList();

      await loadMonthPlans();
      await loadMonthCalendar();

      await loadSchoolMonthSchedule();

      const selected = $("schoolBranchSelect").value;
      await loadThermometerForSchoolBranch(selected);
      await loadSchoolGrid(selected);

      applyAdminModeUI();
    }

    /* ===== ì´ˆê¸°í™” ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      applyAdminModeUI();
      bindModalOutsideClose();

      nickname = localStorage.getItem(nicknameKey) || "";
      if (!nickname){
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillSelect($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillSelect($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillSelect($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      // í™œë™ ë‚ ì§œ ê¸°ë³¸ê°’
      $("activityDateKey").value = todayKey;

      $("schoolBranchSelect").addEventListener("change", async (e)=>{
        const b = e.target.value;
        await loadThermometerForSchoolBranch(b);
        await loadSchoolGrid(b);
      });

      if (nickname) await refreshAll();
    });

    // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë‹¬ë ¥ ì¬ë Œë”
    window.addEventListener("resize", ()=>{
      clearTimeout(window.__rerT);
      window.__rerT = setTimeout(()=>{
        loadMonthCalendar();
      }, 180);
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <!-- ìŠ¤í”¼ì¹˜ ê²Œì‹œíŒ: ìµœê·¼ 1ê°œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ìŠ¤í”¼ì¹˜ ê²Œì‹œíŒ</strong>
          <div class="small">ìµœê·¼ ê¸€ 1ê°œ ë¯¸ë¦¬ë³´ê¸° Â· í´ë¦­í•˜ë©´ ì „ì²´ ëª©ë¡/ìƒì„¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <button class="mini-btn" onclick="openSpeechNew(); openSpeechBoard();" title="ê¸€ì“°ê¸°">+ ì‘ì„±</button>
      </div>
      <div id="speechPreviewBox"></div>
    </div>

    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>

    <div class="card">
      ì˜¤ëŠ˜ í•©ê³„<br>
      ğŸŒ± ì°½ì œ: <strong id="todayChantTotal">0ë¶„</strong><br>
      âœ… í™œë™(ì™„ë£Œ): <strong id="todayActivityTotal">0íšŒ</strong>
    </div>

    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint" style="margin-top:6px;">ì§€ë¶€ ì˜¨ë„ê³„ë¥¼ í´ë¦­í•˜ë©´ ì°½ì œ íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="homeThermoGrid" class="home-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <strong>ì°½ì œ ê¸°ë¡</strong>
      <div class="hint" style="margin-top:6px;">í•˜ë£¨ 3íšŒ ì œí•œ Â· ì§ì ‘ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©</div>
      <div style="height:10px;"></div>

      <div class="row">
        <select id="chantBranch"></select>
        <div style="display:grid; gap:8px;">
          <select id="chantMinutes">
            <option value="">ì‹œê°„ ì„ íƒ</option>
            <option value="10">10ë¶„</option>
            <option value="30">30ë¶„</option>
            <option value="60">60ë¶„</option>
          </select>
          <input id="chantMinutesCustom" type="number" min="1" step="1" placeholder="ì§ì ‘ ì…ë ¥(ë¶„) ì˜ˆ: 45" />
        </div>
      </div>

      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
    </div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="hint" style="margin-top:6px;">ì°½ì œ íƒ­ì—ì„œëŠ” ìƒì„¸/ìµœê·¼ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div style="height:12px;"></div>
      <div id="chantThermoGrid" class="thermo-grid-wrap"></div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <strong>í™œë™ ê³„íš ì¶”ê°€</strong>
      <div class="hint" style="margin-top:6px;">ì¶”ê°€ëœ í™œë™ì€ â€œë¯¸ì‹¤í–‰â€ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤. ì‹¤í–‰ ì™„ë£Œë¡œ ì²´í¬í•´ì•¼ ë‹¬ë ¥/ì˜¨ë„ê³„ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div style="height:10px;"></div>

      <select id="activityBranch"></select>
      <div style="height:10px;"></div>

      <input id="activityDateKey" placeholder="í™œë™ ë‚ ì§œ(YYYY-MM-DD)" />
      <div style="height:10px;"></div>

      <input id="activityDateKey" placeholder="ì‹œê°„(ì˜ˆ: 19:30) (ì„ íƒ)" />
      <div style="height:10px;"></div>
      
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>

      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>

      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>

      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ì¶”ê°€</button>
        const time = ($("activityTime").value || "").trim();
    </div>

    <div class="card">
      <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
      <div class="small">ì‹¤í–‰ ì™„ë£Œë¡œ ì²´í¬í•œ í•­ëª©ë§Œ ë‹¬ë ¥/ì˜¨ë„ê³„ ëˆ„ì ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div style="height:10px;"></div>
      <div id="activityList"></div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
          <div class="hint">ì™„ë£Œ/ë¯¸ì‹¤í–‰ ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="hint">ì™„ë£Œëœ í™œë™ë§Œ ë‹¬ë ¥ì— í‘œì‹œë©ë‹ˆë‹¤. ë‚ ì§œ í´ë¦­ ì‹œ ìƒì„¸ íƒ­ì´ ì—´ë¦½ë‹ˆë‹¤.</div>
        </div>
        <button class="mini-btn" onclick="openMeetingModal()">+ íšŒí•©</button>
      </div>
      <div id="monthCalendar" class="month-calendar"></div>
      <div class="small" style="margin-top:10px;">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ íƒ­(ì „ì²´/ì°½ì œ/í™œë™/íšŒí•©)ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ìŠ¤ì¿¨ ì¼ì •</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì¼ì • ì¶”ê°€/ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
        <button id="addSchoolScheduleBtn" class="mini-btn" onclick="addSchoolSchedule()" style="display:none;">+ ì¼ì • ì¶”ê°€</button>
      </div>
      <div id="schoolMonthScheduleList" class="school-sched-list"></div>
    </div>

    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="hint" style="margin-top:8px;">â–²(ë¯¸í™•ì •) / âœ…(í™•ì •) Â· ì´ë¦„ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì €ì¥</div>
    </div>

    <div class="card">
      <div id="schoolThermoWrap"></div>
      <div style="height:10px;"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
          <div class="hint">ê´€ë¦¬ì ëª¨ë“œ ON ì‹œ ë¶€ì—° ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <button id="adminModeBtn" class="mini-btn" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ON</button>
      </div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" autocomplete="off" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
      <div class="small" style="margin-top:10px;">ì´ ì°½ì—ëŠ” ë‹‰ë„¤ì„ ì…ë ¥ ì™¸ì— ë‹¤ë¥¸ ìš”ì†Œê°€ ì¶œë ¥ë˜ì§€ ì•Šë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- MEETING MODAL -->
  <div id="meetingModalLayer" class="modal-layer">
    <div class="modal">
      <h3>íšŒí•© ì¼ì • ì¶”ê°€</h3>
      <div class="grid">
        <input id="meetDate" placeholder="íšŒí•© ì¼ì •(YYYY-MM-DD)" />
        <input id="meetTitle" placeholder="íšŒí•©ëª…" />
        <input id="meetTime" placeholder="ì‹œê°„(ì˜ˆ: 19:30)" />
        <select id="meetImportance">
          <option value="ë‚®ìŒ">ì¤‘ìš”ë„: ë‚®ìŒ</option>
          <option value="ë³´í†µ" selected>ì¤‘ìš”ë„: ë³´í†µ</option>
          <option value="ë†’ìŒ">ì¤‘ìš”ë„: ë†’ìŒ</option>
        </select>
      </div>
      <div class="actions">
        <button class="cancel" onclick="closeMeetingModal()">ì·¨ì†Œ</button>
        <button class="ok" onclick="saveMeetingFromModal()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- DAY DETAIL MODAL (íƒ­) -->
  <div id="dayDetailModalLayer" class="modal-layer">
    <div class="modal">
      <h3 id="dayDetailTitle">ì¼ì • ìƒì„¸</h3>
      <div id="dayTabbar" class="tabbar"></div>
      <div id="dayDetailBody"></div>
      <div class="actions">
        <button class="cancel" onclick="closeDayDetailModal()">ë‹«ê¸°</button>
        <button class="ok" onclick="closeDayDetailModal()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- SPEECH BOARD MODAL -->
  <div id="speechModalLayer" class="modal-layer">
    <div class="modal">
      <div class="card-header">
        <div>
          <h3 style="margin:0;">ìŠ¤í”¼ì¹˜ ê²Œì‹œíŒ</h3>
          <div class="small">ì „ì²´ ê¸€ ëª©ë¡(í´ë¦­: ìƒì„¸), ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</div>
        </div>
        <button class="mini-btn" onclick="openSpeechNew()">+ ìƒˆ ê¸€</button>
      </div>
      <div id="speechList" class="speech-list"></div>
      <div class="actions">
        <button class="cancel" onclick="closeSpeechBoard()">ë‹«ê¸°</button>
        <button class="ok" onclick="closeSpeechBoard()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- SPEECH DETAIL MODAL -->
  <div id="speechDetailLayer" class="modal-layer">
    <div class="modal">
      <h3 id="speechDetailTitle">ì œëª©</h3>
      <div id="speechDetailMeta" class="small"></div>
      <div style="height:10px;"></div>
      <div id="speechDetailContent" style="white-space:pre-wrap;line-height:1.5;"></div>
      <div class="actions">
        <button class="cancel" onclick="closeSpeechDetail()">ë‹«ê¸°</button>
        <button class="ok" onclick="closeSpeechDetail()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- SPEECH EDIT MODAL -->
  <div id="speechEditLayer" class="modal-layer">
    <div class="modal">
      <h3>ìŠ¤í”¼ì¹˜ ì‘ì„±/ìˆ˜ì •</h3>
      <input type="hidden" id="speechEditId" />
      <div class="grid">
        <input id="speechEditTitle" placeholder="ì œëª©" />
        <textarea id="speechEditContent" placeholder="ë‚´ìš©"></textarea>
      </div>
      <div class="actions">
        <button class="cancel" onclick="closeSpeechEdit()">ì·¨ì†Œ</button>
        <button class="ok" onclick="saveSpeech()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // íƒ­ ì „í™˜ (ëª¨ë“ˆ ìŠ¤ì½”í”„ ë°–ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ ì „ì—­ ë˜í¼)
    function showTab(id){ window.showTab(id); }
  </script>
</body>
</html>




