<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.4rem;
      font-weight:bold
    }
    nav{
      display:flex;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      gap:6px;
      flex-wrap:wrap;
    }
    nav button{
      border:none;
      background:none;
      font-size:1rem;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
    }
    nav button:hover{ background:rgba(0,0,0,.05); }

    section{display:none;padding:20px}
    section.active{display:block}

    .card{
      background:rgba(255,255,255,.9);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px
    }

    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:9999;
    }

    /* ì¼ì • ë‹¬ë ¥ */
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .calendar-day{background:#fff;border-radius:8px;padding:6px;font-size:.75rem;text-align:center}

    /* ê³µí†µ ì…ë ¥ */
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      background:#fff;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
    }
    .btn.secondary{background:#444}
    .small{font-size:.9rem;opacity:.85}

    /* ===== í™ˆ: 3ì—´ ì˜¨ë„ê³„ ë ˆì´ì•„ì›ƒ ===== */
    .home-thermo-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .home-col{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 0;
    }
    .home-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 70px; /* ì¢Œ: ì •ë³´, ìš°: ì˜¨ë„ê³„ */
      gap: 10px;
      align-items: stretch;
    }
    .home-thermo-title{
      font-weight: 800;
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .home-thermo-meta{
      font-size: .88rem;
      opacity: .86;
      line-height: 1.35;
    }

    /* ===== â€œì•„ë˜â†’ìœ„ ì±„ì›€â€ 300ì¹¸(20x15) ì„¸ë¡œ ì˜¨ë„ê³„ ===== */
    .thermo{
      width: 70px;
      height: 210px;
      border-radius: 14px;
      background: rgba(0,0,0,.06);
      padding: 6px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      display:flex;
      align-items: stretch;
      justify-content: center;
    }
    .thermo-grid{
      width: 100%;
      height: 100%;
      display:grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.04); /* ê²©ì ê°„ê·¹ ë°°ê²½ */
      border-radius: 10px;
      padding: 1px;
      box-sizing: border-box;
    }
    .cell{
      background: rgba(255,255,255,.55);
      border-radius: 1px;
    }
    .cell.filled{
      /* JSì—ì„œ ê°œë³„ ìƒ‰ìƒ ì¸ë¼ì¸ ì ìš© */
      background: #ff6aa2;
    }

    /* ìŠ¤ì¿¨(ì§€ë¶€ ì„ íƒ+20ì¹¸ í† ê¸€) */
    .school-wrap{display:grid;gap:12px}
    #schoolGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .school-member{
      background:#fff;
      padding:12px 8px;
      border-radius:12px;
      text-align:center;
      font-size:1.2rem;
      cursor:pointer;
      user-select:none;
      border:1px solid rgba(0,0,0,.06);
    }
    .school-member:hover{ background: rgba(0,0,0,.03); }

    /* ìŠ¤ì¿¨ ì§„í–‰ë¥  ë°”(ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:700;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }
  </style>

  <!-- Firebase SDK (v9 module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const todayKey = new Date().toISOString().slice(0,10);
    const nicknameKey = "wolbaehwayang_nickname";
    let nickname = localStorage.getItem(nicknameKey) || "";

    /* í™ˆ ì˜¨ë„ê³„ ì„¤ì • */
    const HOME_THERMO_CELLS = 300;   // 300ì¹¸
    const HOME_CELL_UNIT_MIN = 10;   // 1ì¹¸ = 10ë¶„ (ì›í•˜ì‹œë©´ 1, 5, 20 ë“±ìœ¼ë¡œ ë³€ê²½)

    /* í™ˆ 3ì—´ ë°°ì¹˜(ìš”ì²­í•˜ì‹  ìˆœì„œ/êµ¬ì„± ê³ ì •) */
    const HOME_COLUMNS = [
      ["ë‹¬ë¹„","ìƒì¸","ì›ë•"],
      ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"],
      ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"]
    ];

    /* DOM í—¬í¼ */
    const $ = (id) => document.getElementById(id);

    function fillBranchOptions(selectEl, placeholder="ì§€ë¶€ ì„ íƒ") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        selectEl.appendChild(opt);
      });
    }

    /* íƒ­ ì „í™˜: ë°˜ë“œì‹œ ì „ì—­(window)ì— ë…¸ì¶œ */
    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
    };

    /* ë‹‰ë„¤ì„ ì €ì¥: ì „ì—­ */
    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    /* ì°½ì œ ê¸°ë¡ (1ì¼ 3íšŒ ì œí•œ) */
    window.saveChant = async () => {
      const minutes = Number($("chantMinutes").value);
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(
        collection(db, "chants"),
        where("nickname", "==", nickname),
        where("dateKey", "==", todayKey)
      );
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "chants"), {
        nickname,
        branch,
        minutes,
        blocks: minutes / 10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived: false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      window.showTab("home");
    };

    /* í™œë™ ê¸°ë¡ (1íšŒ = 20ë¶„ í™˜ì‚°) */
    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "activities"), {
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      window.showTab("home");
    };

    /* ì˜¤ëŠ˜ í•©ê³„ + ìƒì„¸ */
    async function loadTodaySummary() {
      const chantSnap = await getDocs(query(collection(db, "chants"), where("dateKey", "==", todayKey)));
      const activitySnap = await getDocs(query(collection(db, "activities"), where("dateKey", "==", todayKey)));

      let total = 0;
      let detail = "";

      chantSnap.forEach(d => {
        const { nickname: n, branch, minutes } = d.data();
        total += Number(minutes) || 0;
        detail += `ğŸŒ± ${branch} - ${minutes}ë¶„ (${n})<br>`;
      });

      activitySnap.forEach(d => {
        const { branch, subject, target } = d.data();
        total += 20;
        detail += `ğŸ”¥ ${branch} - ${subject} â†’ ${target} (20ë¶„)<br>`;
      });

      $("todayTotal").innerHTML = `${total}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* ì¼ì • ë‹¬ë ¥ (ì°½ì œ+í™œë™ ì·¨í•©) */
    async function loadCalendar() {
      const map = {};

      const chantSnap = await getDocs(collection(db, "chants"));
      chantSnap.forEach(d => {
        const { dateKey, minutes } = d.data();
        if (!dateKey) return;
        map[dateKey] = (map[dateKey] || 0) + (Number(minutes) || 0);
      });

      const actSnap = await getDocs(collection(db, "activities"));
      actSnap.forEach(d => {
        const { dateKey } = d.data();
        if (!dateKey) return;
        map[dateKey] = (map[dateKey] || 0) + 20;
      });

      const cal = $("calendar");
      cal.innerHTML = "";
      Object.keys(map).sort().forEach(k => {
        const div = document.createElement("div");
        div.className = "calendar-day";
        div.innerHTML = `<strong>${k}</strong><br>${map[k]}ë¶„`;
        cal.appendChild(div);
      });
    }

    /* ===== í™ˆ: ëˆ„ì  ì§€ë¶€ë³„ ì˜¨ë„ê³„(300ì¹¸) ===== */

    // ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ(ì•„ë˜ê°€ ì§„í•˜ê³  ìœ„ê°€ ì—°í•´ì§€ë„ë¡): t=0(ì•„ë˜) -> t=1(ìœ„)
    function gradientColor(t) {
      // í•‘í¬/ë§ˆì  íƒ€ ê³„ì—´ë¡œ ë¶€ë“œëŸ½ê²Œ ë³´ì´ë„ë¡ HSL ì‚¬ìš©
      // hue=330 ê·¼ì²˜, ì•„ë˜ëŠ” ì±„ë„/ëª…ë„ ë” ê°•í•˜ê²Œ
      const hue = 330;
      const sat = 90 - Math.round(t * 25);   // 90 -> 65
      const light = 45 + Math.round(t * 30); // 45 -> 75
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    function buildThermoGridHTML(filledCells) {
      // 20x15 = 300ì¹¸
      const total = HOME_THERMO_CELLS;
      const startFilledPos = total - filledCells + 1; // ì´ positionë¶€í„° ì±„ì›€(ì•„ë˜ìª½ë¶€í„°)

      let html = `<div class="thermo"><div class="thermo-grid">`;
      for (let pos = 1; pos <= total; pos++) {
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled) {
          html += `<div class="cell"></div>`;
        } else {
          // ì•„ë˜ìª½(ì§„) -> ìœ„ìª½(ì—°): posê°€ í´ìˆ˜ë¡ ì•„ë˜ìª½
          // filled ì˜ì—­ ë‚´ì—ì„œ ìœ„ìª½ì¼ìˆ˜ë¡ tê°€ ì»¤ì§€ë„ë¡ ê³„ì‚°
          const rankFromBottom = (total - pos);      // ì•„ë˜ìª½ì¼ìˆ˜ë¡ 0ì— ê°€ê¹Œì›€
          const t = Math.min(1, Math.max(0, rankFromBottom / (total - 1)));
          const color = gradientColor(t);
          html += `<div class="cell filled" style="background:${color};"></div>`;
        }
      }
      html += `</div></div>`;
      return html;
    }

    async function loadHomeThermometersCumulative() {
      const grid = $("homeThermoGrid");
      if (!grid) return;

      // UX: ë¡œë”© í‘œì‹œ
      grid.innerHTML = `<div class="small">ëˆ„ì  ì˜¨ë„ê³„ ì§‘ê³„ ì¤‘...</div>`;

      // ì§€ë¶€ë³„ í•©ê³„ 0ìœ¼ë¡œ ì´ˆê¸°í™”(ê¸°ë¡ ì—†ëŠ” ì§€ë¶€ë„ ë°˜ë“œì‹œ í‘œì‹œ)
      const sumByBranch = {};
      branches.forEach(b => sumByBranch[b] = 0);

      // ì„±ëŠ¥: ì»¬ë ‰ì…˜ ê°ê° 1íšŒ ì¡°íšŒ í›„ í”„ëŸ°íŠ¸ì—ì„œ í•©ì‚°
      const [chantSnap, actSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities"))
      ]);

      chantSnap.forEach(d => {
        const { branch, minutes } = d.data();
        if (branch && sumByBranch[branch] != null) sumByBranch[branch] += (Number(minutes) || 0);
      });

      actSnap.forEach(d => {
        const { branch } = d.data();
        if (branch && sumByBranch[branch] != null) sumByBranch[branch] += 20; // í™œë™=20ë¶„
      });

      // ë Œë”ë§: 3ì—´ ê³ ì • ë°°ì¹˜(ìš”ì²­í•˜ì‹  ê·¸ë£¹ ê·¸ëŒ€ë¡œ)
      grid.innerHTML = "";
      HOME_COLUMNS.forEach((colBranches) => {
        const col = document.createElement("div");
        col.className = "home-col";

        colBranches.forEach((branch) => {
          const totalMin = sumByBranch[branch] || 0;

          // 300ì¹¸ìœ¼ë¡œ í™˜ì‚°(ì•„ë˜â†’ìœ„ ì±„ì›€)
          const filledCells = Math.min(HOME_THERMO_CELLS, Math.floor(totalMin / HOME_CELL_UNIT_MIN));
          const capacityMin = HOME_THERMO_CELLS * HOME_CELL_UNIT_MIN;

          const card = document.createElement("div");
          card.className = "home-thermo-card";
          card.innerHTML = `
            <div>
              <div class="home-thermo-title">
                <span>${branch}</span>
                <span class="small">${filledCells}/${HOME_THERMO_CELLS}ì¹¸</span>
              </div>
              <div class="home-thermo-meta">
                ëˆ„ì : <strong>${totalMin}</strong>ë¶„<br>
                ê¸°ì¤€: 1ì¹¸=${HOME_CELL_UNIT_MIN}ë¶„ (ìµœëŒ€ ${capacityMin}ë¶„)
              </div>
            </div>
            <div>
              ${buildThermoGridHTML(filledCells)}
            </div>
          `;
          col.appendChild(card);
        });

        grid.appendChild(col);
      });
    }

    /* ===== ìŠ¤ì¿¨(ì„ íƒ ì§€ë¶€ ì§„í–‰ë¥  + 20ì¹¸ í† ê¸€) ===== */
    async function loadThermometerForBranch(branch) {
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";

      if (!branch) {
        wrap.innerHTML = `<div class="small">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ (ìŠ¤ì¿¨)ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));
      const confirmed = snap.docs.filter(d => d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed / 20) * 100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${branch} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch) {
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));

      const bySlot = new Map();
      snap.forEach(doc => {
        const data = doc.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: doc.ref, ...data });
      });

      for (let i = 1; i <= 20; i++) {
        const existing = bySlot.get(i) || null;
        const confirmed = existing?.confirmed === true;

        const cell = document.createElement("div");
        cell.className = "school-member";
        cell.textContent = confirmed ? "âœ…" : "â–³";

        cell.onclick = async () => {
          const newStatus = !(existing?.confirmed === true);
          cell.textContent = newStatus ? "âœ…" : "â–³";

          if (existing?.ref) {
            await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot: i,
              confirmed: newStatus,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            bySlot.set(i, { ref: newRef, branch, slot: i, confirmed: newStatus });
          }

          await loadThermometerForBranch(branch);
        };

        grid.appendChild(cell);
      }
    }

    /* ê´€ë¦¬ì: í†µê³„ */
    window.loadAdminStats = async () => {
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches) {
        const [chantSnap, activitySnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db, "chants"), where("branch", "==", b))),
          getDocs(query(collection(db, "activities"), where("branch", "==", b))),
          getDocs(query(collection(db, "school"), where("branch", "==", b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d => d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${b}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${activitySnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    /* ê´€ë¦¬ì: ì „ì²´ ë¦¬ì…‹(ì£¼ì˜: ë³´ì•ˆ ê·œì¹™/ê¶Œí•œ í•„ìš”) */
    window.resetAllData = async () => {
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants", "activities", "school"];
      for (const col of cols) {
        const snap = await getDocs(collection(db, col));
        for (const d of snap.docs) {
          await deleteDoc(d.ref);
        }
      }

      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      window.showTab("home");
    };

    async function refreshAll() {
      await loadTodaySummary();
      await loadCalendar();
      await loadHomeThermometersCumulative(); // í™ˆ ëˆ„ì  ì˜¨ë„ê³„

      const selected = $("schoolBranchSelect").value;
      await loadThermometerForBranch(selected);
      await loadSchoolGrid(selected);
    }

    /* ì´ˆê¸° DOM ì„¸íŒ… */
    document.addEventListener("DOMContentLoaded", async () => {
      if (!nickname) {
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillBranchOptions($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      if (nickname) {
        await refreshAll();
      } else {
        // ë‹‰ë„¤ì„ ì—†ëŠ” ìƒíƒœì—ì„œë„ í™ˆ ì˜¨ë„ê³„ëŠ” í‘œì‹œí• ì§€ ì—¬ë¶€ ì„ íƒ ê°€ëŠ¥
        // ì›í•˜ì‹œë©´ ì—¬ê¸°ì„œë„ loadHomeThermometersCumulative()ë¥¼ í˜¸ì¶œí•´ í•­ìƒ ê³µê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      }

      $("schoolBranchSelect").addEventListener("change", async (e) => {
        const branch = e.target.value;
        await loadThermometerForBranch(branch);
        await loadSchoolGrid(branch);
      });
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>
    <div class="card">ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong></div>
    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„ (300ì¹¸, ì•„ë˜â†’ìœ„ ì±„ì›€)</strong>
      <div class="small" style="margin-top:6px;">
        ì°½ì œ(ë¶„) + í™œë™(20ë¶„ í™˜ì‚°) ëˆ„ì  í•©ì‚°. 1ì¹¸=10ë¶„(ê¸°ë³¸).
      </div>
      <div style="height:12px;"></div>

      <!-- 3ì—´ ê³ ì • ë°°ì¹˜ -->
      <div id="homeThermoGrid" class="home-thermo-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <div class="row">
        <select id="chantBranch"></select>
        <select id="chantMinutes">
          <option value="">ì‹œê°„ ì„ íƒ</option>
          <option value="10">10ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="60">60ë¶„</option>
        </select>
      </div>
      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
      <div class="small" style="margin-top:8px;">í•˜ë£¨ 3íšŒ ì œí•œ</div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <select id="activityBranch"></select>
      <div style="height:10px;"></div>
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>
      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>
      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveActivity()">í™œë™ ê¸°ë¡ ğŸ”¥</button>
      <div class="small" style="margin-top:8px;">í™œë™ 1íšŒ = 20ë¶„ í™˜ì‚°</div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card"><strong>ì˜¤ëŠ˜ì˜ ê³„íš / ì¼ì •</strong><br>â€¢ ì°½ì œ ë° í™œë™ ê¸°ë¡</div>
    <div class="card">
      <strong>ì „ì²´ ë‹¬ë ¥(ì°½ì œ+í™œë™ í™˜ì‚°)</strong>
      <div style="height:10px;"></div>
      <div id="calendar" class="calendar"></div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸ â–³/âœ…)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="small" style="margin-top:8px;">ì¹¸ì„ í´ë¦­í•˜ë©´ â–³/âœ… í† ê¸€ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="card school-wrap">
      <div id="schoolThermoWrap"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
      <div class="small" style="margin-top:6px;">ë³´ì•ˆ ê·œì¹™/ê¶Œí•œ ì„¤ì • ì „ì—ëŠ” ì™¸ë¶€ ë…¸ì¶œì— ì£¼ì˜í•˜ì„¸ìš”.</div>
      <div style="height:12px;"></div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
    </div>
  </div>
</body>
</html>
