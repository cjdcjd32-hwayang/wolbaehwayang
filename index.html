<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸŒ¸ Wolbaehwayang</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #fafafa;
  padding: 16px;
  margin: 0;
}
h1, h2, h3 { margin-top: 0; }
.card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}
button {
  background: #ffb7c5;
  border: none;
  border-radius: 8px;
}
button.admin {
  background: #ddd;
}
.hidden { display: none; }

.thermo {
  height: 180px;
  width: 36px;
  border-radius: 18px;
  background: #eee;
  overflow: hidden;
  margin: 12px auto;
}
.fill {
  width: 100%;
  height: 0%;
  background: linear-gradient(to top, #ff4d4d, #ffd84d, #4da6ff);
  transition: height 0.4s;
}

.rank-item {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
}
</style>
</head>

<body>

<h1>ğŸŒ¸ Wolbaehwayang</h1>

<!-- ë¡œê·¸ì¸ -->
<div class="card" id="loginCard">
  <h3>ë‹‰ë„¤ì„</h3>
  <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
  <button id="loginBtn">ì…ì¥</button>
</div>

<!-- ê´€ë¦¬ì -->
<div class="card">
  <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
  <input id="adminPw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
  <button class="admin" id="adminLoginBtn">ê´€ë¦¬ì ì…ì¥</button>
</div>

<!-- ì°½ì œ -->
<div class="card hidden" id="chantCard">
  <h3>ğŸŒ¸ ì°½ì œ ê¸°ë¡</h3>
  <select id="branch">
    <option value="">ì§€ë¶€ ì„ íƒ</option>
    <option>ë‹¬ë¹„</option><option>ìƒì¸</option><option>ì›ë•</option>
    <option>ëŒ€ê³¡</option><option>ì›”ë°°</option><option>ìœ ì²œ</option>
    <option>ì§„ì²œ</option><option>ì˜ë‚¨</option><option>ì˜¥í¬</option><option>í™”ì›</option>
  </select>
  <select id="time">
    <option value="">ì‹œê°„</option>
    <option value="10">10ë¶„</option>
    <option value="30">30ë¶„</option>
    <option value="60">1ì‹œê°„</option>
  </select>
  <button id="saveChant">ì €ì¥</button>
</div>

<!-- ì˜¤ëŠ˜ -->
<div class="card">
  <h3>ì˜¤ëŠ˜ì˜ ì˜¨ë„ê³„</h3>
  <p>ì´ <strong id="todayBlocks">0</strong> ì¹¸</p>
  <div class="thermo"><div class="fill" id="todayFill"></div></div>
</div>

<!-- ì›”ê°„ -->
<div class="card">
  <h3>ì›”ê°„ ì˜¨ë„ê³„</h3>
  <p>ì´ <strong id="monthBlocks">0</strong> ì¹¸</p>
  <div class="thermo"><div class="fill" id="monthFill"></div></div>
</div>

<!-- ì§€ë¶€ í•©ê³„ -->
<div class="card">
  <h3>ì§€ë¶€ë³„ í•©ê³„</h3>
  <div id="branchStats"></div>
</div>

<!-- ë­í‚¹ -->
<div class="card">
  <h3>ğŸ† ì „ì²´ ë­í‚¹</h3>
  <div id="ranking"></div>
</div>

<!-- ê´€ë¦¬ì íŒ¨ë„ -->
<div class="card hidden" id="adminPanel">
  <h3>ê´€ë¦¬ì ì„¤ì •</h3>
  <button class="admin" id="resetToday">ì˜¤ëŠ˜ ë¦¬ì…‹</button>
  <button class="admin" id="resetMonth">ì›”ê°„ ë¦¬ì…‹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
  authDomain: "wolbaehwayang-d1787.firebaseapp.com",
  projectId: "wolbaehwayang-d1787"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const nicknameKey = "nickname";
const adminKey = "admin";

const loginBtn = document.getElementById("loginBtn");
const chantCard = document.getElementById("chantCard");

loginBtn.onclick = () => {
  const name = nicknameInput.value.trim();
  if (!name) return;
  localStorage.setItem(nicknameKey, name);
  chantCard.classList.remove("hidden");
};

adminLoginBtn.onclick = () => {
  if (adminPw.value === "1234") {
    localStorage.setItem(adminKey, "true");
    adminPanel.classList.remove("hidden");
  }
};

saveChant.onclick = async () => {
  const name = localStorage.getItem(nicknameKey);
  const minutes = Number(time.value);
  if (!name || !minutes) return;

  await addDoc(collection(db, "chants"), {
    nickname: name,
    branch: branch.value,
    blocks: minutes / 10,
    date: new Date().toISOString().slice(0,7)
  });
  loadAll();
};

async function loadAll() {
  const snap = await getDocs(collection(db, "chants"));
  let today = 0, month = 0;
  let branchSum = {}, userSum = {};

  snap.forEach(d => {
    const b = d.data().blocks;
    today += b;
    month += b;
    branchSum[d.data().branch] = (branchSum[d.data().branch] || 0) + b;
    userSum[d.data().nickname] = (userSum[d.data().nickname] || 0) + b;
  });

  todayBlocks.innerText = today;
  monthBlocks.innerText = month;
  todayFill.style.height = Math.min(today*5,100)+"%";
  monthFill.style.height = Math.min(month*3,100)+"%";

  branchStats.innerHTML = Object.entries(branchSum)
    .map(([k,v]) => `<div>${k}: ${v}ì¹¸</div>`).join("");

  ranking.innerHTML = Object.entries(userSum)
    .sort((a,b)=>b[1]-a[1])
    .map(([k,v],i)=>`<div class="rank-item">${i+1}. ${k}<span>${v}</span></div>`)
    .join("");
}

loadAll();
</script>

</body>
</html>
