<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.4rem;
      font-weight:bold
    }
    nav{
      display:flex;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      gap:6px;
      flex-wrap:wrap;
    }
    nav button{
      border:none;
      background:none;
      font-size:1rem;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
    }
    nav button:hover{ background:rgba(0,0,0,.05); }

    section{display:none;padding:20px}
    section.active{display:block}

    .card{
      background:rgba(255,255,255,.9);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px
    }

    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:9999;
    }

    /* ê³µí†µ ì…ë ¥ */
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      background:#fff;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
    }
    .btn.secondary{background:#444}
    .small{font-size:.9rem;opacity:.85}

    /* ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ë³´ì´ëŠ” ì„¤ëª… */
    .admin-only{ display:none; }
    .admin-mode .admin-only{ display:block; }

    /* ===== í™ˆ/ì°½ì œ: 3ì—´ ì˜¨ë„ê³„ ë ˆì´ì•„ì›ƒ ===== */
    .thermo-grid-wrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .thermo-col{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 0;
    }

    .branch-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 92px;
      gap: 10px;
      align-items: stretch;
      cursor:pointer;
      user-select:none;
    }
    .branch-thermo-card:hover{
      background: rgba(0,0,0,.02);
    }
    .branch-thermo-title{
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .branch-thermo-meta{
      font-size: .88rem;
      opacity: .86;
      line-height: 1.35;
    }
    .recent-list{
      margin-top:8px;
      font-size:.84rem;
      line-height:1.35;
      opacity:.92;
    }
    .recent-item{
      padding:3px 0;
      border-bottom:1px dashed rgba(0,0,0,.08);
    }
    .recent-item:last-child{ border-bottom:none; }

    /* ===== ì‹¤ì œ ì˜¨ë„ê³„ í”„ë ˆì„(íŠœë¸Œ+ë²Œë¸Œ) ===== */
    .thermo-frame{
      width: 92px;
      height: 252px;
      position: relative;
      display:flex;
      align-items: flex-start;
      justify-content: center;
      box-sizing: border-box;
    }
    .tube{
      width: 60px;
      height: 192px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      border: 2px solid rgba(0,0,0,.12);
      position: relative;
      z-index: 2;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px;
      box-sizing: border-box;
      overflow:hidden;
    }
    .bulb{
      width: 82px;
      height: 82px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 2px solid rgba(0,0,0,.12);
      position:absolute;
      bottom: 0;
      z-index: 1;
      overflow:hidden;
    }
    .bulb-fill{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:0%;
      border-radius: 999px;
      transition: height .35s ease;
    }

    /* í…Œë§ˆ(ì—´ë³„) í”„ë ˆì„ í†¤ */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }

    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }

    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* ===== íŠœë¸Œ ê²©ì 300ì¹¸(20x15) ===== */
    .tube-grid{
      width: 100%;
      height: 100%;
      display:grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.05);
      border-radius: 12px;
      padding: 2px;
      box-sizing: border-box;
    }
    .cell{
      background: rgba(255,255,255,.55);
      border-radius: 1px;
    }

    /* ===== ì¼ì • íƒ­ ===== */
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:10px;
      padding:8px 10px;
      font-size:.85rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
    }
    .mini-btn:hover{ opacity:.92; }

    .plan-list{
      display:grid;
      gap:10px;
    }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{
      font-weight:900;
      margin-bottom:4px;
    }
    .plan-meta{
      font-size:.86rem;
      opacity:.88;
    }

    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:800;
      text-align:center;
      opacity:.8;
      padding: 4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:72px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.25;
      position:relative;
      overflow:hidden;
    }
    .day-num{
      font-weight:900;
      font-size:.9rem;
      margin-bottom:4px;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
    }
    .meet-badge{ background:rgba(194,24,91,.10); }

    /* ===== ìŠ¤ì¿¨ íƒ­ ===== */
    .school-wrap{display:grid;gap:12px}
    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      box-sizing:border-box;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .slot-num{
      font-weight:900;
      font-size:.9rem;
      opacity:.8;
    }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.05rem;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(0,0,0,.05);
    }
    .slot-toggle.pending{
      color:#6b7280; /* íšŒìƒ‰ */
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }

    .slot-input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.92rem;
      background: rgba(255, 246, 224, .9); /* í°ìƒ‰ ì•„ë‹Œ ì—°í•œ í¬ë¦¼ í†¤ */
    }

    /* ìŠ¤ì¿¨ ì§„í–‰ë¥  ë°” */
    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:700;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);

    const nicknameKey = "wolbaehwayang_nickname";
    let nickname = localStorage.getItem(nicknameKey) || "";

    /* ê´€ë¦¬ì ëª¨ë“œ */
    const adminModeKey = "wol_admin_mode";
    let adminMode = localStorage.getItem(adminModeKey) === "true";

    /* ëˆ„ì  ì˜¨ë„ê³„ ì„¤ì • */
    const HOME_THERMO_CELLS = 300;     // íŠœë¸Œ ê²©ì 300ì¹¸ ìœ ì§€(ìš”ì²­)
    const HOME_CELL_UNIT_MIN = 10;     // 1ì¹¸=10ë¶„
    const BULB_SHARE = 0.12;           // ë²Œë¸Œì— ë¨¼ì € ì±„ìš¸ ë¹„ì¤‘(ëŒ€ëµ 12%)
    const RECENT_PER_BRANCH = 3;       // ì§€ë¶€ë³„ ìµœê·¼ ê¸°ë¡ í‘œì‹œ ê°œìˆ˜

    /* 3ì—´ ë°°ì¹˜ */
    const THERMO_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    /* ì´ë‹¬ ê³„ì‚° */
    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth();
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`;

    const $ = (id) => document.getElementById(id);

    function setAdminModeUI() {
      document.body.classList.toggle("admin-mode", adminMode);
      const btn = $("adminModeBtn");
      if (btn) btn.textContent = adminMode ? "ê´€ë¦¬ì ëª¨ë“œ: ON" : "ê´€ë¦¬ì ëª¨ë“œ: OFF";
    }

    window.toggleAdminMode = () => {
      adminMode = !adminMode;
      localStorage.setItem(adminModeKey, String(adminMode));
      setAdminModeUI();
    };

    function fillBranchOptions(selectEl, placeholder="ì§€ë¶€ ì„ íƒ") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        selectEl.appendChild(opt);
      });
    }

    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
    };

    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    /* í™ˆ/ì°½ì œ ì˜¨ë„ê³„ í´ë¦­ â†’ ì°½ì œ íƒ­ ì´ë™ + ì§€ë¶€ ì„ íƒ */
    function goToChantWithBranch(branch) {
      window.showTab("chant");
      const sel = $("chantBranch");
      if (sel) sel.value = branch;
      // UX: ìŠ¤í¬ë¡¤ ë§¨ ìœ„
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    window.saveChant = async () => {
      const minutes = Number($("chantMinutes").value);
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(
        collection(db, "chants"),
        where("nickname", "==", nickname),
        where("dateKey", "==", todayKey)
      );
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "chants"), {
        nickname,
        branch,
        minutes,
        blocks: minutes / 10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived: false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      window.showTab("home");
    };

    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "activities"), {
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê³„íš ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      window.showTab("schedule");
    };

    async function loadTodaySummary() {
      const chantSnap = await getDocs(query(collection(db, "chants"), where("dateKey", "==", todayKey)));
      const activitySnap = await getDocs(query(collection(db, "activities"), where("dateKey", "==", todayKey)));

      let total = 0;
      let detail = "";

      chantSnap.forEach(d => {
        const { nickname: n, branch, minutes } = d.data();
        total += Number(minutes) || 0;
        detail += `ğŸŒ± ${branch} - ${minutes}ë¶„ (${n})<br>`;
      });

      activitySnap.forEach(d => {
        const { branch, subject, target } = d.data();
        total += 20;
        detail += `ğŸ”¥ ${branch} - ${subject} â†’ ${target} (20ë¶„)<br>`;
      });

      $("todayTotal").innerHTML = `${total}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    function isInThisMonth(dateKey) {
      return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ===== ì˜¨ë„ê³„ ìƒ‰ìƒ(í…Œë§ˆë³„) ===== */
    function themeHue(theme) {
      if (theme === "theme-blue") return 210;
      if (theme === "theme-yellow") return 48;
      return 330; // pink
    }
    function gradientColor(theme, t) {
      const hue = themeHue(theme);
      const sat = 92 - Math.round(t * 28);
      const light = 42 + Math.round(t * 34);
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    /* ===== ë²Œë¸Œë¶€í„° ì±„ìš°ê¸° =====
      - filledCellsë¥¼ ë²Œë¸Œ/íŠœë¸Œì— ë¶„ë°°
      - ë²Œë¸ŒëŠ” ë†’ì´ë¡œ ì±„ì›€(0~100%)
      - íŠœë¸Œ ê²©ìëŠ” ë²Œë¸Œê°€ ì¼ì • ìˆ˜ì¤€ ì°¬ ë’¤ë¶€í„° ì±„ì›€
    */
    function computeBulbAndTubeFill(filledCells) {
      const bulbCap = Math.max(1, Math.round(HOME_THERMO_CELLS * BULB_SHARE)); // ì˜ˆ: 36ì¹¸ ì •ë„
      const tubeCapLogical = HOME_THERMO_CELLS - bulbCap;

      const bulbFilled = Math.min(bulbCap, filledCells);
      const tubeFilledLogical = Math.max(0, filledCells - bulbCap);

      // íŠœë¸ŒëŠ” 300ì¹¸ ê²©ì ìœ ì§€: logicalì„ 300ì¹¸ìœ¼ë¡œ ìŠ¤ì¼€ì¼í•´ì„œ í‘œì‹œ
      const tubeFilledVisual = Math.min(
        HOME_THERMO_CELLS,
        Math.floor((tubeFilledLogical / Math.max(1, tubeCapLogical)) * HOME_THERMO_CELLS)
      );

      const bulbPct = Math.round((bulbFilled / bulbCap) * 100);

      return { bulbPct, tubeFilledVisual, bulbCap };
    }

    function buildTubeGridHTML(tubeFilledVisual, theme) {
      const total = HOME_THERMO_CELLS;
      const startFilledPos = total - tubeFilledVisual + 1;

      let html = `<div class="tube-grid">`;
      for (let pos = 1; pos <= total; pos++) {
        const isFilled = (tubeFilledVisual > 0) && (pos >= startFilledPos);
        if (!isFilled) {
          html += `<div class="cell"></div>`;
        } else {
          const rankFromBottom = (total - pos);
          const t = Math.min(1, Math.max(0, rankFromBottom / (total - 1)));
          const color = gradientColor(theme, t);
          html += `<div class="cell" style="background:${color};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    function buildBulbFillStyle(theme) {
      const hue = themeHue(theme);
      // ë²Œë¸ŒëŠ” ì•„ë˜ê°€ ì§„í•˜ê³  ìœ„ê°€ ì—°í•´ì§€ëŠ” ìˆ˜ì§ ê·¸ë¼ë°ì´ì…˜
      return `linear-gradient(180deg, hsl(${hue} 70% 78%) 0%, hsl(${hue} 90% 52%) 55%, hsl(${hue} 95% 42%) 100%)`;
    }

    /* ëˆ„ì  ì˜¨ë„ê³„ ê³µí†µ ë Œë”(í™ˆ/ì°½ì œ ì¬ì‚¬ìš©) */
    async function renderCumulativeThermometers(targetId) {
      const grid = $(targetId);
      if (!grid) return;

      grid.innerHTML = `<div class="small">ëˆ„ì  ì˜¨ë„ê³„ ì§‘ê³„ ì¤‘...</div>`;

      // ì§€ë¶€ë³„ ëˆ„ì  í•©ì‚° + ìµœê·¼ ê¸°ë¡ ëª©ë¡ ë§Œë“¤ê¸°
      const sumByBranch = {};
      const recentByBranch = {};
      branches.forEach(b => { sumByBranch[b] = 0; recentByBranch[b] = []; });

      const [chantSnap, actSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities"))
      ]);

      // chants ëˆ„ì  + ìµœê·¼
      chantSnap.forEach(d => {
        const data = d.data();
        const b = data.branch;
        if (!b || sumByBranch[b] == null) return;

        const min = Number(data.minutes) || 0;
        sumByBranch[b] += min;

        // ìµœê·¼ í‘œì‹œìš©
        if (data.dateKey) {
          recentByBranch[b].push({
            dateKey: data.dateKey,
            type: "chant",
            label: `ğŸŒ± ${min}ë¶„`
          });
        }
      });

      // activities ëˆ„ì (20ë¶„ í™˜ì‚°) + ìµœê·¼
      actSnap.forEach(d => {
        const data = d.data();
        const b = data.branch;
        if (!b || sumByBranch[b] == null) return;

        sumByBranch[b] += 20;
        if (data.dateKey) {
          recentByBranch[b].push({
            dateKey: data.dateKey,
            type: "act",
            label: `ğŸ”¥ í™œë™`
          });
        }
      });

      // ìµœê·¼ ì •ë ¬(ìµœì‹  ë‚ ì§œ ìš°ì„ ) ë° ìƒìœ„ Nê°œë§Œ
      branches.forEach(b => {
        recentByBranch[b].sort((a, c) => (c.dateKey || "").localeCompare(a.dateKey || ""));
        recentByBranch[b] = recentByBranch[b].slice(0, RECENT_PER_BRANCH);
      });

      // ë Œë”
      grid.innerHTML = "";

      THERMO_COLUMNS.forEach((colDef) => {
        const col = document.createElement("div");
        col.className = `thermo-col ${colDef.theme}`;

        colDef.branches.forEach((branch) => {
          const totalMin = sumByBranch[branch] || 0;
          const filledCells = Math.min(HOME_THERMO_CELLS, Math.floor(totalMin / HOME_CELL_UNIT_MIN));
          const capacityMin = HOME_THERMO_CELLS * HOME_CELL_UNIT_MIN;

          const { bulbPct, tubeFilledVisual } = computeBulbAndTubeFill(filledCells);

          const rec = recentByBranch[branch] || [];
          const recHtml = rec.length
            ? rec.map(r => `<div class="recent-item">${escapeHtml(r.dateKey.slice(5))} Â· ${escapeHtml(r.label)}</div>`).join("")
            : `<div class="recent-item">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div>`;

          const card = document.createElement("div");
          card.className = "branch-thermo-card";
          card.onclick = () => goToChantWithBranch(branch);

          card.innerHTML = `
            <div>
              <div class="branch-thermo-title">
                <span>${branch}</span>
                <span class="small">${filledCells}/${HOME_THERMO_CELLS}ì¹¸</span>
              </div>
              <div class="branch-thermo-meta">
                ëˆ„ì : <strong>${totalMin}</strong>ë¶„<br>
                ê¸°ì¤€: 1ì¹¸=${HOME_CELL_UNIT_MIN}ë¶„ (ìµœëŒ€ ${capacityMin}ë¶„)
              </div>
              <div class="recent-list">
                ${recHtml}
              </div>
              <div class="small admin-only" style="margin-top:8px;">
                í´ë¦­ ì‹œ ì°½ì œ íƒ­ìœ¼ë¡œ ì´ë™(ì§€ë¶€ ìë™ ì„ íƒ)
              </div>
            </div>

            <div class="thermo-frame ${colDef.theme}">
              <div class="tube">
                ${buildTubeGridHTML(tubeFilledVisual, colDef.theme)}
              </div>
              <div class="bulb">
                <div class="bulb-fill" style="height:${bulbPct}%; background:${buildBulbFillStyle(colDef.theme)};"></div>
              </div>
            </div>
          `;

          col.appendChild(card);
        });

        grid.appendChild(col);
      });
    }

    /* ===== ì¼ì • íƒ­: ì´ë‹¬ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸ + ë‹¬ë ¥/íšŒí•© ===== */
    async function loadMonthPlans() {
      const container = $("monthPlanList");
      if (!container) return;
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const actSnap = await getDocs(collection(db, "activities"));
      const plans = [];
      actSnap.forEach(d => {
        const data = d.data();
        if (isInThisMonth(data.dateKey)) plans.push(data);
      });

      plans.sort((a, b) => (a.dateKey || "").localeCompare(b.dateKey || ""));

      if (plans.length === 0) {
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ê¸°ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p => {
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">${escapeHtml(p.dateKey || "")} Â· ${escapeHtml(p.branch || "")}</div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${escapeHtml(p.subject || "")}</strong> â†’ ëŒ€ìƒì: <strong>${escapeHtml(p.target || "")}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${escapeHtml(p.method)}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    window.addMeeting = async () => {
      const defaultDate = todayKey;
      const dateKey = prompt("íšŒí•© ë‚ ì§œ (YYYY-MM-DD)", defaultDate);
      if (!dateKey) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) {
        alert("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜: ì˜ˆ) 2026-01-16");
        return;
      }
      const title = prompt("íšŒí•© ì œëª©/ë‚´ìš©", "íšŒí•©");
      if (!title) return;

      await addDoc(collection(db, "meetings"), {
        dateKey,
        title: title.trim(),
        createdAt: serverTimestamp()
      });

      alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadMonthCalendar();
    };

    async function loadMonthCalendar() {
      const cal = $("monthCalendar");
      if (!cal) return;
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const chantMap = {};
      const actMap = {};
      const meetingMap = {};

      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities")),
        getDocs(collection(db, "meetings"))
      ]);

      chantSnap.forEach(d => {
        const { dateKey, minutes } = d.data();
        if (!isInThisMonth(dateKey)) return;
        chantMap[dateKey] = (chantMap[dateKey] || 0) + (Number(minutes) || 0);
      });

      actSnap.forEach(d => {
        const { dateKey } = d.data();
        if (!isInThisMonth(dateKey)) return;
        actMap[dateKey] = (actMap[dateKey] || 0) + 1;
      });

      meetSnap.forEach(d => {
        const { dateKey, title } = d.data();
        if (!isInThisMonth(dateKey)) return;
        if (!meetingMap[dateKey]) meetingMap[dateKey] = [];
        meetingMap[dateKey].push(title || "íšŒí•©");
      });

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      cal.innerHTML = "";

      weekdays.forEach(w => {
        const h = document.createElement("div");
        h.className = "weekday";
        h.textContent = w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay();
      for (let i = 0; i < firstDayWeek; i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.visibility = "hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();
      for (let day = 1; day <= lastDate; day++) {
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        const chantMin = chantMap[dateKey] || 0;
        const actCount = actMap[dateKey] || 0;
        const meetings = meetingMap[dateKey] || [];

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actCount ? `<span class="badge">í™œë™ ${actCount}ê±´</span>` : ``}
          ${meetings.length ? meetings.slice(0,2).map(t=>`<span class="badge meet-badge">íšŒí•© ${escapeHtml(t)}</span>`).join("") : ``}
          ${meetings.length > 2 ? `<div class="small" style="margin-top:4px;">ì™¸ ${meetings.length-2}ê±´</div>` : ``}
        `;
        cal.appendChild(cell);
      }
    }

    /* ===== ìŠ¤ì¿¨ íƒ­ ===== */
    async function loadThermometerForSchoolBranch(branch) {
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";

      if (!branch) {
        wrap.innerHTML = `<div class="small admin-only">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ (ìŠ¤ì¿¨)ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));
      const confirmed = snap.docs.filter(d => d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed / 20) * 100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${branch} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch) {
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));

      const bySlot = new Map();
      snap.forEach(doc => {
        const data = doc.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: doc.ref, ...data });
      });

      for (let slot = 1; slot <= 20; slot++) {
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        if (!confirmed) toggle.classList.add("pending");
        toggle.textContent = confirmed ? "âœ…" : "â–²";  // íšŒìƒ‰ ì±„ì›Œì§„ ì„¸ëª¨

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        toggle.onclick = async () => {
          const newStatus = !(existing?.confirmed === true);

          toggle.textContent = newStatus ? "âœ…" : "â–²";
          toggle.classList.toggle("pending", !newStatus);

          if (existing?.ref) {
            await updateDoc(existing.ref, { confirmed: newStatus, updatedAt: serverTimestamp() });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: newStatus,
              name: (input.value || "").trim(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value || "").trim() };
            bySlot.set(slot, existing);
          }

          await loadThermometerForSchoolBranch(branch);
        };

        input.addEventListener("blur", async () => {
          const newName = (input.value || "").trim();

          if (existing?.ref) {
            await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
            existing.name = newName;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: false,
              name: newName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: false, name: newName };
            bySlot.set(slot, existing);
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);

        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ê´€ë¦¬ì ê¸°ëŠ¥ */
    window.loadAdminStats = async () => {
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches) {
        const [chantSnap, activitySnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db, "chants"), where("branch", "==", b))),
          getDocs(query(collection(db, "activities"), where("branch", "==", b))),
          getDocs(query(collection(db, "school"), where("branch", "==", b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d => d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${escapeHtml(b)}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${activitySnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    window.resetAllData = async () => {
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants", "activities", "school", "meetings"];
      for (const col of cols) {
        const snap = await getDocs(collection(db, col));
        for (const d of snap.docs) {
          await deleteDoc(d.ref);
        }
      }

      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      window.showTab("home");
    };

    async function refreshAll() {
      await loadTodaySummary();

      // í™ˆ/ì°½ì œ: ë™ì¼ ëˆ„ì  ì˜¨ë„ê³„ ë Œë”
      await renderCumulativeThermometers("homeThermoGrid");
      await renderCumulativeThermometers("chantThermoGrid");

      // ì¼ì • íƒ­
      await loadMonthPlans();
      await loadMonthCalendar();

      // ìŠ¤ì¿¨ íƒ­
      const selected = $("schoolBranchSelect").value;
      await loadThermometerForSchoolBranch(selected);
      await loadSchoolGrid(selected);

      setAdminModeUI();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // ê´€ë¦¬ì ëª¨ë“œ UI ì ìš©
      setAdminModeUI();

      if (!nickname) {
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillBranchOptions($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      if (nickname) {
        await refreshAll();
      }

      $("schoolBranchSelect").addEventListener("change", async (e) => {
        const branch = e.target.value;
        await loadThermometerForSchoolBranch(branch);
        await loadSchoolGrid(branch);
      });
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>
    <div class="card">ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong></div>
    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="small admin-only" style="margin-top:6px;">
        ê° ì§€ë¶€ ì˜¨ë„ê³„ë¥¼ í´ë¦­í•˜ë©´ ì°½ì œ íƒ­ìœ¼ë¡œ ì´ë™(ì§€ë¶€ ìë™ ì„ íƒ)í•©ë‹ˆë‹¤.
      </div>
      <div style="height:12px;"></div>
      <div id="homeThermoGrid" class="thermo-grid-wrap"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„</strong>
      <div class="small admin-only" style="margin-top:6px;">
        í™ˆê³¼ ë™ì¼í•œ ëˆ„ì  ì˜¨ë„ê³„ì…ë‹ˆë‹¤. í´ë¦­ ì‹œ ì§€ë¶€ê°€ ìë™ ì„ íƒë©ë‹ˆë‹¤.
      </div>
      <div style="height:12px;"></div>
      <div id="chantThermoGrid" class="thermo-grid-wrap"></div>
    </div>

    <div class="card">
      <div class="row">
        <select id="chantBranch"></select>
        <select id="chantMinutes">
          <option value="">ì‹œê°„ ì„ íƒ</option>
          <option value="10">10ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="60">60ë¶„</option>
        </select>
      </div>
      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
      <div class="small admin-only" style="margin-top:8px;">í•˜ë£¨ 3íšŒ ì œí•œ</div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <select id="activityBranch"></select>
      <div style="height:10px;"></div>
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>
      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>
      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ê¸°ë¡ ğŸ”¥</button>
      <div class="small admin-only" style="margin-top:8px;">í™œë™ 1íšŒ = 20ë¶„ í™˜ì‚° Â· ê¸°ë¡ í›„ ì¼ì • íƒ­ì—ì„œ í™•ì¸</div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
          <div class="small admin-only">ê¸°ë¡ëœ í™œë™ ê³„íšì„ ë‚ ì§œë³„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="small admin-only">ì°½ì œ(ë¶„) Â· í™œë™(ê±´) Â· íšŒí•©(ì¼ì •)</div>
        </div>
        <button class="mini-btn" onclick="addMeeting()">+ íšŒí•©</button>
      </div>
      <div id="monthCalendar" class="month-calendar"></div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="small admin-only" style="margin-top:8px;">
        â–²(ë¯¸í™•ì •) / âœ…(í™•ì •) Â· ì´ë¦„ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì €ì¥
      </div>
    </div>

    <div class="card school-wrap">
      <div id="schoolThermoWrap"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
          <div class="small admin-only">ë³´ì•ˆ ê·œì¹™/ê¶Œí•œ ì„¤ì • ì „ì—ëŠ” ì™¸ë¶€ ë…¸ì¶œì— ì£¼ì˜í•˜ì„¸ìš”.</div>
        </div>
        <button id="adminModeBtn" class="mini-btn" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ: OFF</button>
      </div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
    </div>
  </div>
</body>
</html>
