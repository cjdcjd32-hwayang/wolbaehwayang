<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family: Apple SD Gothic Neo, sans-serif;
      background:url('https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=1920&q=80')
        center/cover fixed no-repeat;
    }
    header{
      background:rgba(255,255,255,.85);
      padding:16px;
      text-align:center;
      font-size:1.4rem;
      font-weight:bold
    }
    nav{
      display:flex;
      justify-content:space-around;
      background:rgba(255,255,255,.9);
      padding:10px;
      gap:6px;
      flex-wrap:wrap;
    }
    nav button{
      border:none;
      background:none;
      font-size:1rem;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
    }
    nav button:hover{ background:rgba(0,0,0,.05); }

    section{display:none;padding:20px}
    section.active{display:block}

    .card{
      background:rgba(255,255,255,.9);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px
    }

    #nicknameLayer{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.6);
      z-index:9999;
    }

    /* ê³µí†µ ì…ë ¥ */
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      background:#fff;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:1rem;
    }
    .btn.secondary{background:#444}
    .small{font-size:.9rem;opacity:.85}

    /* ===== í™ˆ: 3ì—´ ì˜¨ë„ê³„ ë ˆì´ì•„ì›ƒ ===== */
    .home-thermo-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .home-col{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 0;
    }
    .home-thermo-card{
      background:#fff;
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      display:grid;
      grid-template-columns: 1fr 86px; /* ìš°ì¸¡ ì˜¨ë„ê³„ í”„ë ˆì„ ìë¦¬ í™•ë³´ */
      gap: 10px;
      align-items: stretch;
    }
    .home-thermo-title{
      font-weight: 800;
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .home-thermo-meta{
      font-size: .88rem;
      opacity: .86;
      line-height: 1.35;
    }

    /* ===== ì‹¤ì œ ì˜¨ë„ê³„ ëª¨ì–‘ í”„ë ˆì„ ===== */
    .thermo-frame{
      width: 86px;
      height: 240px;
      position: relative;
      display:flex;
      align-items: flex-start;
      justify-content: center;
      box-sizing: border-box;
    }

    /* íŠœë¸Œ */
    .tube{
      width: 58px;
      height: 190px;
      border-radius: 999px;
      background: rgba(255,255,255,.8);
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: inset 0 0 0 6px rgba(0,0,0,.04);
      position: relative;
      z-index: 2;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px;
      box-sizing: border-box;
      overflow:hidden;
    }

    /* ë²Œë¸Œ(ì•„ë˜ ë™ê·¸ë¼ë¯¸) */
    .bulb{
      width: 78px;
      height: 78px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: inset 0 0 0 8px rgba(0,0,0,.04);
      position:absolute;
      bottom: 0;
      z-index: 1;
    }

    /* í”„ë ˆì„ ìƒ‰ìƒ í…Œë§ˆ */
    .theme-blue .tube{ box-shadow: inset 0 0 0 6px rgba(0,128,255,.10); }
    .theme-blue .bulb{ box-shadow: inset 0 0 0 8px rgba(0,128,255,.10); }

    .theme-yellow .tube{ box-shadow: inset 0 0 0 6px rgba(255,193,7,.14); }
    .theme-yellow .bulb{ box-shadow: inset 0 0 0 8px rgba(255,193,7,.14); }

    .theme-pink .tube{ box-shadow: inset 0 0 0 6px rgba(194,24,91,.12); }
    .theme-pink .bulb{ box-shadow: inset 0 0 0 8px rgba(194,24,91,.12); }

    /* ===== 300ì¹¸(20x15) ê²©ì: ì•„ë˜â†’ìœ„ ì±„ì›€ ===== */
    .thermo-grid{
      width: 100%;
      height: 100%;
      display:grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.05);
      border-radius: 12px;
      padding: 2px;
      box-sizing: border-box;
    }
    .cell{
      background: rgba(255,255,255,.55);
      border-radius: 1px;
    }
    .cell.filled{ background:#999; } /* JSì—ì„œ ì¸ë¼ì¸ ìƒ‰ìƒ ë¶€ì—¬ */

    /* ===== ì¼ì • ë‹¬ë ¥(ì´ë‹¬ ì „ìš©) ===== */
    .month-calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday{
      font-size:.78rem;
      font-weight:800;
      text-align:center;
      opacity:.8;
      padding: 4px 0;
    }
    .day-cell{
      background:#fff;
      border-radius:12px;
      padding:8px;
      min-height:72px;
      border:1px solid rgba(0,0,0,.06);
      box-sizing:border-box;
      font-size:.78rem;
      line-height:1.25;
      position:relative;
      overflow:hidden;
    }
    .day-num{
      font-weight:900;
      font-size:.9rem;
      margin-bottom:4px;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      margin:2px 4px 0 0;
      font-size:.74rem;
      white-space:nowrap;
    }
    .meet-badge{
      background:rgba(194,24,91,.10);
    }

    /* ì¼ì • íƒ­: í—¤ë”(ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼) */
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-btn{
      border:none;
      cursor:pointer;
      border-radius:10px;
      padding:8px 10px;
      font-size:.85rem;
      background:#111;
      color:#fff;
      white-space:nowrap;
    }
    .mini-btn:hover{ opacity:.92; }

    /* ì¼ì • íƒ­: í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸ */
    .plan-list{
      display:grid;
      gap:10px;
    }
    .plan-item{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.35;
    }
    .plan-title{
      font-weight:900;
      margin-bottom:4px;
    }
    .plan-meta{
      font-size:.86rem;
      opacity:.88;
    }

    /* ===== ìŠ¤ì¿¨ íƒ­ ===== */
    .school-wrap{display:grid;gap:12px}

    #schoolGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:10px;
    }
    .school-slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      box-sizing:border-box;
      display:grid;
      gap:8px;
    }
    .slot-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .slot-num{
      font-weight:900;
      font-size:.9rem;
      opacity:.8;
    }
    .slot-toggle{
      cursor:pointer;
      user-select:none;
      font-size:1.15rem;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(0,0,0,.05);
    }
    .slot-toggle:hover{ background:rgba(0,0,0,.08); }
    .slot-input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      font-size:.92rem;
    }

    /* ìŠ¤ì¿¨ ì§„í–‰ë¥  ë°” */
    .school-thermo{
      background:#eee;
      border-radius:14px;
      padding:12px;
    }
    .thermo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-weight:700;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ffb3c7 0%, #ff6aa2 40%, #c2185b 100%);
      transition: width .35s ease;
    }
  </style>

  <!-- Firebase SDK (v9 module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      serverTimestamp, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBau9yukCvYTsahSkjy0JndEk4Docmue1I",
      authDomain: "wolbaehwayang-d1787.firebaseapp.com",
      projectId: "wolbaehwayang-d1787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ê³µí†µ */
    const branches = ["ë‹¬ë¹„","ìƒì¸","ì›ë•","ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ","ì˜ë‚¨","ì˜¥í¬","í™”ì›"];
    const today = new Date();
    const todayKey = today.toISOString().slice(0,10);
    const nicknameKey = "wolbaehwayang_nickname";
    let nickname = localStorage.getItem(nicknameKey) || "";

    /* í™ˆ ì˜¨ë„ê³„ ì„¤ì • */
    const HOME_THERMO_CELLS = 300;   // 300ì¹¸
    const HOME_CELL_UNIT_MIN = 10;   // 1ì¹¸=10ë¶„(ê¸°ë³¸)

    /* í™ˆ 3ì—´ ë°°ì¹˜(ìš”ì²­í•˜ì‹  ìˆœì„œ/êµ¬ì„± ê³ ì •) */
    const HOME_COLUMNS = [
      { theme: "theme-blue",  branches: ["ë‹¬ë¹„","ìƒì¸","ì›ë•"] },
      { theme: "theme-yellow",branches: ["ëŒ€ê³¡","ì›”ë°°","ìœ ì²œ","ì§„ì²œ"] },
      { theme: "theme-pink",  branches: ["ì˜ë‚¨","ì˜¥í¬","í™”ì›"] }
    ];

    /* ì¼ì •(ì´ë‹¬) */
    const monthYear = today.getFullYear();
    const monthIndex = today.getMonth(); // 0~11
    const monthStart = new Date(monthYear, monthIndex, 1);
    const monthEnd = new Date(monthYear, monthIndex + 1, 0);
    const monthKeyPrefix = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-`; // YYYY-MM-

    /* DOM í—¬í¼ */
    const $ = (id) => document.getElementById(id);

    function fillBranchOptions(selectEl, placeholder="ì§€ë¶€ ì„ íƒ") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        selectEl.appendChild(opt);
      });
    }

    /* íƒ­ ì „í™˜: ì „ì—­ */
    window.showTab = (id) => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if (el) el.classList.add("active");
    };

    /* ë‹‰ë„¤ì„ ì €ì¥: ì „ì—­ */
    window.saveNickname = () => {
      const n = $("nicknameInput").value.trim();
      if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
      localStorage.setItem(nicknameKey, n);
      location.reload();
    };

    /* ì°½ì œ ê¸°ë¡ (1ì¼ 3íšŒ ì œí•œ) */
    window.saveChant = async () => {
      const minutes = Number($("chantMinutes").value);
      const branch = $("chantBranch").value;
      if (!minutes || !branch) return alert("ì§€ë¶€/ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const q = query(
        collection(db, "chants"),
        where("nickname", "==", nickname),
        where("dateKey", "==", todayKey)
      );
      const snap = await getDocs(q);
      if (snap.size >= 3) return alert("í•˜ë£¨ 3íšŒ ì œí•œì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "chants"), {
        nickname,
        branch,
        minutes,
        blocks: minutes / 10,
        dateKey: todayKey,
        createdAt: serverTimestamp(),
        isArchived: false
      });

      alert("ì°½ì œ ê¸°ë¡ ì™„ë£Œ ğŸŒ±");
      await refreshAll();
      window.showTab("home");
    };

    /* í™œë™ ê¸°ë¡ (1íšŒ = 20ë¶„ í™˜ì‚°) */
    window.saveActivity = async () => {
      const branch = $("activityBranch").value;
      const subject = $("activitySubject").value.trim();
      const target = $("activityTarget").value.trim();
      const method = $("activityMethod").value.trim();

      if (!branch || !subject || !target) return alert("ì§€ë¶€/ì£¼ì²´ì/ëŒ€ìƒìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      await addDoc(collection(db, "activities"), {
        branch, subject, target, method,
        blocks: 2,
        dateKey: todayKey,
        createdAt: serverTimestamp()
      });

      alert("í™œë™ ê¸°ë¡ ì™„ë£Œ ğŸ”¥");
      await refreshAll();
      window.showTab("schedule"); // UX: í™œë™ ê¸°ë¡ í›„ ì¼ì •ìœ¼ë¡œ ì´ë™(ê³„íš í™•ì¸)
    };

    /* ===== í™ˆ: ì˜¤ëŠ˜ í•©ê³„ + ìƒì„¸ ===== */
    async function loadTodaySummary() {
      const chantSnap = await getDocs(query(collection(db, "chants"), where("dateKey", "==", todayKey)));
      const activitySnap = await getDocs(query(collection(db, "activities"), where("dateKey", "==", todayKey)));

      let total = 0;
      let detail = "";

      chantSnap.forEach(d => {
        const { nickname: n, branch, minutes } = d.data();
        total += Number(minutes) || 0;
        detail += `ğŸŒ± ${branch} - ${minutes}ë¶„ (${n})<br>`;
      });

      activitySnap.forEach(d => {
        const { branch, subject, target } = d.data();
        total += 20;
        detail += `ğŸ”¥ ${branch} - ${subject} â†’ ${target} (20ë¶„)<br>`;
      });

      $("todayTotal").innerHTML = `${total}ë¶„`;
      $("todayDetail").innerHTML = detail || "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    }

    /* ===== í™ˆ: ëˆ„ì  ì§€ë¶€ë³„ ì˜¨ë„ê³„(300ì¹¸, ì•„ë˜â†’ìœ„) ===== */
    function gradientColor(theme, t) {
      // t=0(ì•„ë˜/ì§„) -> t=1(ìœ„/ì—°)
      // í…Œë§ˆë³„ ìƒ‰ìƒ ê³„ì—´ ì§€ì •
      // Blue: 210~200, Yellow: 45~50, Pink: 330
      let hue = 330;
      if (theme === "theme-blue") hue = 210;
      if (theme === "theme-yellow") hue = 48;

      // ì•„ë˜ëŠ” ë” ì§„í•˜ê²Œ: ì±„ë„ ë†’ê³  ëª…ë„ ë‚®ê²Œ
      const sat = 92 - Math.round(t * 28);    // 92 -> 64
      const light = 42 + Math.round(t * 34);  // 42 -> 76
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    function buildThermoGridHTML(filledCells, theme) {
      const total = HOME_THERMO_CELLS; // 300
      const startFilledPos = total - filledCells + 1;

      let html = `<div class="thermo-grid">`;
      for (let pos = 1; pos <= total; pos++) {
        const isFilled = (filledCells > 0) && (pos >= startFilledPos);
        if (!isFilled) {
          html += `<div class="cell"></div>`;
        } else {
          // ì•„ë˜ìª½(ì§„) -> ìœ„ìª½(ì—°): posê°€ í´ìˆ˜ë¡ ì•„ë˜ìª½
          const rankFromBottom = (total - pos); // ì•„ë˜ìª½ì¼ìˆ˜ë¡ 0
          const t = Math.min(1, Math.max(0, rankFromBottom / (total - 1)));
          const color = gradientColor(theme, t);
          html += `<div class="cell filled" style="background:${color};"></div>`;
        }
      }
      html += `</div>`;
      return html;
    }

    async function loadHomeThermometersCumulative() {
      const grid = $("homeThermoGrid");
      if (!grid) return;
      grid.innerHTML = `<div class="small">ëˆ„ì  ì˜¨ë„ê³„ ì§‘ê³„ ì¤‘...</div>`;

      const sumByBranch = {};
      branches.forEach(b => sumByBranch[b] = 0);

      const [chantSnap, actSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities"))
      ]);

      chantSnap.forEach(d => {
        const { branch, minutes } = d.data();
        if (branch && sumByBranch[branch] != null) sumByBranch[branch] += (Number(minutes) || 0);
      });

      actSnap.forEach(d => {
        const { branch } = d.data();
        if (branch && sumByBranch[branch] != null) sumByBranch[branch] += 20;
      });

      grid.innerHTML = "";

      HOME_COLUMNS.forEach((colDef) => {
        const col = document.createElement("div");
        col.className = `home-col ${colDef.theme}`;

        colDef.branches.forEach((branch) => {
          const totalMin = sumByBranch[branch] || 0;
          const filledCells = Math.min(HOME_THERMO_CELLS, Math.floor(totalMin / HOME_CELL_UNIT_MIN));
          const capacityMin = HOME_THERMO_CELLS * HOME_CELL_UNIT_MIN;

          const card = document.createElement("div");
          card.className = "home-thermo-card";
          card.innerHTML = `
            <div>
              <div class="home-thermo-title">
                <span>${branch}</span>
                <span class="small">${filledCells}/${HOME_THERMO_CELLS}ì¹¸</span>
              </div>
              <div class="home-thermo-meta">
                ëˆ„ì : <strong>${totalMin}</strong>ë¶„<br>
                ê¸°ì¤€: 1ì¹¸=${HOME_CELL_UNIT_MIN}ë¶„ (ìµœëŒ€ ${capacityMin}ë¶„)
              </div>
            </div>

            <div class="thermo-frame ${colDef.theme}">
              <div class="tube">
                ${buildThermoGridHTML(filledCells, colDef.theme)}
              </div>
              <div class="bulb"></div>
            </div>
          `;
          col.appendChild(card);
        });

        grid.appendChild(col);
      });
    }

    /* ===== ì¼ì • íƒ­: í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸(ì´ë‹¬) + ì´ë‹¬ ë‹¬ë ¥ ===== */

    function isInThisMonth(dateKey) {
      // YYYY-MM-DD
      return typeof dateKey === "string" && dateKey.startsWith(monthKeyPrefix);
    }

    async function loadMonthPlans() {
      const container = $("monthPlanList");
      if (!container) return;
      container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      // ì¸ë±ìŠ¤/ì •ë ¬ ìš”êµ¬ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì „ì²´ ì¡°íšŒ í›„ ì´ë‹¬ í•„í„°(ê·œëª¨ê°€ ì»¤ì§€ë©´ ì„œë²„ ì§‘ê³„ ê¶Œì¥)
      const actSnap = await getDocs(collection(db, "activities"));

      const plans = [];
      actSnap.forEach(d => {
        const data = d.data();
        if (isInThisMonth(data.dateKey)) plans.push(data);
      });

      // JS ì •ë ¬: dateKey ì˜¤ë¦„ì°¨ìˆœ, createdAt ìˆìœ¼ë©´ ë³´ì¡° ì •ë ¬
      plans.sort((a, b) => {
        if ((a.dateKey || "") < (b.dateKey || "")) return -1;
        if ((a.dateKey || "") > (b.dateKey || "")) return 1;
        return 0;
      });

      if (plans.length === 0) {
        container.innerHTML = `<div class="small">ì´ë‹¬ì— ê¸°ë¡ëœ í™œë™ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = "";
      plans.forEach(p => {
        const div = document.createElement("div");
        div.className = "plan-item";
        div.innerHTML = `
          <div class="plan-title">${p.dateKey || ""} Â· ${p.branch || ""}</div>
          <div class="plan-meta">ì£¼ì²´ì: <strong>${p.subject || ""}</strong> â†’ ëŒ€ìƒì: <strong>${p.target || ""}</strong></div>
          ${p.method ? `<div class="plan-meta">ë°©ë²•: ${p.method}</div>` : ``}
        `;
        container.appendChild(div);
      });
    }

    // íšŒí•© ì¼ì • ì¶”ê°€(ë‹¬ë ¥ ìš°ì¸¡ ìƒë‹¨ + ë²„íŠ¼)
    window.addMeeting = async () => {
      const defaultDate = todayKey;
      const dateKey = prompt("íšŒí•© ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD)", defaultDate);
      if (!dateKey) return;

      // ê°„ë‹¨í•œ í˜•ì‹ ì²´í¬
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) {
        alert("ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 2026-01-16");
        return;
      }

      const title = prompt("íšŒí•© ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", "íšŒí•©");
      if (!title) return;

      await addDoc(collection(db, "meetings"), {
        dateKey,
        title: title.trim(),
        createdAt: serverTimestamp()
      });

      alert("íšŒí•© ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadMonthCalendar(); // ë‹¬ë ¥ ê°±ì‹ 
    };

    async function loadMonthCalendar() {
      const cal = $("monthCalendar");
      if (!cal) return;
      cal.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      // ì´ë‹¬ ë°ì´í„° ë§µ êµ¬ì„±
      const chantMap = {}; // dateKey -> minutes
      const actMap = {};   // dateKey -> count
      const meetingMap = {}; // dateKey -> [titles...]

      // ê·œëª¨ê°€ ì»¤ì§€ë©´ where(dateKey startsWith) ê°™ì€ ì„œë²„ ì „ì²˜ë¦¬ í•„ìš”.
      // í˜„ì¬ëŠ” ì „ì²´ ì¡°íšŒ í›„ ì´ë‹¬ í•„í„°.
      const [chantSnap, actSnap, meetSnap] = await Promise.all([
        getDocs(collection(db, "chants")),
        getDocs(collection(db, "activities")),
        getDocs(collection(db, "meetings"))
      ]);

      chantSnap.forEach(d => {
        const { dateKey, minutes } = d.data();
        if (!isInThisMonth(dateKey)) return;
        chantMap[dateKey] = (chantMap[dateKey] || 0) + (Number(minutes) || 0);
      });

      actSnap.forEach(d => {
        const { dateKey } = d.data();
        if (!isInThisMonth(dateKey)) return;
        actMap[dateKey] = (actMap[dateKey] || 0) + 1;
      });

      meetSnap.forEach(d => {
        const { dateKey, title } = d.data();
        if (!isInThisMonth(dateKey)) return;
        if (!meetingMap[dateKey]) meetingMap[dateKey] = [];
        meetingMap[dateKey].push(title || "íšŒí•©");
      });

      // ë‹¬ë ¥ ë Œë”(ìš”ì¼ í—¤ë” + ê³µë°± + ë‚ ì§œ)
      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      cal.innerHTML = "";

      weekdays.forEach(w => {
        const h = document.createElement("div");
        h.className = "weekday";
        h.textContent = w;
        cal.appendChild(h);
      });

      const firstDayWeek = monthStart.getDay(); // 0=ì¼
      for (let i = 0; i < firstDayWeek; i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.visibility = "hidden";
        cal.appendChild(blank);
      }

      const lastDate = monthEnd.getDate();
      for (let day = 1; day <= lastDate; day++) {
        const dateKey = `${monthYear}-${String(monthIndex+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        const chantMin = chantMap[dateKey] || 0;
        const actCount = actMap[dateKey] || 0;
        const meetings = meetingMap[dateKey] || [];

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `
          <div class="day-num">${day}</div>
          ${chantMin ? `<span class="badge">ì°½ì œ ${chantMin}ë¶„</span>` : ``}
          ${actCount ? `<span class="badge">í™œë™ ${actCount}ê±´</span>` : ``}
          ${meetings.length ? meetings.slice(0,2).map(t=>`<span class="badge meet-badge">íšŒí•© ${escapeHtml(t)}</span>`).join("") : ``}
          ${meetings.length > 2 ? `<div class="small" style="margin-top:4px;">ì™¸ ${meetings.length-2}ê±´</div>` : ``}
        `;
        cal.appendChild(cell);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ===== ìŠ¤ì¿¨ íƒ­: ì§€ë¶€ ì„ íƒ ì§„í–‰ë¥  + 20ì¹¸(ì´ë¦„ ì…ë ¥ í¬í•¨) ===== */
    async function loadThermometerForBranch(branch) {
      const wrap = $("schoolThermoWrap");
      wrap.innerHTML = "";

      if (!branch) {
        wrap.innerHTML = `<div class="small">ì§€ë¶€ë¥¼ ì„ íƒí•˜ë©´ ì§„í–‰ë¥ (ìŠ¤ì¿¨)ê³¼ 20ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));
      const confirmed = snap.docs.filter(d => d.data().confirmed === true).length;
      const percent = Math.min(100, Math.round((confirmed / 20) * 100));

      const thermo = document.createElement("div");
      thermo.className = "school-thermo";
      thermo.innerHTML = `
        <div class="thermo-header">
          <div>${branch} ì§„í–‰ë¥ </div>
          <div>${confirmed}/20 (${percent}%)</div>
        </div>
        <div class="thermo-track">
          <div class="thermo-fill" style="width:${percent}%;"></div>
        </div>
      `;
      wrap.appendChild(thermo);
    }

    async function loadSchoolGrid(branch) {
      const grid = $("schoolGrid");
      grid.innerHTML = "";
      if (!branch) return;

      const snap = await getDocs(query(collection(db, "school"), where("branch", "==", branch)));

      const bySlot = new Map();
      snap.forEach(doc => {
        const data = doc.data();
        if (typeof data.slot === "number") bySlot.set(data.slot, { ref: doc.ref, ...data });
      });

      for (let slot = 1; slot <= 20; slot++) {
        let existing = bySlot.get(slot) || null;
        const confirmed = existing?.confirmed === true;
        const name = existing?.name || "";

        const card = document.createElement("div");
        card.className = "school-slot";

        const top = document.createElement("div");
        top.className = "slot-top";

        const num = document.createElement("div");
        num.className = "slot-num";
        num.textContent = `${slot}ë²ˆ`;

        const toggle = document.createElement("div");
        toggle.className = "slot-toggle";
        toggle.textContent = confirmed ? "âœ…" : "â–³";

        const input = document.createElement("input");
        input.className = "slot-input";
        input.placeholder = "ëŒ€ìƒì ì´ë¦„ ì…ë ¥";
        input.value = name;

        // ìƒíƒœ í† ê¸€(ì•„ì´ì½˜ í´ë¦­)
        toggle.onclick = async () => {
          const newStatus = !(existing?.confirmed === true);
          toggle.textContent = newStatus ? "âœ…" : "â–³";

          // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±(ì´ë¦„ í¬í•¨)
          if (existing?.ref) {
            await updateDoc(existing.ref, {
              confirmed: newStatus,
              updatedAt: serverTimestamp()
            });
            existing.confirmed = newStatus;
          } else {
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: newStatus,
              name: (input.value || "").trim(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: newStatus, name: (input.value || "").trim() };
            bySlot.set(slot, existing);
          }

          await loadThermometerForBranch(branch);
        };

        // ì´ë¦„ ì €ì¥(blur ì‹œ ì €ì¥)
        input.addEventListener("blur", async () => {
          const newName = (input.value || "").trim();

          if (existing?.ref) {
            await updateDoc(existing.ref, { name: newName, updatedAt: serverTimestamp() });
            existing.name = newName;
          } else {
            // ì´ë¦„ë§Œ ë¨¼ì € ì €ì¥í•´ë„ ë¬¸ì„œë¥¼ ë§Œë“¤ì–´ ë‘ (ìƒíƒœëŠ” ê¸°ë³¸ â–³)
            const newRef = await addDoc(collection(db, "school"), {
              branch,
              slot,
              confirmed: false,
              name: newName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            existing = { ref: newRef, branch, slot, confirmed: false, name: newName };
            bySlot.set(slot, existing);
          }
        });

        top.appendChild(num);
        top.appendChild(toggle);

        card.appendChild(top);
        card.appendChild(input);
        grid.appendChild(card);
      }
    }

    /* ê´€ë¦¬ì: í†µê³„ */
    window.loadAdminStats = async () => {
      const statsDiv = $("adminStats");
      statsDiv.innerHTML = "ì§‘ê³„ ì¤‘...";

      let html = "";
      for (const b of branches) {
        const [chantSnap, activitySnap, schoolSnap] = await Promise.all([
          getDocs(query(collection(db, "chants"), where("branch", "==", b))),
          getDocs(query(collection(db, "activities"), where("branch", "==", b))),
          getDocs(query(collection(db, "school"), where("branch", "==", b)))
        ]);
        const confirmed = schoolSnap.docs.filter(d => d.data().confirmed === true).length;

        html += `<div class="card" style="margin-bottom:10px;">
          <strong>${b}</strong><br>
          <span class="small">ì°½ì œ ${chantSnap.size}íšŒ Â· í™œë™ ${activitySnap.size}íšŒ Â· ìŠ¤ì¿¨ âœ… ${confirmed}/20</span>
        </div>`;
      }
      statsDiv.innerHTML = html;
    };

    /* ê´€ë¦¬ì: ì „ì²´ ë¦¬ì…‹ */
    window.resetAllData = async () => {
      if (!confirm("ëª¨ë“  ê¸°ë¡(ì°½ì œ/í™œë™/ìŠ¤ì¿¨/íšŒí•©)ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;

      const cols = ["chants", "activities", "school", "meetings"];
      for (const col of cols) {
        const snap = await getDocs(collection(db, col));
        for (const d of snap.docs) {
          await deleteDoc(d.ref);
        }
      }

      alert("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
      await refreshAll();
      window.showTab("home");
    };

    async function refreshAll() {
      await loadTodaySummary();
      await loadHomeThermometersCumulative();

      // ì¼ì • íƒ­ ë°ì´í„°
      await loadMonthPlans();
      await loadMonthCalendar();

      // ìŠ¤ì¿¨ íƒ­
      const selected = $("schoolBranchSelect").value;
      await loadThermometerForBranch(selected);
      await loadSchoolGrid(selected);
    }

    /* ì´ˆê¸° DOM ì„¸íŒ… */
    document.addEventListener("DOMContentLoaded", async () => {
      if (!nickname) {
        $("nicknameLayer").style.display = "flex";
      } else {
        $("currentNickname").textContent = nickname;
        $("nicknameLayer").style.display = "none";
      }

      fillBranchOptions($("chantBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("activityBranch"), "ì§€ë¶€ ì„ íƒ");
      fillBranchOptions($("schoolBranchSelect"), "ì§€ë¶€ ì„ íƒ");

      if (nickname) {
        await refreshAll();
      }

      $("schoolBranchSelect").addEventListener("change", async (e) => {
        const branch = e.target.value;
        await loadThermometerForBranch(branch);
        await loadSchoolGrid(branch);
      });
    });
  </script>
</head>

<body>
  <header>ğŸŒ¸ ì›”ë°°ê¶Œ ë³´ì€ì˜ ì—¬ìë¶€ ğŸŒ¸</header>

  <nav>
    <button onclick="showTab('home')">ğŸŒ¸ í™ˆ</button>
    <button onclick="showTab('chant')">ğŸŒ± ì°½ì œ</button>
    <button onclick="showTab('activity')">ğŸ”¥ í™œë™</button>
    <button onclick="showTab('schedule')">ğŸ“… ì¼ì •</button>
    <button onclick="showTab('school')">ğŸ“ ìŠ¤ì¿¨</button>
    <button onclick="showTab('admin')">ğŸ” ê´€ë¦¬ì</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">í˜„ì¬ ë‹‰ë„¤ì„: <strong id="currentNickname"></strong></div>
    <div class="card">ì˜¤ëŠ˜ í•©ê³„(ì°½ì œ+í™œë™ í™˜ì‚°): <strong id="todayTotal">0ë¶„</strong></div>
    <div class="card"><strong>ì˜¤ëŠ˜ ê¸°ë¡ ìƒì„¸</strong><br><div id="todayDetail"></div></div>

    <div class="card">
      <strong>ì§€ë¶€ë³„ ëˆ„ì  ì˜¨ë„ê³„ (300ì¹¸ Â· ì•„ë˜â†’ìœ„ Â· 3ì—´ ìƒ‰ìƒ)</strong>
      <div class="small" style="margin-top:6px;">
        1ì—´(íŒŒë‘): ë‹¬ë¹„/ìƒì¸/ì›ë• Â· 2ì—´(ë…¸ë‘): ëŒ€ê³¡/ì›”ë°°/ìœ ì²œ/ì§„ì²œ Â· 3ì—´(ë¶„í™): ì˜ë‚¨/ì˜¥í¬/í™”ì›
      </div>
      <div style="height:12px;"></div>
      <div id="homeThermoGrid" class="home-thermo-grid"></div>
    </div>
  </section>

  <!-- CHANT -->
  <section id="chant">
    <div class="card">
      <div class="row">
        <select id="chantBranch"></select>
        <select id="chantMinutes">
          <option value="">ì‹œê°„ ì„ íƒ</option>
          <option value="10">10ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="60">60ë¶„</option>
        </select>
      </div>
      <div style="height:10px;"></div>
      <button class="btn" onclick="saveChant()">ì°½ì œ ê¸°ë¡</button>
      <div class="small" style="margin-top:8px;">í•˜ë£¨ 3íšŒ ì œí•œ</div>
    </div>
  </section>

  <!-- ACTIVITY -->
  <section id="activity">
    <div class="card">
      <select id="activityBranch"></select>
      <div style="height:10px;"></div>
      <input id="activitySubject" placeholder="ì£¼ì²´ì" />
      <div style="height:10px;"></div>
      <input id="activityTarget" placeholder="ëŒ€ìƒì" />
      <div style="height:10px;"></div>
      <input id="activityMethod" placeholder="í™œë™ ë°©ë²• (ì„ íƒ)" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveActivity()">í™œë™ ê³„íš ê¸°ë¡ ğŸ”¥</button>
      <div class="small" style="margin-top:8px;">í™œë™ 1íšŒ = 20ë¶„ í™˜ì‚° Â· ê¸°ë¡ í›„ ì¼ì • íƒ­ì—ì„œ í™•ì¸</div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <!-- ìƒë‹¨: í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸ -->
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ í™œë™ ê³„íš ë¦¬ìŠ¤íŠ¸</strong>
          <div class="small">ê¸°ë¡ëœ í™œë™ ê³„íšì„ ë‚ ì§œë³„ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="monthPlanList" class="plan-list"></div>
    </div>

    <!-- í•˜ë‹¨: ì´ë‹¬ ë‹¬ë ¥ + íšŒí•© ì¶”ê°€ ë²„íŠ¼ -->
    <div class="card">
      <div class="card-header">
        <div>
          <strong>ì´ë‹¬ì˜ ë‹¬ë ¥</strong>
          <div class="small">ì°½ì œ(ë¶„) Â· í™œë™(ê±´) Â· íšŒí•©(ì¼ì •)</div>
        </div>
        <button class="mini-btn" onclick="addMeeting()">+ íšŒí•©</button>
      </div>
      <div id="monthCalendar" class="month-calendar"></div>
    </div>
  </section>

  <!-- SCHOOL -->
  <section id="school">
    <div class="card">
      <strong>ìŠ¤ì¿¨ (ì§€ë¶€ë³„ 20ì¹¸ Â· â–³/âœ… Â· ëŒ€ìƒì ì´ë¦„ ì…ë ¥)</strong>
      <div style="height:10px;"></div>
      <select id="schoolBranchSelect"></select>
      <div class="small" style="margin-top:8px;">ì•„ì´ì½˜ í´ë¦­: â–³/âœ… í† ê¸€ Â· ì´ë¦„ ì…ë ¥ í›„ í™”ë©´ ë°– í´ë¦­(blur) ì‹œ ì €ì¥</div>
    </div>

    <div class="card school-wrap">
      <div id="schoolThermoWrap"></div>
      <div id="schoolGrid"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <strong>ê´€ë¦¬ì íŒ¨ë„</strong>
      <div class="small" style="margin-top:6px;">ë³´ì•ˆ ê·œì¹™/ê¶Œí•œ ì„¤ì • ì „ì—ëŠ” ì™¸ë¶€ ë…¸ì¶œì— ì£¼ì˜í•˜ì„¸ìš”.</div>
      <div style="height:12px;"></div>

      <div class="row">
        <button class="btn secondary" onclick="loadAdminStats()">ğŸ“Š í†µê³„ ê°±ì‹ </button>
        <button class="btn" onclick="resetAllData()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
      </div>

      <div style="height:12px;"></div>
      <div id="adminStats"></div>
    </div>
  </section>

  <!-- NICKNAME -->
  <div id="nicknameLayer">
    <div class="card" style="max-width:360px;width:92%;">
      <h3 style="margin:0 0 10px 0;">ë‹‰ë„¤ì„ ì…ë ¥</h3>
      <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„" />
      <div style="height:12px;"></div>
      <button class="btn" onclick="saveNickname()">ì…ì¥</button>
    </div>
  </div>
</body>
</html>
